<!DOCTYPE html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" manifest="passlok.appcache">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>PassLok privacy</title>

    <meta name="Keywords" content="passlok, URSA, browser, encryption, decryption, symmetric, public key, signature, AES, ECDH, Diffie, Hellman, elliptic curve, advanced, javascript, PGP, PRISM">
    <meta name="Description" content="PassLok privacy">
    <meta name="author" content="F. Ruiz">
    <meta name="robots" content="index">
    <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1, user-scalable=no">

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<link rel="apple-touch-icon" href="passlok-touch-icon.png">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

<!--CSS styles go here-->
<style type="text/css">
		html {
	    -webkit-text-size-adjust: 100%;
		}
	    body {
		font-family: Sans-Serif;
		margin-left: 1%;
		margin-right: 1%;
		background-color: #FFFFFF;
		color: #000000;
		overflow: auto;
	    }
		.black_overlay{
			display: none;
			position: absolute;
			top: 0%;
			left: 0%;
			width: 100%;
			height: 100%;
			background-color: black;
			z-index:1001;
			-moz-opacity: 0.5;
			opacity:.50;
			filter: alpha(opacity=50);
		}
		.white_content {
			display: none;
			position: absolute;
			top: 15%;
			left: 10%;
			width: 80%;
			height: 70%;
			padding: 0px;
			border: 0px solid gray;
			background-color: white;
			z-index:1002;
			overflow: auto;
		}
		.block_page {
			display: none;
			position: absolute;
			top: 0%;
			left: 0%;
			width: 100%;
			height: 100%;
			padding: 0px;
			border: 0px solid gray;
			background-color: white;
			z-index:1002;
			overflow: auto;
		}
		input[type=checkbox]{
  		/* Larger checkboxes */
  			-ms-transform: scale(1.7); /* IE */
 			-moz-transform: scale(1.7); /* FF */
  			-webkit-transform: scale(1.7); /* Safari and Chrome */
  			-o-transform: scale(1.7); /* Opera */
  			padding: 0px;
			border:1px solid #dedede;
		}
		input[type=radio]{
  		/* Larger radio buttons */
  			-ms-transform: scale(1.7); /* IE */
 			-moz-transform: scale(1.7); /* FF */
  			-webkit-transform: scale(1.7); /* Safari and Chrome */
  			-o-transform: scale(1.7); /* Opera */
  			padding: 0px;
			border:1px solid #dedede;
		}
.cssbutton {
	-webkit-border-radius: 0;
  	-moz-border-radius: 0;
  	border-radius: 0;
  	font-family: Arial;
	font-size:18px;
  	color: #666666;
  	padding: 12px;
  	background: #e6e6e6;
  	text-decoration: none;
	border:0px;
	margin-right: -2px;
}
.cssbutton:hover {
	background: #efefef;
	text-decoration: none;
}
.cssbox {
	-webkit-border-radius: 0;
  	-moz-border-radius: 0;
  	border-radius: 0;
	font-size:18px;
  	color: #666666;
  	padding: 15px;
  	background: #ffffee;
  	text-decoration: none;
	border:1px solid #dedede;
	width: 100%;
	-webkit-appearance: none;
    box-sizing: border-box;
    -webkit-box-sizing:border-box;
    -moz-box-sizing: border-box;
	-webkit-box-shadow: none;
	-moz-box-shadow: none;
	box-shadow: none;
}
ul#tabs { margin: 0; text-align: center; padding: 11px; width: 100%; background-color: #c6d5c6; position: fixed; top: 0px; left: 0px; z-index:1 }
ul#tabs li { display: inline; width: auto; }
ul#tabs li a { font-size:18px; color: #42454a; background-color: #c6d5c6; border: none; ;text-decoration: none; padding: 10px;margin-left: -2px;}
ul#tabs li a:hover { background-color: #d7e6d7; }
ul#tabs li a.selected { color: #000; background-color: #ffffff; font-weight: bold; padding: 12px; border: none;}
div.tabContent { border: none; background-color: #ffffff; }
div.tabContent.hide { display: none; }

.custom-file-input{
	color: #ffffff;
}
.custom-file-input::-webkit-file-upload-button {
  visibility: hidden;
}
.custom-file-input::before {
  content: 'Select a file';
  display: inline-block;
  background: #e6e6e6;
	-webkit-border-radius: 0;
  	-moz-border-radius: 0;
  	border-radius: 0;
  	font-family: Arial;
	font-size:18px;
  	color: #666666;
  	padding: 12px;
  	background: #e6e6e6;
	border:0px;
  outline: none;
  white-space: nowrap;
  -webkit-user-select: none;
  cursor: pointer;
  text-decoration: none;
}
.custom-file-input:hover::before {
  background: #efefef;
}
.custom-file-input:active::before {
  background: #efefef;
}
select {
    -webkit-appearance: button;
    -moz-appearance: button;
    -webkit-user-select: none;
    -moz-user-select: none;
    border:1px solid #dedede;
    font-size: 18px;
	color: #666666;
	width: 30%;
	background: #ffffee;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
	</style>

<!--License notice and SSL force-->
<script>
        /*
		@source: https://passlok.com/index.html

        @licstart  The following is the entire license notice for the
        JavaScript code in this page.

        Copyright (C) 2014  Francisco Ruiz

        The JavaScript code in this page is free software: you can
        redistribute it and/or modify it under the terms of the GNU
        General Public License (GNU GPL) as published by the Free Software
        Foundation, either version 3 of the License, or (at your option)
        any later version.  The code is distributed WITHOUT ANY WARRANTY;
        without even the implied warranty of MERCHANTABILITY or FITNESS
        FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

        As additional permission under GNU GPL version 3 section 7, you
        may distribute non-source (e.g., minimized or compacted) forms of
        that code without the copy of the GNU GPL normally required by
        section 4, provided you include this license notice and a URL
        through which recipients can access the Corresponding Source.


        @licend  The above is the entire license notice
        for the JavaScript code in this page.
        */

    if (window.location.protocol == "http:") {				//force SSL/TLS

        var restOfUrl = window.location.href.substr(5);
        window.location = "https:" + restOfUrl;
    }
</script>

<!--Libraries merged into program:
SSSS-->
<script>
// secrets.js - by Alexander Stetsyuk - released under MIT License
//substantial edits by F. Ruiz: since RNG used is from SJCL, RNG check is left to SJCL: RNG checking code removed from here.

(function(exports, global){
var defaults = {
	bits: 8, // default number of bits
	radix: 16, // work with HEX by default
	minBits: 3,
	maxBits: 20, // this permits 1,048,575 shares, though going this high is NOT recommended in JS!

	bytesPerChar: 2,
	maxBytesPerChar: 6, // Math.pow(256,7) > Math.pow(2,53)

	// Primitive polynomials (in decimal form) for Galois Fields GF(2^n), for 2 <= n <= 30
	// The index of each term in the array corresponds to the n for that polynomial
	// i.e. to get the polynomial for n=16, use primitivePolynomials[16]
	primitivePolynomials: [null,null,1,3,3,5,3,3,29,17,9,5,83,27,43,3,45,9,39,39,9,5,3,33,27,9,71,39,9,5,83],

	// warning for insecure PRNG
	warning: 'WARNING:\nA secure random number generator was not found.\nUsing Math.random(), which is NOT cryptographically strong!'
};

// Protected settings object
var config = {};

function init(bits){
	if(bits && (typeof bits !== 'number' || bits%1 !== 0 || bits<defaults.minBits || bits>defaults.maxBits)){
		throw new Error('Number of bits must be an integer between ' + defaults.minBits + ' and ' + defaults.maxBits + ', inclusive.')
	}
	config.radix = defaults.radix;
	config.bits = bits || defaults.bits;
	config.size = Math.pow(2, config.bits);
	config.max = config.size - 1;

	// Construct the exp and log tables for multiplication.
	var logs = [], exps = [], x = 1, primitive = defaults.primitivePolynomials[config.bits];
	for(var i=0; i<config.size; i++){
		exps[i] = x;
		logs[x] = i;
		x <<= 1;
		if(x >= config.size){
			x ^= primitive;
			x &= config.max;
		}
	}
	config.logs = logs;
	config.exps = exps;
};


exports.init = init;

// Divides a `secret` number String str expressed in radix `inputRadix` (optional, default 16)
// into `numShares` shares, each expressed in radix `outputRadix` (optional, default to `inputRadix`),
// requiring `threshold` number of shares to reconstruct the secret.
// Optionally, zero-pads the secret to a length that is a multiple of padLength before sharing.

exports.share = function(secret, numShares, threshold, padLength){
	padLength =  padLength || 0;

	if(typeof secret !== 'string'){
		throw new Error('Secret must be a string.');
	}
	if(typeof numShares !== 'number' || numShares%1 !== 0 || numShares < 2){
		throw new Error('Number of shares must be an integer between 2 and 2^bits-1 (' + config.max + '), inclusive.')
	}
	if(numShares > config.max){
		var neededBits = Math.ceil(Math.log(numShares +1)/Math.LN2);
		throw new Error('Number of shares must be an integer between 2 and 2^bits-1 (' + config.max + '), inclusive. To create ' + numShares + ' shares, use at least ' + neededBits + ' bits.')
	}
	if(typeof threshold !== 'number' || threshold%1 !== 0 || threshold < 2){
		throw new Error('Threshold number of shares must be an integer between 2 and 2^bits-1 (' + config.max + '), inclusive.');
	}
	if(threshold > config.max){
		var neededBits = Math.ceil(Math.log(threshold +1)/Math.LN2);
		throw new Error('Threshold number of shares must be an integer between 2 and 2^bits-1 (' + config.max + '), inclusive.  To use a threshold of ' + threshold + ', use at least ' + neededBits + ' bits.');
	}
	if(typeof padLength !== 'number' || padLength%1 !== 0 ){
		throw new Error('Zero-pad length must be an integer greater than 1.');
	}
	secret = '1' + hex2bin(secret); // append a 1 so that we can preserve the correct number of leading zeros in our secret
	secret = split(secret, padLength);
	var x = new Array(numShares), y = new Array(numShares);
	for(var i=0, len = secret.length; i<len; i++){
		var subShares = this._getShares(secret[i], numShares, threshold);
		for(var j=0; j<numShares; j++){
			x[j] = x[j] || subShares[j].x.toString(config.radix);
			y[j] = padLeft(subShares[j].y.toString(2)) + (y[j] ? y[j] : '');
		}
	}
	var padding = config.max.toString(config.radix).length;
	for(var i=0; i<numShares; i++){
		x[i] = config.bits.toString(36) + padLeft(x[i],padding) + bin2hex(y[i]);
	}
	return x;
};

// This is the basic polynomial generation and evaluation function
// for a `config.bits`-length secret (NOT an arbitrary length)
// Note: no error-checking at this stage! If `secrets` is NOT
// a NUMBER less than 2^bits-1, the output will be incorrect!

exports._getShares = function(secret, numShares, threshold){
	var shares = [];
	var coeffs = [secret];
	var limit = Math.pow(2,config.bits);
	for(var i=1; i<threshold; i++){
//		coeffs[i] = parseInt(config.rng(config.bits),2);		//original random decimal number of maximum size 2^config.bits
		coeffs[i]=sjcl.bn.random(limit).limbs[0];				//using SJCL RNG
	}
	for(var i=1, len = numShares+1; i<len; i++){
		shares[i-1] = {
			x: i,
			y: horner(i, coeffs)
		}
	}
	return shares;
};

// Polynomial evaluation at `x` using Horner's Method
// TODO: this can possibly be sped up using other methods
// NOTE: fx=fx * x + coeff[i] ->  exp(log(fx) + log(x)) + coeff[i],
//       so if fx===0, just set fx to coeff[i] because
//       using the exp/log form will result in incorrect value
function horner(x, coeffs){
	var logx = config.logs[x];
	var fx = 0;
	for(var i=coeffs.length-1; i>=0; i--){
		if(fx === 0){
			fx = coeffs[i];
			continue;
		}
		fx = config.exps[ (logx + config.logs[fx]) % config.max ] ^ coeffs[i];
	}
	return fx;
};

function inArray(arr,val){
	for(var i = 0,len=arr.length; i < len; i++) {
		if(arr[i] === val){
   		 return true;
	 	}
 	}
	return false;
};

function processShare(share){

	var bits = parseInt(share[0], 36);
	if(bits && (typeof bits !== 'number' || bits%1 !== 0 || bits<defaults.minBits || bits>defaults.maxBits)){
		throw new Error('Number of bits must be an integer between ' + defaults.minBits + ' and ' + defaults.maxBits + ', inclusive.')
	}
	var max = Math.pow(2, bits) - 1;
	var idLength = max.toString(config.radix).length;

	var id = parseInt(share.substr(1, idLength), config.radix);
	if(typeof id !== 'number' || id%1 !== 0 || id<1 || id>max){
		throw new Error('Share id must be an integer between 1 and ' + config.max + ', inclusive.');
	}
	share = share.substr(idLength + 1);
	if(!share.length){
		throw new Error('Invalid share: zero-length share.')
	}
	return {
		'bits': bits,
		'id': id,
		'value': share
	};
};


secrets._processShare = processShare;

// Protected method that evaluates the Lagrange interpolation
// polynomial at x=`at` for individual config.bits-length
// segments of each share in the `shares` Array.
// Each share is expressed in base `inputRadix`. The output
// is expressed in base `outputRadix'
function combine(at, shares){
	var setBits, share, x = [], y = [], result = '', idx;

	for(var i=0, len = shares.length; i<len; i++){
		share = processShare(shares[i]);
		if(typeof setBits === 'undefined'){
			setBits = share['bits'];
		}else if(share['bits'] !== setBits){
			throw new Error('Mismatched shares: Different bit settings.')
		}
		if(config.bits !== setBits){
			init(setBits);
		}
		if(inArray(x, share['id'])){ // repeated x value?
			continue;
		}
		idx = x.push(share['id']) - 1;
		share = split(hex2bin(share['value']));
		for(var j=0, len2 = share.length; j<len2; j++){
			y[j] = y[j] || [];
			y[j][idx] = share[j];
		}
	}
	for(var i=0, len=y.length; i<len; i++){
		result = padLeft(lagrange(at, x, y[i]).toString(2)) + result;
	}
	if(at===0){// reconstructing the secret
		var idx = result.indexOf('1'); //find the first 1
		return bin2hex(result.slice(idx+1));
	}else{// generating a new share
		return bin2hex(result);
	}
};

// Combine `shares` Array into the original secret

exports.combine = function(shares){
	return combine(0, shares);
};

// Generate a new share with id `id` (a number between 1 and 2^bits-1)
// `id` can be a Number or a String in the default radix (16)

exports.newShare = function(id, shares){
	if(typeof id === 'string'){
		id = parseInt(id, config.radix);
	}

	var share = processShare(shares[0]);
	var max = Math.pow(2, share['bits']) - 1;

	if(typeof id !== 'number' || id%1 !== 0 || id<1 || id>max){
		throw new Error('Share id must be an integer between 1 and ' + config.max + ', inclusive.');
	}

	var padding = max.toString(config.radix).length;
	return config.bits.toString(36) + padLeft(id.toString(config.radix), padding) + combine(id, shares);
};

// Evaluate the Lagrange interpolation polynomial at x = `at`
// using x and y Arrays that are of the same length, with
// corresponding elements constituting points on the polynomial.
function lagrange(at, x, y){
	var sum = 0,
		product,
		i, j;

	for(var i=0, len = x.length; i<len; i++){
		if(!y[i]){
			continue;
		}
		product = config.logs[y[i]];
		for(var j=0; j<len; j++){
			if(i === j){ continue; }
			if(at === x[j]){ // happens when computing a share that is in the list of shares used to compute it
				product = -1; // fix for a zero product term, after which the sum should be sum^0 = sum, not sum^1
				break;
			}
			product = ( product + config.logs[at ^ x[j]] - config.logs[x[i] ^ x[j]] + config.max ) % config.max;
		}
		sum = product === -1 ? sum : sum ^ config.exps[product]; // though exps[-1]= undefined and undefined ^ anything = anything in chrome, this behavior may not hold everywhere, so do the check
	}
	return sum;
};


exports._lagrange = lagrange;

// Splits a number string `bits`-length segments, after first
// optionally zero-padding it to a length that is a multiple of `padLength.
// Returns array of integers (each less than 2^bits-1), with each element
// representing a `bits`-length segment of the input string from right to left,
// i.e. parts[0] represents the right-most `bits`-length segment of the input string.
function split(str, padLength){
	if(padLength){
		str = padLeft(str, padLength)
	}
	var parts = [];
	for(var i=str.length; i>config.bits; i-=config.bits){
		parts.push(parseInt(str.slice(i-config.bits, i), 2));
	}
	parts.push(parseInt(str.slice(0, i), 2));
	return parts;
};

// Pads a string `str` with zeros on the left so that its length is a multiple of `bits`
function padLeft(str, bits){
	bits = bits || config.bits
	var missing = str.length % bits;
	return (missing ? new Array(bits - missing + 1).join('0') : '') + str;
};

function hex2bin(str){
	var bin = '', num;
	for(var i=str.length - 1; i>=0; i--){
		num = parseInt(str[i], 16)
		if(isNaN(num)){
			throw new Error('Invalid hex character.')
		}
		bin = padLeft(num.toString(2), 4) + bin;
	}
	return bin;
}

function bin2hex(str){
	var hex = '', num;
	str = padLeft(str, 4);
	for(var i=str.length; i>=4; i-=4){
		num = parseInt(str.slice(i-4, i), 2);
		if(isNaN(num)){
			throw new Error('Invalid binary character.')
		}
		hex = num.toString(16) + hex;
	}
	return hex;
}

// by default, initialize without an RNG
exports.init();
})(typeof module !== 'undefined' && module['exports'] ? module['exports'] : (window['secrets'] = {}), typeof GLOBAL !== 'undefined' ? GLOBAL : window );

</script>

<!--steganography.js-->
<script>
/*
 * steganography.js v1.0
 *
 * Copyright (C) 2012, Peter Eigenschink (http://www.peter-eigenschink.at/)
 * Dual-licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and the Beerware (http://en.wikipedia.org/wiki/Beerware) license.
 */
(function(g) {
  var util = {
    "isPrime" : function(n) {
      if (isNaN(n) || !isFinite(n) || n%1 || n<2) return false;
      if (n%2==0) return (n==2);
      if (n%3==0) return (n==3);
      var m=Math.sqrt(n);
      for (var i=5;i<=m;i+=6) {
        if (n%i==0) return false;
        if (n%(i+2)==0) return false;
      }
      return true;
    },
    "findNextPrime" : function(n) {
      for(var i=n; true; i+=1)
        if(util.isPrime(i)) return i;
    },
    "sum" : function(func, end, options) {
      var sum = 0;
      options = options || {};
      for(var i = options.start || 0; i < end; i+=(options.inc||1))
        sum += func(i) || 0;

      return (sum === 0 && options.defValue ? options.defValue : sum);
    },
    "product" : function(func, end, options) {
      var prod = 1;
      options = options || {};
      for(var i = options.start || 0; i < end; i+=(options.inc||1))
        prod *= func(i) || 1;

      return (prod === 1 && options.defValue ? options.defValue : prod);
    },
    "createArrayFromArgs" : function(args,index,threshold) {
      var ret = new Array(threshold-1);
      for(var i = 0; i < threshold; i+=1)
        ret[i] = args(i >= index ? i+1:i);

      return ret;
    }
  };

  function Cover() {};

  Cover.prototype = {
    "config": {
      "t": 3,
      "threshold": 1,
      "args": function(i) { return i+1; },
      "messageDelimiter": function(modMessage,threshold) {
                var delimiter = new Array(threshold*3);
                for(var i = 0; i < delimiter.length; i+=1)
                  delimiter[i] = 255;

                return delimiter;
              },
      "messageCompleted": function(data, i, threshold) {
                var done = true;
                for(var j = 0; j < 16 && done; j+=1) {
                  done = done && (data[i+j*4] === 255);
                }
                return done;
              }
    },
    "encode": function(message, image, options) {
      options = options || {};
      var config = this.config;

      var shadowCanvas = document.createElement('canvas'),
        shadowCtx = shadowCanvas.getContext('2d');

      shadowCanvas.style.display = 'none';

      if(image.length) {
        var dataURL = image;
        image = new Image();
        image.src = dataURL;
      }
      shadowCanvas.width = options.width || image.width;
      shadowCanvas.height = options.height || image.height;
      if(options.height && options.width) {
        shadowCtx.drawImage(image, 0, 0, options.width, options.height );
      } else {
        shadowCtx.drawImage(image, 0, 0);
      }


      var imageData = shadowCtx.getImageData(0, 0, shadowCanvas.width, shadowCanvas.height),
        data = imageData.data;
      // bundlesPerChar ... Count of full t-bit-sized bundles per Character
      // overlapping ... Count of bits of the currently handled character which are not handled during each run
      var t = options.t || config.t,
        threshold = options.threshold || config.threshold,
        bundlesPerChar = 16/t >> 0,
        overlapping = 16%t,
        messageDelimiter = options.messageDelimiter || config.messageDelimiter,
        args = options.args || config.args,
        prime = util.findNextPrime(Math.pow(2,t)),
        decM, oldDec, oldMask, modMessage = [], left, right;

      for(var i=0; i<message.length; i+=1) {
        // dec ... UTF-16 Unicode of the i-th character of the message
        // curOverlapping ... The count of the bits of the previous character not handled in the previous run
        // mask ... The raw initial bitmask, will be changed every run and if bits are overlapping
        var dec = message.charCodeAt(i), curOverlapping = (overlapping*i)%t, mask;
        if(curOverlapping > 0 && oldDec) {
          mask = Math.pow(2,t-curOverlapping) - 1;
          oldMask = 65536 * (1 - Math.pow(2, -curOverlapping)); // 2^16 * ...
          left = (dec & mask) << curOverlapping;
          right = (oldDec & oldMask) >> (bundlesPerChar*t + 1 - curOverlapping);
          modMessage.push(left+right);

          mask = Math.pow(2,2*t-curOverlapping) * (1 - Math.pow(2, -t));
          for(var j=1; j<bundlesPerChar; j+=1) {
            decM = dec & mask;
            modMessage.push(decM >> (((j-1)*t)+(t-curOverlapping)));
            mask <<= t;
          }
          if((overlapping*(i+1))%t === 0) {
            mask = 65536 * (1 - Math.pow(2,-t));
            decM = dec & mask;
            modMessage.push(decM >> (((bundlesPerChar-1)*t)+1));
          }
          else if(((((overlapping*(i+1))%t) + (t-curOverlapping)) <= t)) {
            decM = dec & mask;
            modMessage.push(decM >> (((bundlesPerChar-1)*t)+(t-curOverlapping)));
          }
        }
        else {
          mask = Math.pow(2,t) - 1;
          for(var j=0; j<bundlesPerChar; j+=1) {
            decM = dec & mask;
            modMessage.push(decM >> (j*t));
            mask <<= t;
          }
        }
        oldDec = dec;
      }

      // Write Data
      var offset, index, subOffset, delimiter = messageDelimiter(modMessage,threshold);
      for(offset = 0; (offset+threshold)*4 < data.length && (offset+threshold) < modMessage.length; offset += threshold) {
        var q, qS=[];
        for(var i=0; i<threshold && i+offset < modMessage.length; i+=1) {
          q = 0;
          for(var j=offset; j<threshold+offset && j<modMessage.length; j+=1)
            q+=modMessage[j]*Math.pow(args(i),j-offset);
          qS[i] = (255-prime+1)+(q%prime);
        }
        for(var i=offset*4; i<(offset+qS.length)*4 && i<data.length; i+=4)
          data[i+3] = qS[(i/4)%threshold];

        subOffset = qS.length;
      }
      // Write message-delimiter
      for(index = (offset+subOffset); index-(offset+subOffset)<delimiter.length && (offset+delimiter.length)*4<data.length; index+=1)
        data[(index*4)+3]=delimiter[index-(offset+subOffset)];
      // Clear remaining data
      for(var i=((index+1)*4)+3; i<data.length; i+=4) data[i] = 255;

      imageData.data = data;
      shadowCtx.putImageData(imageData, 0, 0);

      return shadowCanvas.toDataURL();
    },
    "decode": function(image, options) {
      options = options || {};
      var config = this.config;

      var t = options.t || config.t, threshold = options.threshold || config.threshold,
        prime = util.findNextPrime(Math.pow(2, t)),
        imageData, data, q, args = options.args || config.args, modMessage = [],
        messageCompleted = options.messageCompleted || config.messageCompleted;

      if(!t || (t < 1 && t > 7)) throw "Error: Parameter t = " + t + " is not valid: 0 < t < 8";

      var shadowCanvas = document.createElement('canvas'),
        shadowCtx = shadowCanvas.getContext('2d');

      shadowCanvas.style.display = 'none';
      document.body.appendChild(shadowCanvas);

      if(image.length) {
        var dataURL = image;
        image = new Image();
        image.src = dataURL;
      }
      shadowCanvas.width = options.width || image.width;
      shadowCanvas.height = options.width || image.height;
      if(options.height && options.width) {
        shadowCtx.drawImage(image, 0, 0, options.width, options.height );
      } else {
        shadowCtx.drawImage(image, 0, 0);
      }

      imageData = shadowCtx.getImageData(0, 0, shadowCanvas.width, shadowCanvas.height);
      data = imageData.data;

      if (threshold === 1) {
        for(var i=3, done=false; !done && i<data.length && !done; i+=4) {
          done = messageCompleted(data, i, threshold);
          if(!done) modMessage.push(data[i]-(255-prime+1));
        }
      } else {
        for(var k = 0, done=false; !done; k+=1) {
          q = [];
          for(var i=(k*threshold*4)+3; i<(k+1)*threshold*4 && i<data.length && !done; i+=4) {
            done = messageCompleted(data,i,threshold);
            if(!done) q.push(data[i]-(255-prime+1)); // at Array index (i-((k*threshold*4)+3))/4
          }
          if(q.length === 0) continue;
          // Calculate the coefficients which are the same for any order of the variable, but different for each argument
          // i.e. for args[0] coeff=q[0]*(args[1]-args[2])*(args[1]-args[3])*...(args[1]-args[threshold-1])*...*(args[threshold-1]-args[1])*...*(args[threshold-1]-args[threshold-2])
          var variableCoefficients = (function(i) {
            if(i >= q.length) return [];
            return [q[i]*
            util.product(function(j) {
            if(j != i) {
              return util.product(function(l) {
              if(l != j) return (args(j) - args(l));
              }, q.length);
            }
            }, q.length)].concat(arguments.callee(i+1));
          }(0));
          // Calculate the coefficients which are different for each order of the variable and for each argument
          // i.e. for order=0 and args[0] coeff=args[1]*args[2]*...*args[threshold-1]
          var orderVariableCoefficients = function(order, varIndex) {
            var workingArgs = util.createArrayFromArgs(args,varIndex,q.length), maxRec = q.length - (order+1);
            return (function(startIndex, endIndex, recDepth) {
            var recall = arguments.callee;
            return util.sum(function(i) {
              if(recDepth < maxRec)
              return workingArgs[i]*recall(i+1,startIndex+order+2,recDepth+1);
            }, endIndex, {"start": startIndex, "defValue": 1});
            }(0,order+1,0));
          };
          // Calculate the common denominator of the whole term
          var commonDenominator = util.product(function(i) {
            return util.product(function(j) {
            if(j != i) return (args(i) - args(j));
            }, q.length);
          }, q.length);

          for(var i = 0; i < q.length; i+=1) {
            modMessage.push((((Math.pow(-1,q.length-(i+1))*util.sum(function(j) {
            return orderVariableCoefficients(i,j)*
            variableCoefficients[j];
            }, q.length))%prime)+prime)%prime); // ?divide by commonDenominator?
          }
        }
      }


      var message = "", charCode = 0, bitCount = 0;
      for(var i = 0; i < modMessage.length; i+=1) {
        charCode += modMessage[i] << bitCount;
        bitCount += t;
        if(bitCount > 15) {
          message += String.fromCharCode(charCode & 65535);
          bitCount %= 16;
          charCode = modMessage[i] >> (t-bitCount);
        }
      }
      if(charCode !== 0) message += String.fromCharCode(charCode & 65535);

      return message;
    },
    "getHidingCapacity" : function(image, options) {
      options = options || {};

      var width = options.width || image.width,
        height = options.height || image.height,
        t = options.t || this.config.t;
      return t*width*height >> 0;
    }
  };
  g.steganography = g.steg = new Cover();
})(window);
</script>

<!--FastClick, used only by iOS-->
<script>
/**
 * @preserve FastClick: polyfill to remove click delays on browsers with touch UIs.
 *
 * @version 1.0.2
 * @codingstandard ftlabs-jsv2
 * @copyright The Financial Times Limited [All Rights Reserved]
 * @license MIT License (see LICENSE.txt)
 */

/*jslint browser:true, node:true*/
/*global define, Event, Node*/


/**
 * Instantiate fast-clicking listeners on the specified layer.
 *
 * @constructor
 * @param {Element} layer The layer to listen on
 * @param {Object} options The options to override the defaults
 */
function FastClick(layer, options) {
	'use strict';
	var oldOnClick;

	options = options || {};

	/**
	 * Whether a click is currently being tracked.
	 *
	 * @type boolean
	 */
	this.trackingClick = false;


	/**
	 * Timestamp for when click tracking started.
	 *
	 * @type number
	 */
	this.trackingClickStart = 0;


	/**
	 * The element being tracked for a click.
	 *
	 * @type EventTarget
	 */
	this.targetElement = null;


	/**
	 * X-coordinate of touch start event.
	 *
	 * @type number
	 */
	this.touchStartX = 0;


	/**
	 * Y-coordinate of touch start event.
	 *
	 * @type number
	 */
	this.touchStartY = 0;


	/**
	 * ID of the last touch, retrieved from Touch.identifier.
	 *
	 * @type number
	 */
	this.lastTouchIdentifier = 0;


	/**
	 * Touchmove boundary, beyond which a click will be cancelled.
	 *
	 * @type number
	 */
	this.touchBoundary = options.touchBoundary || 10;


	/**
	 * The FastClick layer.
	 *
	 * @type Element
	 */
	this.layer = layer;

	/**
	 * The minimum time between tap(touchstart and touchend) events
	 *
	 * @type number
	 */
	this.tapDelay = options.tapDelay || 200;

	if (FastClick.notNeeded(layer)) {
		return;
	}

	// Some old versions of Android don't have Function.prototype.bind
	function bind(method, context) {
		return function() { return method.apply(context, arguments); };
	}


	var methods = ['onMouse', 'onClick', 'onTouchStart', 'onTouchMove', 'onTouchEnd', 'onTouchCancel'];
	var context = this;
	for (var i = 0, l = methods.length; i < l; i++) {
		context[methods[i]] = bind(context[methods[i]], context);
	}

	// Set up event handlers as required
	if (deviceIsAndroid) {
		layer.addEventListener('mouseover', this.onMouse, true);
		layer.addEventListener('mousedown', this.onMouse, true);
		layer.addEventListener('mouseup', this.onMouse, true);
	}

	layer.addEventListener('click', this.onClick, true);
	layer.addEventListener('touchstart', this.onTouchStart, false);
	layer.addEventListener('touchmove', this.onTouchMove, false);
	layer.addEventListener('touchend', this.onTouchEnd, false);
	layer.addEventListener('touchcancel', this.onTouchCancel, false);

	// Hack is required for browsers that don't support Event#stopImmediatePropagation (e.g. Android 2)
	// which is how FastClick normally stops click events bubbling to callbacks registered on the FastClick
	// layer when they are cancelled.
	if (!Event.prototype.stopImmediatePropagation) {
		layer.removeEventListener = function(type, callback, capture) {
			var rmv = Node.prototype.removeEventListener;
			if (type === 'click') {
				rmv.call(layer, type, callback.hijacked || callback, capture);
			} else {
				rmv.call(layer, type, callback, capture);
			}
		};

		layer.addEventListener = function(type, callback, capture) {
			var adv = Node.prototype.addEventListener;
			if (type === 'click') {
				adv.call(layer, type, callback.hijacked || (callback.hijacked = function(event) {
					if (!event.propagationStopped) {
						callback(event);
					}
				}), capture);
			} else {
				adv.call(layer, type, callback, capture);
			}
		};
	}

	// If a handler is already declared in the element's onclick attribute, it will be fired before
	// FastClick's onClick handler. Fix this by pulling out the user-defined handler function and
	// adding it as listener.
	if (typeof layer.onclick === 'function') {

		// Android browser on at least 3.2 requires a new reference to the function in layer.onclick
		// - the old one won't work if passed to addEventListener directly.
		oldOnClick = layer.onclick;
		layer.addEventListener('click', function(event) {
			oldOnClick(event);
		}, false);
		layer.onclick = null;
	}
}


/**
 * Android requires exceptions.
 *
 * @type boolean
 */
var deviceIsAndroid = navigator.userAgent.indexOf('Android') > 0;


/**
 * iOS requires exceptions.
 *
 * @type boolean
 */
var deviceIsIOS = /iP(ad|hone|od)/.test(navigator.userAgent);


/**
 * iOS 4 requires an exception for select elements.
 *
 * @type boolean
 */
var deviceIsIOS4 = deviceIsIOS && (/OS 4_\d(_\d)?/).test(navigator.userAgent);


/**
 * iOS 6.0(+?) requires the target element to be manually derived
 *
 * @type boolean
 */
var deviceIsIOSWithBadTarget = deviceIsIOS && (/OS ([6-9]|\d{2})_\d/).test(navigator.userAgent);

/**
 * BlackBerry requires exceptions.
 *
 * @type boolean
 */
var deviceIsBlackBerry10 = navigator.userAgent.indexOf('BB10') > 0;

/**
 * Determine whether a given element requires a native click.
 *
 * @param {EventTarget|Element} target Target DOM element
 * @returns {boolean} Returns true if the element needs a native click
 */
FastClick.prototype.needsClick = function(target) {
	'use strict';
	switch (target.nodeName.toLowerCase()) {

	// Don't send a synthetic click to disabled inputs (issue #62)
	case 'button':
	case 'select':
	case 'textarea':
		if (target.disabled) {
			return true;
		}

		break;
	case 'input':

		// File inputs need real clicks on iOS 6 due to a browser bug (issue #68)
		if ((deviceIsIOS && target.type === 'file') || target.disabled) {
			return true;
		}

		break;
	case 'label':
	case 'video':
		return true;
	}

	return (/\bneedsclick\b/).test(target.className);
};


/**
 * Determine whether a given element requires a call to focus to simulate click into element.
 *
 * @param {EventTarget|Element} target Target DOM element
 * @returns {boolean} Returns true if the element requires a call to focus to simulate native click.
 */
FastClick.prototype.needsFocus = function(target) {
	'use strict';
	switch (target.nodeName.toLowerCase()) {
	case 'textarea':
		return true;
	case 'select':
		return !deviceIsAndroid;
	case 'input':
		switch (target.type) {
		case 'button':
		case 'checkbox':
		case 'file':
		case 'image':
		case 'radio':
		case 'submit':
			return false;
		}

		// No point in attempting to focus disabled inputs
		return !target.disabled && !target.readOnly;
	default:
		return (/\bneedsfocus\b/).test(target.className);
	}
};


/**
 * Send a click event to the specified element.
 *
 * @param {EventTarget|Element} targetElement
 * @param {Event} event
 */
FastClick.prototype.sendClick = function(targetElement, event) {
	'use strict';
	var clickEvent, touch;

	// On some Android devices activeElement needs to be blurred otherwise the synthetic click will have no effect (#24)
	if (document.activeElement && document.activeElement !== targetElement) {
		document.activeElement.blur();
	}

	touch = event.changedTouches[0];

	// Synthesise a click event, with an extra attribute so it can be tracked
	clickEvent = document.createEvent('MouseEvents');
	clickEvent.initMouseEvent(this.determineEventType(targetElement), true, true, window, 1, touch.screenX, touch.screenY, touch.clientX, touch.clientY, false, false, false, false, 0, null);
	clickEvent.forwardedTouchEvent = true;
	targetElement.dispatchEvent(clickEvent);
};

FastClick.prototype.determineEventType = function(targetElement) {
	'use strict';

	//Issue #159: Android Chrome Select Box does not open with a synthetic click event
	if (deviceIsAndroid && targetElement.tagName.toLowerCase() === 'select') {
		return 'mousedown';
	}

	return 'click';
};


/**
 * @param {EventTarget|Element} targetElement
 */
FastClick.prototype.focus = function(targetElement) {
	'use strict';
	var length;

	// Issue #160: on iOS 7, some input elements (e.g. date datetime) throw a vague TypeError on setSelectionRange. These elements don't have an integer value for the selectionStart and selectionEnd properties, but unfortunately that can't be used for detection because accessing the properties also throws a TypeError. Just check the type instead. Filed as Apple bug #15122724.
	if (deviceIsIOS && targetElement.setSelectionRange && targetElement.type.indexOf('date') !== 0 && targetElement.type !== 'time') {
		length = targetElement.value.length;
		targetElement.setSelectionRange(length, length);
	} else {
		targetElement.focus();
	}
};


/**
 * Check whether the given target element is a child of a scrollable layer and if so, set a flag on it.
 *
 * @param {EventTarget|Element} targetElement
 */
FastClick.prototype.updateScrollParent = function(targetElement) {
	'use strict';
	var scrollParent, parentElement;

	scrollParent = targetElement.fastClickScrollParent;

	// Attempt to discover whether the target element is contained within a scrollable layer. Re-check if the
	// target element was moved to another parent.
	if (!scrollParent || !scrollParent.contains(targetElement)) {
		parentElement = targetElement;
		do {
			if (parentElement.scrollHeight > parentElement.offsetHeight) {
				scrollParent = parentElement;
				targetElement.fastClickScrollParent = parentElement;
				break;
			}

			parentElement = parentElement.parentElement;
		} while (parentElement);
	}

	// Always update the scroll top tracker if possible.
	if (scrollParent) {
		scrollParent.fastClickLastScrollTop = scrollParent.scrollTop;
	}
};


/**
 * @param {EventTarget} targetElement
 * @returns {Element|EventTarget}
 */
FastClick.prototype.getTargetElementFromEventTarget = function(eventTarget) {
	'use strict';

	// On some older browsers (notably Safari on iOS 4.1 - see issue #56) the event target may be a text node.
	if (eventTarget.nodeType === Node.TEXT_NODE) {
		return eventTarget.parentNode;
	}

	return eventTarget;
};


/**
 * On touch start, record the position and scroll offset.
 *
 * @param {Event} event
 * @returns {boolean}
 */
FastClick.prototype.onTouchStart = function(event) {
	'use strict';
	var targetElement, touch, selection;

	// Ignore multiple touches, otherwise pinch-to-zoom is prevented if both fingers are on the FastClick element (issue #111).
	if (event.targetTouches.length > 1) {
		return true;
	}

	targetElement = this.getTargetElementFromEventTarget(event.target);
	touch = event.targetTouches[0];

	if (deviceIsIOS) {

		// Only trusted events will deselect text on iOS (issue #49)
		selection = window.getSelection();
		if (selection.rangeCount && !selection.isCollapsed) {
			return true;
		}

		if (!deviceIsIOS4) {

			// Weird things happen on iOS when an alert or confirm dialog is opened from a click event callback (issue #23):
			// when the user next taps anywhere else on the page, new touchstart and touchend events are dispatched
			// with the same identifier as the touch event that previously triggered the click that triggered the alert.
			// Sadly, there is an issue on iOS 4 that causes some normal touch events to have the same identifier as an
			// immediately preceeding touch event (issue #52), so this fix is unavailable on that platform.
			if (touch.identifier === this.lastTouchIdentifier) {
				event.preventDefault();
				return false;
			}

			this.lastTouchIdentifier = touch.identifier;

			// If the target element is a child of a scrollable layer (using -webkit-overflow-scrolling: touch) and:
			// 1) the user does a fling scroll on the scrollable layer
			// 2) the user stops the fling scroll with another tap
			// then the event.target of the last 'touchend' event will be the element that was under the user's finger
			// when the fling scroll was started, causing FastClick to send a click event to that layer - unless a check
			// is made to ensure that a parent layer was not scrolled before sending a synthetic click (issue #42).
			this.updateScrollParent(targetElement);
		}
	}

	this.trackingClick = true;
	this.trackingClickStart = event.timeStamp;
	this.targetElement = targetElement;

	this.touchStartX = touch.pageX;
	this.touchStartY = touch.pageY;

	// Prevent phantom clicks on fast double-tap (issue #36)
	if ((event.timeStamp - this.lastClickTime) < this.tapDelay) {
		event.preventDefault();
	}

	return true;
};


/**
 * Based on a touchmove event object, check whether the touch has moved past a boundary since it started.
 *
 * @param {Event} event
 * @returns {boolean}
 */
FastClick.prototype.touchHasMoved = function(event) {
	'use strict';
	var touch = event.changedTouches[0], boundary = this.touchBoundary;

	if (Math.abs(touch.pageX - this.touchStartX) > boundary || Math.abs(touch.pageY - this.touchStartY) > boundary) {
		return true;
	}

	return false;
};


/**
 * Update the last position.
 *
 * @param {Event} event
 * @returns {boolean}
 */
FastClick.prototype.onTouchMove = function(event) {
	'use strict';
	if (!this.trackingClick) {
		return true;
	}

	// If the touch has moved, cancel the click tracking
	if (this.targetElement !== this.getTargetElementFromEventTarget(event.target) || this.touchHasMoved(event)) {
		this.trackingClick = false;
		this.targetElement = null;
	}

	return true;
};


/**
 * Attempt to find the labelled control for the given label element.
 *
 * @param {EventTarget|HTMLLabelElement} labelElement
 * @returns {Element|null}
 */
FastClick.prototype.findControl = function(labelElement) {
	'use strict';

	// Fast path for newer browsers supporting the HTML5 control attribute
	if (labelElement.control !== undefined) {
		return labelElement.control;
	}

	// All browsers under test that support touch events also support the HTML5 htmlFor attribute
	if (labelElement.htmlFor) {
		return document.getElementById(labelElement.htmlFor);
	}

	// If no for attribute exists, attempt to retrieve the first labellable descendant element
	// the list of which is defined here: http://www.w3.org/TR/html5/forms.html#category-label
	return labelElement.querySelector('button, input:not([type=hidden]), keygen, meter, output, progress, select, textarea');
};


/**
 * On touch end, determine whether to send a click event at once.
 *
 * @param {Event} event
 * @returns {boolean}
 */
FastClick.prototype.onTouchEnd = function(event) {
	'use strict';
	var forElement, trackingClickStart, targetTagName, scrollParent, touch, targetElement = this.targetElement;

	if (!this.trackingClick) {
		return true;
	}

	// Prevent phantom clicks on fast double-tap (issue #36)
	if ((event.timeStamp - this.lastClickTime) < this.tapDelay) {
		this.cancelNextClick = true;
		return true;
	}

	// Reset to prevent wrong click cancel on input (issue #156).
	this.cancelNextClick = false;

	this.lastClickTime = event.timeStamp;

	trackingClickStart = this.trackingClickStart;
	this.trackingClick = false;
	this.trackingClickStart = 0;

	// On some iOS devices, the targetElement supplied with the event is invalid if the layer
	// is performing a transition or scroll, and has to be re-detected manually. Note that
	// for this to function correctly, it must be called *after* the event target is checked!
	// See issue #57; also filed as rdar://13048589 .
	if (deviceIsIOSWithBadTarget) {
		touch = event.changedTouches[0];

		// In certain cases arguments of elementFromPoint can be negative, so prevent setting targetElement to null
		targetElement = document.elementFromPoint(touch.pageX - window.pageXOffset, touch.pageY - window.pageYOffset) || targetElement;
		targetElement.fastClickScrollParent = this.targetElement.fastClickScrollParent;
	}

	targetTagName = targetElement.tagName.toLowerCase();
	if (targetTagName === 'label') {
		forElement = this.findControl(targetElement);
		if (forElement) {
			this.focus(targetElement);
			if (deviceIsAndroid) {
				return false;
			}

			targetElement = forElement;
		}
	} else if (this.needsFocus(targetElement)) {

		// Case 1: If the touch started a while ago (best guess is 100ms based on tests for issue #36) then focus will be triggered anyway. Return early and unset the target element reference so that the subsequent click will be allowed through.
		// Case 2: Without this exception for input elements tapped when the document is contained in an iframe, then any inputted text won't be visible even though the value attribute is updated as the user types (issue #37).
		if ((event.timeStamp - trackingClickStart) > 100 || (deviceIsIOS && window.top !== window && targetTagName === 'input')) {
			this.targetElement = null;
			return false;
		}

		this.focus(targetElement);
		this.sendClick(targetElement, event);

		// Select elements need the event to go through on iOS 4, otherwise the selector menu won't open.
		// Also this breaks opening selects when VoiceOver is active on iOS6, iOS7 (and possibly others)
		if (!deviceIsIOS || targetTagName !== 'select') {
			this.targetElement = null;
			event.preventDefault();
		}

		return false;
	}

	if (deviceIsIOS && !deviceIsIOS4) {

		// Don't send a synthetic click event if the target element is contained within a parent layer that was scrolled
		// and this tap is being used to stop the scrolling (usually initiated by a fling - issue #42).
		scrollParent = targetElement.fastClickScrollParent;
		if (scrollParent && scrollParent.fastClickLastScrollTop !== scrollParent.scrollTop) {
			return true;
		}
	}

	// Prevent the actual click from going though - unless the target node is marked as requiring
	// real clicks or if it is in the whitelist in which case only non-programmatic clicks are permitted.
	if (!this.needsClick(targetElement)) {
		event.preventDefault();
		this.sendClick(targetElement, event);
	}

	return false;
};


/**
 * On touch cancel, stop tracking the click.
 *
 * @returns {void}
 */
FastClick.prototype.onTouchCancel = function() {
	'use strict';
	this.trackingClick = false;
	this.targetElement = null;
};


/**
 * Determine mouse events which should be permitted.
 *
 * @param {Event} event
 * @returns {boolean}
 */
FastClick.prototype.onMouse = function(event) {
	'use strict';

	// If a target element was never set (because a touch event was never fired) allow the event
	if (!this.targetElement) {
		return true;
	}

	if (event.forwardedTouchEvent) {
		return true;
	}

	// Programmatically generated events targeting a specific element should be permitted
	if (!event.cancelable) {
		return true;
	}

	// Derive and check the target element to see whether the mouse event needs to be permitted;
	// unless explicitly enabled, prevent non-touch click events from triggering actions,
	// to prevent ghost/doubleclicks.
	if (!this.needsClick(this.targetElement) || this.cancelNextClick) {

		// Prevent any user-added listeners declared on FastClick element from being fired.
		if (event.stopImmediatePropagation) {
			event.stopImmediatePropagation();
		} else {

			// Part of the hack for browsers that don't support Event#stopImmediatePropagation (e.g. Android 2)
			event.propagationStopped = true;
		}

		// Cancel the event
		event.stopPropagation();
		event.preventDefault();

		return false;
	}

	// If the mouse event is permitted, return true for the action to go through.
	return true;
};


/**
 * On actual clicks, determine whether this is a touch-generated click, a click action occurring
 * naturally after a delay after a touch (which needs to be cancelled to avoid duplication), or
 * an actual click which should be permitted.
 *
 * @param {Event} event
 * @returns {boolean}
 */
FastClick.prototype.onClick = function(event) {
	'use strict';
	var permitted;

	// It's possible for another FastClick-like library delivered with third-party code to fire a click event before FastClick does (issue #44). In that case, set the click-tracking flag back to false and return early. This will cause onTouchEnd to return early.
	if (this.trackingClick) {
		this.targetElement = null;
		this.trackingClick = false;
		return true;
	}

	// Very odd behaviour on iOS (issue #18): if a submit element is present inside a form and the user hits enter in the iOS simulator or clicks the Go button on the pop-up OS keyboard the a kind of 'fake' click event will be triggered with the submit-type input element as the target.
	if (event.target.type === 'submit' && event.detail === 0) {
		return true;
	}

	permitted = this.onMouse(event);

	// Only unset targetElement if the click is not permitted. This will ensure that the check for !targetElement in onMouse fails and the browser's click doesn't go through.
	if (!permitted) {
		this.targetElement = null;
	}

	// If clicks are permitted, return true for the action to go through.
	return permitted;
};


/**
 * Remove all FastClick's event listeners.
 *
 * @returns {void}
 */
FastClick.prototype.destroy = function() {
	'use strict';
	var layer = this.layer;

	if (deviceIsAndroid) {
		layer.removeEventListener('mouseover', this.onMouse, true);
		layer.removeEventListener('mousedown', this.onMouse, true);
		layer.removeEventListener('mouseup', this.onMouse, true);
	}

	layer.removeEventListener('click', this.onClick, true);
	layer.removeEventListener('touchstart', this.onTouchStart, false);
	layer.removeEventListener('touchmove', this.onTouchMove, false);
	layer.removeEventListener('touchend', this.onTouchEnd, false);
	layer.removeEventListener('touchcancel', this.onTouchCancel, false);
};


/**
 * Check whether FastClick is needed.
 *
 * @param {Element} layer The layer to listen on
 */
FastClick.notNeeded = function(layer) {
	'use strict';
	var metaViewport;
	var chromeVersion;
	var blackberryVersion;

	// Devices that don't support touch don't need FastClick
	if (typeof window.ontouchstart === 'undefined') {
		return true;
	}

	// Chrome version - zero for other browsers
	chromeVersion = +(/Chrome\/([0-9]+)/.exec(navigator.userAgent) || [,0])[1];

	if (chromeVersion) {

		if (deviceIsAndroid) {
			metaViewport = document.querySelector('meta[name=viewport]');

			if (metaViewport) {
				// Chrome on Android with user-scalable="no" doesn't need FastClick (issue #89)
				if (metaViewport.content.indexOf('user-scalable=no') !== -1) {
					return true;
				}
				// Chrome 32 and above with width=device-width or less don't need FastClick
				if (chromeVersion > 31 && document.documentElement.scrollWidth <= window.outerWidth) {
					return true;
				}
			}

		// Chrome desktop doesn't need FastClick (issue #15)
		} else {
			return true;
		}
	}

	if (deviceIsBlackBerry10) {
		blackberryVersion = navigator.userAgent.match(/Version\/([0-9]*)\.([0-9]*)/);

		// BlackBerry 10.3+ does not require Fastclick library.
		// https://github.com/ftlabs/fastclick/issues/251
		if (blackberryVersion[1] >= 10 && blackberryVersion[2] >= 3) {
			metaViewport = document.querySelector('meta[name=viewport]');

			if (metaViewport) {
				// user-scalable=no eliminates click delay.
				if (metaViewport.content.indexOf('user-scalable=no') !== -1) {
					return true;
				}
				// width=device-width (or less than device-width) eliminates click delay.
				if (document.documentElement.scrollWidth <= window.outerWidth) {
					return true;
				}
			}
		}
	}

	// IE10 with -ms-touch-action: none, which disables double-tap-to-zoom (issue #97)
	if (layer.style.msTouchAction === 'none') {
		return true;
	}

	return false;
};


/**
 * Factory method for creating a FastClick object
 *
 * @param {Element} layer The layer to listen on
 * @param {Object} options The options to override the defaults
 */
FastClick.attach = function(layer, options) {
	'use strict';
	return new FastClick(layer, options);
};


if (typeof define == 'function' && typeof define.amd == 'object' && define.amd) {

	// AMD. Register as an anonymous module.
	define(function() {
		'use strict';
		return FastClick;
	});
} else if (typeof module !== 'undefined' && module.exports) {
	module.exports = FastClick.attach;
	module.exports.FastClick = FastClick;
} else {
	window.FastClick = FastClick;
}
</script>

<!--SJCL libraries-->
<script>
/*SJCL.js begins
 *
 * @author Emily Stark
 * @author Mike Hamburg
 * @author Dan Boneh
 * @author Jeff Mott
 * @author Stefan Thomas
 */

"use strict";
var sjcl = {
    cipher: {},
    hash: {},
    keyexchange: {},
    mode: {},
    misc: {},
    codec: {},
    exception: {
	corrupt: function (a) {
	    this.toString = function () {
		return "CORRUPT: " + this.message
	    };
	    this.message = a
	},
	invalid: function (a) {
	    this.toString = function () {
		return "INVALID: " + this.message
	    };
	    this.message = a
	},
	bug: function (a) {
	    this.toString = function () {
		return "BUG: " + this.message
	    };
	    this.message = a
	},
	notReady: function (a) {
	    this.toString = function () {
		return "NOT READY: " + this.message
	    };
	    this.message = a
	}
    }
};
if (typeof module != "undefined" && module.exports) module.exports = sjcl;
sjcl.cipher.aes = function (a) {
    this.h[0][0][0] || this.z();
    var b, c, d, e, f = this.h[0][4],
	g = this.h[1];
    b = a.length;
    var h = 1;
    if (b !== 4 && b !== 6 && b !== 8) throw new sjcl.exception.invalid("invalid aes key size");
    this.a = [d = a.slice(0), e = []];
    for (a = b; a < 4 * b + 28; a++) {
	c = d[a - 1];
	if (a % b === 0 || b === 8 && a % b === 4) {
	    c = f[c >>> 24] << 24 ^ f[c >> 16 & 255] << 16 ^ f[c >> 8 & 255] << 8 ^ f[c & 255];
	    if (a % b === 0) {
		c = c << 8 ^ c >>> 24 ^ h << 24;
		h = h << 1 ^ (h >> 7) * 283
	    }
	}
	d[a] = d[a - b] ^ c
    }
    for (b = 0; a; b++, a--) {
	c = d[b & 3 ? a : a - 4];
	e[b] = a <= 4 || b < 4 ? c : g[0][f[c >>> 24]] ^ g[1][f[c >> 16 & 255]] ^ g[2][f[c >> 8 & 255]] ^ g[3][f[c & 255]]
    }
};
sjcl.cipher.aes.prototype = {
    encrypt: function (a) {
	return this.I(a, 0)
    },
    decrypt: function (a) {
	return this.I(a, 1)
    },
    h: [
	[
	    [],
	    [],
	    [],
	    [],
	    []
	],
	[
	    [],
	    [],
	    [],
	    [],
	    []
	]
    ],
    z: function () {
	var a = this.h[0],
	    b = this.h[1],
	    c = a[4],
	    d = b[4],
	    e, f, g, h = [],
	    i = [],
	    k, j, l, m;
	for (e = 0; e < 0x100; e++) i[(h[e] = e << 1 ^ (e >> 7) * 283) ^ e] = e;
	for (f = g = 0; !c[f]; f ^= k || 1, g = i[g] || 1) {
	    l = g ^ g << 1 ^ g << 2 ^ g << 3 ^ g << 4;
	    l = l >> 8 ^ l & 255 ^ 99;
	    c[f] = l;
	    d[l] = f;
	    j = h[e = h[k = h[f]]];
	    m = j * 0x1010101 ^ e * 0x10001 ^ k * 0x101 ^ f * 0x1010100;
	    j = h[l] * 0x101 ^ l * 0x1010100;
	    for (e = 0; e < 4; e++) {
		a[e][f] = j = j << 24 ^ j >>> 8;
		b[e][l] = m = m << 24 ^ m >>> 8
	    }
	}
	for (e = 0; e < 5; e++) {
	    a[e] = a[e].slice(0);
	    b[e] = b[e].slice(0)
	}
    },
    I: function (a, b) {
	if (a.length !== 4) throw new sjcl.exception.invalid("invalid aes block size");
	var c = this.a[b],
	    d = a[0] ^ c[0],
	    e = a[b ? 3 : 1] ^ c[1],
	    f = a[2] ^ c[2];
	a = a[b ? 1 : 3] ^ c[3];
	var g, h, i, k = c.length / 4 - 2,
	    j, l = 4,
	    m = [0, 0, 0, 0];
	g = this.h[b];
	var n = g[0],
	    o = g[1],
	    p = g[2],
	    q = g[3],
	    r = g[4];
	for (j = 0; j < k; j++) {
	    g = n[d >>> 24] ^ o[e >> 16 & 255] ^ p[f >> 8 & 255] ^ q[a & 255] ^ c[l];
	    h = n[e >>> 24] ^ o[f >> 16 & 255] ^ p[a >> 8 & 255] ^ q[d & 255] ^ c[l + 1];
	    i = n[f >>> 24] ^ o[a >> 16 & 255] ^ p[d >> 8 & 255] ^ q[e & 255] ^ c[l + 2];
	    a = n[a >>> 24] ^ o[d >> 16 & 255] ^ p[e >> 8 & 255] ^ q[f & 255] ^ c[l + 3];
	    l += 4;
	    d = g;
	    e = h;
	    f = i
	}
	for (j = 0; j < 4; j++) {
	    m[b ? 3 & -j : j] = r[d >>> 24] << 24 ^ r[e >> 16 & 255] << 16 ^ r[f >> 8 & 255] << 8 ^ r[a & 255] ^ c[l++];
	    g = d;
	    d = e;
	    e = f;
	    f = a;
	    a = g
	}
	return m
    }
};
sjcl.bitArray = {
    bitSlice: function (a, b, c) {
	a = sjcl.bitArray.P(a.slice(b / 32), 32 - (b & 31)).slice(1);
	return c === undefined ? a : sjcl.bitArray.clamp(a, c - b)
    },
    extract: function (a, b, c) {
	var d = Math.floor(-b - c & 31);
	return ((b + c - 1 ^ b) & -32 ? a[b / 32 | 0] << 32 - d ^ a[b / 32 + 1 | 0] >>> d : a[b / 32 | 0] >>> d) & (1 << c) - 1
    },
    concat: function (a, b) {
	if (a.length === 0 || b.length === 0) return a.concat(b);
	var c = a[a.length - 1],
	    d = sjcl.bitArray.getPartial(c);
	return d === 32 ? a.concat(b) : sjcl.bitArray.P(b, d, c | 0, a.slice(0, a.length - 1))
    },
    bitLength: function (a) {
	var b = a.length;
	if (b === 0) return 0;
	return (b - 1) * 32 + sjcl.bitArray.getPartial(a[b - 1])
    },
    clamp: function (a, b) {
	if (a.length * 32 < b) return a;
	a = a.slice(0, Math.ceil(b / 32));
	var c = a.length;
	b &= 31;
	if (c > 0 && b) a[c - 1] = sjcl.bitArray.partial(b, a[c - 1] & 2147483648 >> b - 1, 1);
	return a
    },
    partial: function (a, b, c) {
	if (a === 32) return b;
	return (c ? b | 0 : b << 32 - a) + a * 0x10000000000
    },
    getPartial: function (a) {
	return Math.round(a / 0x10000000000) || 32
    },
    equal: function (a, b) {
	if (sjcl.bitArray.bitLength(a) !== sjcl.bitArray.bitLength(b)) return false;
	var c = 0,
	    d;
	for (d = 0; d < a.length; d++) c |= a[d] ^ b[d];
	return c === 0
    },
    P: function (a, b, c, d) {
	var e;
	e = 0;
	if (d === undefined) d = [];
	for (; b >= 32; b -= 32) {
	    d.push(c);
	    c = 0
	}
	if (b === 0) return d.concat(a);
	for (e = 0; e < a.length; e++) {
	    d.push(c | a[e] >>> b);
	    c = a[e] << 32 - b
	}
	e = a.length ? a[a.length - 1] : 0;
	a = sjcl.bitArray.getPartial(e);
	d.push(sjcl.bitArray.partial(b + a & 31, b + a > 32 ? c : d.pop(), 1));
	return d
    },
    k: function (a, b) {
	return [a[0] ^ b[0], a[1] ^ b[1], a[2] ^ b[2], a[3] ^ b[3]]
    }
};
sjcl.codec.utf8String = {
    fromBits: function (a) {
	var b = "",
	    c = sjcl.bitArray.bitLength(a),
	    d, e;
	for (d = 0; d < c / 8; d++) {
	    if ((d & 3) === 0) e = a[d / 4];
	    b += String.fromCharCode(e >>> 24);
	    e <<= 8
	}
	return decodeURIComponent(escape(b))
    },
    toBits: function (a) {
	a = unescape(encodeURIComponent(a));
	var b = [],
	    c, d = 0;
	for (c = 0; c < a.length; c++) {
	    d = d << 8 | a.charCodeAt(c);
	    if ((c & 3) === 3) {
		b.push(d);
		d = 0
	    }
	}
	c & 3 && b.push(sjcl.bitArray.partial(8 * (c & 3), d));
	return b
    }
};
sjcl.codec.hex = {
    fromBits: function (a) {
	var b = "",
	    c;
	for (c = 0; c < a.length; c++) b += ((a[c] | 0) + 0xf00000000000).toString(16).substr(4);
	return b.substr(0, sjcl.bitArray.bitLength(a) / 4)
    },
    toBits: function (a) {
	var b, c = [],
	    d;
	a = a.replace(/\s|0x/g, "");
	d = a.length;
	a += "00000000";
	for (b = 0; b < a.length; b += 8) c.push(parseInt(a.substr(b, 8), 16) ^ 0);
	return sjcl.bitArray.clamp(c, d * 4)
    }
};
sjcl.codec.base64 = {
    F: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",
    fromBits: function (a, b, c) {
	var d = "",
	    e = 0,
	    f = sjcl.codec.base64.F,
	    g = 0,
	    h = sjcl.bitArray.bitLength(a);
	if (c) f = f.substr(0, 62) + "-_";
	for (c = 0; d.length * 6 < h;) {
	    d += f.charAt((g ^ a[c] >>> e) >>> 26);
	    if (e < 6) {
		g = a[c] << 6 - e;
		e += 26;
		c++
	    } else {
		g <<= 6;
		e -= 6
	    }
	}
	for (; d.length & 3 && !b;) d += "=";
	return d
    },
    toBits: function (a, b) {
	a = a.replace(/\s|=/g, "");
	var c = [],
	    d = 0,
	    e = sjcl.codec.base64.F,
	    f = 0,
	    g;
	if (b) e = e.substr(0, 62) + "-_";
	for (b = 0; b < a.length; b++) {
	    g = e.indexOf(a.charAt(b));
	    if (g < 0) throw new sjcl.exception.invalid("this isn't base64!");
	    if (d > 26) {
		d -= 26;
		c.push(f ^ g >>> d);
		f = g << 32 - d
	    } else {
		d += 6;
		f ^= g << 32 - d
	    }
	}
	d & 56 && c.push(sjcl.bitArray.partial(d & 56, f, 1));
	return c
    }
};
sjcl.codec.base64url = {
    fromBits: function (a) {
	return sjcl.codec.base64.fromBits(a, 1, 1)
    },
    toBits: function (a) {
	return sjcl.codec.base64.toBits(a, 1)
    }
};
sjcl.hash.sha256 = function (a) {
    this.a[0] || this.z();
    if (a) {
	this.n = a.n.slice(0);
	this.i = a.i.slice(0);
	this.e = a.e
    } else this.reset()
};
sjcl.hash.sha256.hash = function (a) {
    return (new sjcl.hash.sha256).update(a).finalize()
};
sjcl.hash.sha256.prototype = {
    blockSize: 512,
    reset: function () {
	this.n = this.N.slice(0);
	this.i = [];
	this.e = 0;
	return this
    },
    update: function (a) {
	if (typeof a === "string") a = sjcl.codec.utf8String.toBits(a);
	var b, c = this.i = sjcl.bitArray.concat(this.i, a);
	b = this.e;
	a = this.e = b + sjcl.bitArray.bitLength(a);
	for (b = 512 + b & -512; b <= a; b += 512) this.D(c.splice(0, 16));
	return this
    },
    finalize: function () {
	var a, b = this.i,
	    c = this.n;
	b = sjcl.bitArray.concat(b, [sjcl.bitArray.partial(1, 1)]);
	for (a = b.length + 2; a & 15; a++) b.push(0);
	b.push(Math.floor(this.e / 4294967296));
	for (b.push(this.e | 0); b.length;) this.D(b.splice(0, 16));
	this.reset();
	return c
    },
    N: [],
    a: [],
    z: function () {
	function a(e) {
	    return (e - Math.floor(e)) * 0x100000000 | 0
	}
	var b = 0,
	    c = 2,
	    d;
	a: for (; b < 64; c++) {
	    for (d = 2; d * d <= c; d++) if (c % d === 0) continue a;
	    if (b < 8) this.N[b] = a(Math.pow(c, 0.5));
	    this.a[b] = a(Math.pow(c, 1 / 3));
	    b++
	}
    },
    D: function (a) {
	var b, c, d = a.slice(0),
	    e = this.n,
	    f = this.a,
	    g = e[0],
	    h = e[1],
	    i = e[2],
	    k = e[3],
	    j = e[4],
	    l = e[5],
	    m = e[6],
	    n = e[7];
	for (a = 0; a < 64; a++) {
	    if (a < 16) b = d[a];
	    else {
		b = d[a + 1 & 15];
		c = d[a + 14 & 15];
		b = d[a & 15] = (b >>> 7 ^ b >>> 18 ^ b >>> 3 ^ b << 25 ^ b << 14) + (c >>> 17 ^ c >>> 19 ^ c >>> 10 ^ c << 15 ^ c << 13) + d[a & 15] + d[a + 9 & 15] | 0
	    }
	    b = b + n + (j >>> 6 ^ j >>> 11 ^ j >>> 25 ^ j << 26 ^ j << 21 ^ j << 7) + (m ^ j & (l ^ m)) + f[a];
	    n = m;
	    m = l;
	    l = j;
	    j = k + b | 0;
	    k = i;
	    i = h;
	    h = g;
	    g = b + (h & i ^ k & (h ^ i)) + (h >>> 2 ^ h >>> 13 ^ h >>> 22 ^ h << 30 ^ h << 19 ^ h << 10) | 0
	}
	e[0] = e[0] + g | 0;
	e[1] = e[1] + h | 0;
	e[2] = e[2] + i | 0;
	e[3] = e[3] + k | 0;
	e[4] = e[4] + j | 0;
	e[5] = e[5] + l | 0;
	e[6] = e[6] + m | 0;
	e[7] = e[7] + n | 0
    }
};
sjcl.mode.ccm = {
    name: "ccm",
    encrypt: function (a, b, c, d, e) {
	var f, g = b.slice(0),
	    h = sjcl.bitArray,
	    i = h.bitLength(c) / 8,
	    k = h.bitLength(g) / 8;
	e = e || 64;
	d = d || [];
	if (i < 7) throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes");
	for (f = 2; f < 4 && k >>> 8 * f; f++);
	if (f < 15 - i) f = 15 - i;
	c = h.clamp(c, 8 * (15 - f));
	b = sjcl.mode.ccm.H(a, b, c, d, e, f);
	g = sjcl.mode.ccm.J(a, g, c, b, e, f);
	return h.concat(g.data, g.tag)
    },
    decrypt: function (a, b, c, d, e) {
	e = e || 64;
	d = d || [];
	var f = sjcl.bitArray,
	    g = f.bitLength(c) / 8,
	    h = f.bitLength(b),
	    i = f.clamp(b, h - e),
	    k = f.bitSlice(b,
	    h - e);
	h = (h - e) / 8;
	if (g < 7) throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes");
	for (b = 2; b < 4 && h >>> 8 * b; b++);
	if (b < 15 - g) b = 15 - g;
	c = f.clamp(c, 8 * (15 - b));
	i = sjcl.mode.ccm.J(a, i, c, k, e, b);
	a = sjcl.mode.ccm.H(a, i.data, c, d, e, b);
	if (!f.equal(i.tag, a)){

		if(document.getElementById("lockBox").value.slice(0,1) == '~' || isList){				//modified to add alert in PassLok
			any2key();																				//
			document.getElementById("keymsg").innerHTML = "<span style='color:red'>This Key won't unlock the item</span>"
		}else if(document.getElementById('keyChange').style.display == 'block'){				//
			document.getElementById('keyChange').style.display = 'none';						//
			document.getElementById("keymsg").innerHTML = "<span style='color:red'>The Old Key is wrong</span>"
		}else if (checkingKey){																	//
			document.getElementById('shadow').style.display = 'block';							//
			document.getElementById('keyscr').style.display = 'block';							//
			document.getElementById('keymsg').innerHTML = "<span style='color:red'>Please write the last Key you used</span><br>You can change the Key in Options";
			checkingKey = false;																	//
		}else{																						//
			document.getElementById("mainmsg").innerHTML = '<span>Unlock has Failed</span>';//
		}																							//

	throw new sjcl.exception.corrupt("ccm: tag doesn't match")
	};
	return i.data
    },
    H: function (a, b, c, d, e, f) {
	var g = [],
	    h = sjcl.bitArray,
	    i = h.k;
	e /= 8;
	if (e % 2 || e < 4 || e > 16) throw new sjcl.exception.invalid("ccm: invalid tag length");
	if (d.length > 0xffffffff || b.length > 0xffffffff) throw new sjcl.exception.bug("ccm: can't deal with 4GiB or more data");
	f = [h.partial(8, (d.length ? 64 : 0) | e - 2 << 2 | f - 1)];
	f = h.concat(f, c);
	f[3] |= h.bitLength(b) / 8;
	f = a.encrypt(f);
	if (d.length) {
	    c = h.bitLength(d) / 8;
	    if (c <= 65279) g = [h.partial(16, c)];
	    else if (c <= 0xffffffff) g = h.concat([h.partial(16, 65534)], [c]);
	    g = h.concat(g, d);
	    for (d = 0; d < g.length; d += 4) f = a.encrypt(i(f, g.slice(d, d + 4).concat([0, 0, 0])))
	}
	for (d = 0; d < b.length; d += 4) f = a.encrypt(i(f, b.slice(d, d + 4).concat([0, 0, 0])));
	return h.clamp(f, e * 8)
    },
    J: function (a, b, c, d, e, f) {
	var g, h = sjcl.bitArray;
	g = h.k;
	var i = b.length,
	    k = h.bitLength(b);
	c = h.concat([h.partial(8,
	f - 1)], c).concat([0, 0, 0]).slice(0, 4);
	d = h.bitSlice(g(d, a.encrypt(c)), 0, e);
	if (!i) return {
	    tag: d,
	    data: []
	};
	for (g = 0; g < i; g += 4) {
	    c[3]++;
	    e = a.encrypt(c);
	    b[g] ^= e[0];
	    b[g + 1] ^= e[1];
	    b[g + 2] ^= e[2];
	    b[g + 3] ^= e[3]
	}
	return {
	    tag: d,
	    data: h.clamp(b, k)
	}
    }
};
sjcl.mode.ocb2 = {
    name: "ocb2",
    encrypt: function (a, b, c, d, e, f) {
	if (sjcl.bitArray.bitLength(c) !== 128) throw new sjcl.exception.invalid("ocb iv must be 128 bits");
	var g, h = sjcl.mode.ocb2.B,
	    i = sjcl.bitArray,
	    k = i.k,
	    j = [0, 0, 0, 0];
	c = h(a.encrypt(c));
	var l, m = [];
	d = d || [];
	e = e || 64;
	for (g = 0; g + 4 < b.length; g += 4) {
	    l = b.slice(g, g + 4);
	    j = k(j, l);
	    m = m.concat(k(c, a.encrypt(k(c, l))));
	    c = h(c)
	}
	l = b.slice(g);
	b = i.bitLength(l);
	g = a.encrypt(k(c, [0, 0, 0, b]));
	l = i.clamp(k(l.concat([0, 0, 0]), g), b);
	j = k(j, k(l.concat([0, 0, 0]), g));
	j = a.encrypt(k(j, k(c, h(c))));
	if (d.length) j = k(j, f ? d : sjcl.mode.ocb2.pmac(a, d));
	return m.concat(i.concat(l, i.clamp(j, e)))
    },
    decrypt: function (a, b, c, d, e, f) {
	if (sjcl.bitArray.bitLength(c) !== 128) throw new sjcl.exception.invalid("ocb iv must be 128 bits");
	e = e || 64;
	var g = sjcl.mode.ocb2.B,
	    h = sjcl.bitArray,
	    i = h.k,
	    k = [0, 0, 0, 0],
	    j = g(a.encrypt(c)),
	    l, m, n = sjcl.bitArray.bitLength(b) - e,
	    o = [];
	d = d || [];
	for (c = 0; c + 4 < n / 32; c += 4) {
	    l = i(j, a.decrypt(i(j, b.slice(c, c + 4))));
	    k = i(k, l);
	    o = o.concat(l);
	    j = g(j)
	}
	m = n - c * 32;
	l = a.encrypt(i(j, [0, 0, 0, m]));
	l = i(l, h.clamp(b.slice(c),
	m).concat([0, 0, 0]));
	k = i(k, l);
	k = a.encrypt(i(k, i(j, g(j))));
	if (d.length) k = i(k, f ? d : sjcl.mode.ocb2.pmac(a, d));
	if (!h.equal(h.clamp(k, e), h.bitSlice(b, n))) throw new sjcl.exception.corrupt("ocb: tag doesn't match");
	return o.concat(h.clamp(l, m))
    },
    pmac: function (a, b) {
	var c, d = sjcl.mode.ocb2.B,
	    e = sjcl.bitArray,
	    f = e.k,
	    g = [0, 0, 0, 0],
	    h = a.encrypt([0, 0, 0, 0]);
	h = f(h, d(d(h)));
	for (c = 0; c + 4 < b.length; c += 4) {
	    h = d(h);
	    g = f(g, a.encrypt(f(h, b.slice(c, c + 4))))
	}
	b = b.slice(c);
	if (e.bitLength(b) < 128) {
	    h = f(h, d(h));
	    b = e.concat(b, [2147483648 | 0, 0,
	    0, 0])
	}
	g = f(g, b);
	return a.encrypt(f(d(f(h, d(h))), g))
    },
    B: function (a) {
	return [a[0] << 1 ^ a[1] >>> 31, a[1] << 1 ^ a[2] >>> 31, a[2] << 1 ^ a[3] >>> 31, a[3] << 1 ^ (a[0] >>> 31) * 135]
    }
};
sjcl.misc.hmac = function (a, b) {
    this.M = b = b || sjcl.hash.sha256;
    var c = [
	[],
	[]
    ],
	d = b.prototype.blockSize / 32;
    this.l = [new b, new b];
    if (a.length > d) a = b.hash(a);
    for (b = 0; b < d; b++) {
	c[0][b] = a[b] ^ 909522486;
	c[1][b] = a[b] ^ 1549556828
    }
    this.l[0].update(c[0]);
    this.l[1].update(c[1])
};
sjcl.misc.hmac.prototype.encrypt = sjcl.misc.hmac.prototype.mac = function (a, b) {
    a = (new this.M(this.l[0])).update(a, b).finalize();
    return (new this.M(this.l[1])).update(a).finalize()
};
sjcl.misc.pbkdf2 = function (a, b, c, d, e) {
    c = c || 1E3;
    if (d < 0 || c < 0) throw sjcl.exception.invalid("invalid params to pbkdf2");
    if (typeof a === "string") a = sjcl.codec.utf8String.toBits(a);
    e = e || sjcl.misc.hmac;
    a = new e(a);
    var f, g, h, i, k = [],
	j = sjcl.bitArray;
    for (i = 1; 32 * k.length < (d || 1); i++) {
	e = f = a.encrypt(j.concat(b, [i]));
	for (g = 1; g < c; g++) {
	    f = a.encrypt(f);
	    for (h = 0; h < f.length; h++) e[h] ^= f[h]
	}
	k = k.concat(e)
    }
    if (d) k = j.clamp(k, d);
    return k
};
sjcl.random = {
    randomWords: function (a, b) {
	var c = [];
	b = this.isReady(b);
	var d;
	if (b === 0) throw new sjcl.exception.notReady("generator isn't seeded");
	else b & 2 && this.U(!(b & 1));
	for (b = 0; b < a; b += 4) {
	    (b + 1) % 0x10000 === 0 && this.L();
	    d = this.w();
	    c.push(d[0], d[1], d[2], d[3])
	}
	this.L();
	return c.slice(0, a)
    },
    setDefaultParanoia: function (a) {
	this.t = a
    },
    addEntropy: function (a, b, c) {
	c = c || "user";
	var d, e, f = (new Date).valueOf(),
	    g = this.q[c],
	    h = this.isReady(),
	    i = 0;
	d = this.G[c];
	if (d === undefined) d = this.G[c] = this.R++;
	if (g === undefined) g = this.q[c] = 0;
	this.q[c] = (this.q[c] + 1) % this.b.length;
	switch (typeof a) {
	    case "number":
		if (b === undefined) b = 1;
		this.b[g].update([d, this.u++, 1, b, f, 1, a | 0]);
		break;
	    case "object":
		c = Object.prototype.toString.call(a);
		if (c === "[object Uint32Array]") {
		    e = [];
		    for (c = 0; c < a.length; c++) e.push(a[c]);
		    a = e
		} else {
		    if (c !== "[object Array]") i = 1;
		    for (c = 0; c < a.length && !i; c++) if (typeof a[c] != "number") i = 1
		}
		if (!i) {
		    if (b === undefined) for (c = b = 0; c < a.length; c++) for (e = a[c]; e > 0;) {
			b++;
			e >>>= 1
		    }
		    this.b[g].update([d, this.u++, 2, b, f, a.length].concat(a))
		}
		break;
	    case "string":
		if (b === undefined) b = a.length;
		this.b[g].update([d, this.u++, 3, b, f, a.length]);
		this.b[g].update(a);
		break;
	    default:
		i = 1
	}
	if (i) throw new sjcl.exception.bug("random: addEntropy only supports number, array of numbers or string");
	this.j[g] += b;
	this.f += b;
	if (h === 0) {
	    this.isReady() !== 0 && this.K("seeded", Math.max(this.g, this.f));
	    this.K("progress", this.getProgress())
	}
    },
    isReady: function (a) {
	a = this.C[a !== undefined ? a : this.t];
	return this.g && this.g >= a ? this.j[0] > 80 && (new Date).valueOf() > this.O ? 3 : 1 : this.f >= a ? 2 : 0
    },
    getProgress: function (a) {
	a = this.C[a ? a : this.t];
	return this.g >= a ? 1 : this.f > a ? 1 : this.f / a
    },
    startCollectors: function () {
	if (!this.m) {
	    if (window.addEventListener) {
		window.addEventListener("load", this.o, false);
		window.addEventListener("mousemove", this.p, false)
	    } else if (document.attachEvent) {
		document.attachEvent("onload", this.o);
		document.attachEvent("onmousemove", this.p)
	    } else throw new sjcl.exception.bug("can't attach event");
	    this.m = true
	}
    },
    stopCollectors: function () {
	if (this.m) {
	    if (window.removeEventListener) {
		window.removeEventListener("load",
		this.o, false);
		window.removeEventListener("mousemove", this.p, false)
	    } else if (window.detachEvent) {
		window.detachEvent("onload", this.o);
		window.detachEvent("onmousemove", this.p)
	    }
	    this.m = false
	}
    },
    addEventListener: function (a, b) {
	this.r[a][this.Q++] = b
    },
    removeEventListener: function (a, b) {
	var c;
	a = this.r[a];
	var d = [];
	for (c in a) a.hasOwnProperty(c) && a[c] === b && d.push(c);
	for (b = 0; b < d.length; b++) {
	    c = d[b];
	    delete a[c]
	}
    },
    b: [new sjcl.hash.sha256],
    j: [0],
    A: 0,
    q: {},
    u: 0,
    G: {},
    R: 0,
    g: 0,
    f: 0,
    O: 0,
    a: [0, 0, 0, 0, 0, 0, 0, 0],
    d: [0, 0, 0, 0],
    s: undefined,
    t: 6,
    m: false,
    r: {
	progress: {},
	seeded: {}
    },
    Q: 0,
    C: [0, 48, 64, 96, 128, 192, 0x100, 384, 512, 768, 1024],
    w: function () {
	for (var a = 0; a < 4; a++) {
	    this.d[a] = this.d[a] + 1 | 0;
	    if (this.d[a]) break
	}
	return this.s.encrypt(this.d)
    },
    L: function () {
	this.a = this.w().concat(this.w());
	this.s = new sjcl.cipher.aes(this.a)
    },
    T: function (a) {
	this.a = sjcl.hash.sha256.hash(this.a.concat(a));
	this.s = new sjcl.cipher.aes(this.a);
	for (a = 0; a < 4; a++) {
	    this.d[a] = this.d[a] + 1 | 0;
	    if (this.d[a]) break
	}
    },
    U: function (a) {
	var b = [],
	    c = 0,
	    d;
	this.O = b[0] = (new Date).valueOf() + 3E4;
	for (d = 0; d < 16; d++) b.push(Math.random() * 0x100000000 | 0);
	for (d = 0; d < this.b.length; d++) {
	    b = b.concat(this.b[d].finalize());
	    c += this.j[d];
	    this.j[d] = 0;
	    if (!a && this.A & 1 << d) break
	}
	if (this.A >= 1 << this.b.length) {
	    this.b.push(new sjcl.hash.sha256);
	    this.j.push(0)
	}
	this.f -= c;
	if (c > this.g) this.g = c;
	this.A++;
	this.T(b)
    },
    p: function (a) {
	sjcl.random.addEntropy([a.x || a.clientX || a.offsetX || 0, a.y || a.clientY || a.offsetY || 0], 2, "mouse")
    },
    o: function () {
	sjcl.random.addEntropy((new Date).valueOf(), 2, "loadtime")
    },
    K: function (a, b) {
	var c;
	a = sjcl.random.r[a];
	var d = [];
	for (c in a) a.hasOwnProperty(c) && d.push(a[c]);
	for (c = 0; c < d.length; c++) d[c](b)
    }
};
try {
    var s = new Uint32Array(32);
    crypto.getRandomValues(s);
    sjcl.random.addEntropy(s, 1024, "crypto['getRandomValues']")
} catch (t) {}
sjcl.json = {
    defaults: {
	v: 1,
	iter: 1E3,
	ks: 128,
	ts: 64,
	mode: "ccm",
	adata: "",
	cipher: "aes"
    },
    encrypt: function (a, b, c, d) {
	c = c || {};
	d = d || {};
	var e = sjcl.json,
	    f = e.c({
		iv: sjcl.random.randomWords(4, 0)
	    }, e.defaults),
	    g;
	e.c(f, c);
	c = f.adata;
	if (typeof f.salt === "string") f.salt = sjcl.codec.base64.toBits(f.salt);
	if (typeof f.iv === "string") f.iv = sjcl.codec.base64.toBits(f.iv);
	if (!sjcl.mode[f.mode] || !sjcl.cipher[f.cipher] || typeof a === "string" && f.iter <= 100 || f.ts !== 64 && f.ts !== 96 && f.ts !== 128 || f.ks !== 128 && f.ks !== 192 && f.ks !== 0x100 || f.iv.length < 2 || f.iv.length > 4) throw new sjcl.exception.invalid("json encrypt: invalid parameters");
	if (typeof a === "string") {
	    g = sjcl.misc.cachedPbkdf2(a, f);
	    a = g.key.slice(0, f.ks / 32);
	    f.salt = g.salt
	}
	if (typeof b === "string") b = sjcl.codec.utf8String.toBits(b);
	if (typeof c === "string") c = sjcl.codec.utf8String.toBits(c);
	g = new sjcl.cipher[f.cipher](a);
	e.c(d, f);
	d.key = a;
	f.ct = sjcl.mode[f.mode].encrypt(g, b, f.iv, c, f.ts);
	return e.encode(f)
    },
    decrypt: function (a, b, c, d) {
	c = c || {};
	d = d || {};
	var e = sjcl.json;
	b = e.c(e.c(e.c({}, e.defaults), e.decode(b)),
	c, true);
	var f;
	c = b.adata;
	if (typeof b.salt === "string") b.salt = sjcl.codec.base64.toBits(b.salt);
	if (typeof b.iv === "string") b.iv = sjcl.codec.base64.toBits(b.iv);
	if (!sjcl.mode[b.mode] || !sjcl.cipher[b.cipher] || typeof a === "string" && b.iter <= 100 || b.ts !== 64 && b.ts !== 96 && b.ts !== 128 || b.ks !== 128 && b.ks !== 192 && b.ks !== 0x100 || !b.iv || b.iv.length < 2 || b.iv.length > 4) throw new sjcl.exception.invalid("json decrypt: invalid parameters");
	if (typeof a === "string") {
	    f = sjcl.misc.cachedPbkdf2(a, b);
	    a = f.key.slice(0, b.ks / 32);
	    b.salt = f.salt
	}
	if (typeof c === "string") c = sjcl.codec.utf8String.toBits(c);
	f = new sjcl.cipher[b.cipher](a);
	c = sjcl.mode[b.mode].decrypt(f, b.ct, b.iv, c, b.ts);
	e.c(d, b);
	d.key = a;
	return sjcl.codec.utf8String.fromBits(c)
    },
    encode: function (a) {
	var b, c = "{",
	    d = "";
	for (b in a) if (a.hasOwnProperty(b)) {
	    if (!b.match(/^[a-z0-9]+$/i)) throw new sjcl.exception.invalid("json encode: invalid property name");
	    c += d + '"' + b + '":';
	    d = ",";
	    switch (typeof a[b]) {
		case "number":
		case "boolean":
		    c += a[b];
		    break;
		case "string":
		    c += '"' + escape(a[b]) + '"';
		    break;
		case "object":
		    c += '"' + sjcl.codec.base64.fromBits(a[b], 1) + '"';
		    break;
		default:
		    throw new sjcl.exception.bug("json encode: unsupported type");
	    }
	}
	return c + "}"
    },
    decode: function (a) {
	a = a.replace(/\s/g, "");
	if (!a.match(/^\{.*\}$/)) throw new sjcl.exception.invalid("json decode: this isn't json!");
	a = a.replace(/^\{|\}$/g, "").split(/,/);
	var b = {}, c, d;
	for (c = 0; c < a.length; c++) {
	    if (!(d = a[c].match(/^(?:(["']?)([a-z][a-z0-9]*)\1):(?:(\d+)|"([a-z0-9+\/%*_.@=\-]*)")$/i))) throw new sjcl.exception.invalid("json decode: this isn't json!");
	    b[d[2]] = d[3] ? parseInt(d[3], 10) : d[2].match(/^(ct|salt|iv)$/) ? sjcl.codec.base64.toBits(d[4]) : unescape(d[4])
	}
	return b
    },
    c: function (a, b, c) {
	if (a === undefined) a = {};
	if (b === undefined) return a;
	var d;
	for (d in b) if (b.hasOwnProperty(d)) {
	    if (c && a[d] !== undefined && a[d] !== b[d]) throw new sjcl.exception.invalid("required parameter overridden");
	    a[d] = b[d]
	}
	return a
    },
    W: function (a, b) {
	var c = {}, d;
	for (d in a) if (a.hasOwnProperty(d) && a[d] !== b[d]) c[d] = a[d];
	return c
    },
    V: function (a, b) {
	var c = {}, d;
	for (d = 0; d < b.length; d++) if (a[b[d]] !== undefined) c[b[d]] = a[b[d]];
	return c
    }
};
sjcl.encrypt = sjcl.json.encrypt;
sjcl.decrypt = sjcl.json.decrypt;
sjcl.misc.S = {};
sjcl.misc.cachedPbkdf2 = function (a, b) {
    var c = sjcl.misc.S,
	d;
    b = b || {};
    d = b.iter || 1E3;
    c = c[a] = c[a] || {};
    d = c[d] = c[d] || {
	firstSalt: b.salt && b.salt.length ? b.salt.slice(0) : sjcl.random.randomWords(2, 0)
    };
    c = b.salt === undefined ? d.firstSalt : b.salt;
    d[c] = d[c] || sjcl.misc.pbkdf2(a, c, b.iter);
    return {
	key: d[c].slice(0),
	salt: c.slice(0)
    }
};

//SHA512.js begins (also from SJCL)
/** @fileOverview Javascript SHA-512 implementation.
 *
 * This implementation was written for CryptoJS by Jeff Mott and adapted for
 * SJCL by Stefan Thomas.
 *
 * CryptoJS (c) 2009-2012 by Jeff Mott. All rights reserved.
 * Released with New BSD License
 */

/**
 * Context for a SHA-512 operation in progress.
 * @constructor
 * @class Secure Hash Algorithm, 512 bits.
 */
sjcl.hash.sha512 = function (hash) {
  if (!this._key[0]) { this._precompute(); }
  if (hash) {
    this._h = hash._h.slice(0);
    this._buffer = hash._buffer.slice(0);
    this._length = hash._length;
  } else {
    this.reset();
  }
};

/**
 * Hash a string or an array of words.
 * @static
 * @param {bitArray|String} data the data to hash.
 * @return {bitArray} The hash value, an array of 16 big-endian words.
 */
sjcl.hash.sha512.hash = function (data) {
  return (new sjcl.hash.sha512()).update(data).finalize();
};

sjcl.hash.sha512.prototype = {
  /**
   * The hash's block size, in bits.
   * @constant
   */
  blockSize: 1024,

  /**
   * Reset the hash state.
   * @return this
   */
  reset:function () {
    this._h = this._init.slice(0);
    this._buffer = [];
    this._length = 0;
    return this;
  },

  /**
   * Input several words to the hash.
   * @param {bitArray|String} data the data to hash.
   * @return this
   */
  update: function (data) {
    if (typeof data === "string") {
      data = sjcl.codec.utf8String.toBits(data);
    }
    var i, b = this._buffer = sjcl.bitArray.concat(this._buffer, data),
        ol = this._length,
        nl = this._length = ol + sjcl.bitArray.bitLength(data);
    for (i = 1024+ol & -1024; i <= nl; i+= 1024) {
      this._block(b.splice(0,32));
    }
    return this;
  },

  /**
   * Complete hashing and output the hash value.
   * @return {bitArray} The hash value, an array of 16 big-endian words.
   */
  finalize:function () {
    var i, b = this._buffer, h = this._h;

    // Round out and push the buffer
    b = sjcl.bitArray.concat(b, [sjcl.bitArray.partial(1,1)]);

    // Round out the buffer to a multiple of 32 words, less the 4 length words.
    for (i = b.length + 4; i & 31; i++) {
      b.push(0);
    }

    // append the length
    b.push(0);
    b.push(0);
    b.push(Math.floor(this._length / 0x100000000));
    b.push(this._length | 0);

    while (b.length) {
      this._block(b.splice(0,32));
    }

    this.reset();
    return h;
  },

  /**
   * The SHA-512 initialization vector, to be precomputed.
   * @private
   */
  _init:[],

  /**
   * Least significant 24 bits of SHA512 initialization values.
   *
   * Javascript only has 53 bits of precision, so we compute the 40 most
   * significant bits and add the remaining 24 bits as constants.
   *
   * @private
   */
  _initr: [ 0xbcc908, 0xcaa73b, 0x94f82b, 0x1d36f1, 0xe682d1, 0x3e6c1f, 0x41bd6b, 0x7e2179 ],

   /**
   * The SHA-512 hash key, to be precomputed.
   * @private
   */
  _key:[],

  /**
   * Least significant 24 bits of SHA512 key values.
   * @private
   */
  _keyr:
  [0x28ae22, 0xef65cd, 0x4d3b2f, 0x89dbbc, 0x48b538, 0x05d019, 0x194f9b, 0x6d8118,
   0x030242, 0x706fbe, 0xe4b28c, 0xffb4e2, 0x7b896f, 0x1696b1, 0xc71235, 0x692694,
   0xf14ad2, 0x4f25e3, 0x8cd5b5, 0xac9c65, 0x2b0275, 0xa6e483, 0x41fbd4, 0x1153b5,
   0x66dfab, 0xb43210, 0xfb213f, 0xef0ee4, 0xa88fc2, 0x0aa725, 0x03826f, 0x0e6e70,
   0xd22ffc, 0x26c926, 0xc42aed, 0x95b3df, 0xaf63de, 0x77b2a8, 0xedaee6, 0x82353b,
   0xf10364, 0x423001, 0xf89791, 0x54be30, 0xef5218, 0x65a910, 0x71202a, 0xbbd1b8,
   0xd2d0c8, 0x41ab53, 0x8eeb99, 0x9b48a8, 0xc95a63, 0x418acb, 0x63e373, 0xb2b8a3,
   0xefb2fc, 0x172f60, 0xf0ab72, 0x6439ec, 0x631e28, 0x82bde9, 0xc67915, 0x72532b,
   0x26619c, 0xc0c207, 0xe0eb1e, 0x6ed178, 0x176fba, 0xc898a6, 0xf90dae, 0x1c471b,
   0x047d84, 0xc72493, 0xc9bebc, 0x100d4c, 0x3e42b6, 0x657e2a, 0xd6faec, 0x475817],

  /**
   * Function to precompute _init and _key.
   * @private
   */
  _precompute: function () {
    // XXX: This code is for precomputing the SHA256 constants, change for
    //      SHA512 and re-enable.
    var i = 0, prime = 2, factor;

    function frac(x)  { return (x-Math.floor(x)) * 0x100000000 | 0; }
    function frac2(x) { return (x-Math.floor(x)) * 0x10000000000 & 0xff; }

    outer: for (; i<80; prime++) {
      for (factor=2; factor*factor <= prime; factor++) {
        if (prime % factor === 0) {
          // not a prime
          continue outer;
        }
      }

      if (i<8) {
        this._init[i*2] = frac(Math.pow(prime, 1/2));
        this._init[i*2+1] = (frac2(Math.pow(prime, 1/2)) << 24) | this._initr[i];
      }
      this._key[i*2] = frac(Math.pow(prime, 1/3));
      this._key[i*2+1] = (frac2(Math.pow(prime, 1/3)) << 24) | this._keyr[i];
      i++;
    }
  },

  /**
   * Perform one cycle of SHA-512.
   * @param {bitArray} words one block of words.
   * @private
   */
  _block:function (words) {
    var i, wrh, wrl,
        w = words.slice(0),
        h = this._h,
        k = this._key,
        h0h = h[ 0], h0l = h[ 1], h1h = h[ 2], h1l = h[ 3],
        h2h = h[ 4], h2l = h[ 5], h3h = h[ 6], h3l = h[ 7],
        h4h = h[ 8], h4l = h[ 9], h5h = h[10], h5l = h[11],
        h6h = h[12], h6l = h[13], h7h = h[14], h7l = h[15];

    // Working variables
    var ah = h0h, al = h0l, bh = h1h, bl = h1l,
        ch = h2h, cl = h2l, dh = h3h, dl = h3l,
        eh = h4h, el = h4l, fh = h5h, fl = h5l,
        gh = h6h, gl = h6l, hh = h7h, hl = h7l;

    for (i=0; i<80; i++) {
      // load up the input word for this round
      if (i<16) {
        wrh = w[i * 2];
        wrl = w[i * 2 + 1];
      } else {
        // Gamma0
        var gamma0xh = w[(i-15) * 2];
        var gamma0xl = w[(i-15) * 2 + 1];
        var gamma0h =
          ((gamma0xl << 31) | (gamma0xh >>> 1)) ^
          ((gamma0xl << 24) | (gamma0xh >>> 8)) ^
           (gamma0xh >>> 7);
        var gamma0l =
          ((gamma0xh << 31) | (gamma0xl >>> 1)) ^
          ((gamma0xh << 24) | (gamma0xl >>> 8)) ^
          ((gamma0xh << 25) | (gamma0xl >>> 7));

        // Gamma1
        var gamma1xh = w[(i-2) * 2];
        var gamma1xl = w[(i-2) * 2 + 1];
        var gamma1h =
          ((gamma1xl << 13) | (gamma1xh >>> 19)) ^
          ((gamma1xh << 3)  | (gamma1xl >>> 29)) ^
           (gamma1xh >>> 6);
        var gamma1l =
          ((gamma1xh << 13) | (gamma1xl >>> 19)) ^
          ((gamma1xl << 3)  | (gamma1xh >>> 29)) ^
          ((gamma1xh << 26) | (gamma1xl >>> 6));

        // Shortcuts
        var wr7h = w[(i-7) * 2];
        var wr7l = w[(i-7) * 2 + 1];

        var wr16h = w[(i-16) * 2];
        var wr16l = w[(i-16) * 2 + 1];

        // W(round) = gamma0 + W(round - 7) + gamma1 + W(round - 16)
        wrl = gamma0l + wr7l;
        wrh = gamma0h + wr7h + ((wrl >>> 0) < (gamma0l >>> 0) ? 1 : 0);
        wrl += gamma1l;
        wrh += gamma1h + ((wrl >>> 0) < (gamma1l >>> 0) ? 1 : 0);
        wrl += wr16l;
        wrh += wr16h + ((wrl >>> 0) < (wr16l >>> 0) ? 1 : 0);
      }

      w[i*2]     = wrh |= 0;
      w[i*2 + 1] = wrl |= 0;

      // Ch
      var chh = (eh & fh) ^ (~eh & gh);
      var chl = (el & fl) ^ (~el & gl);

      // Maj
      var majh = (ah & bh) ^ (ah & ch) ^ (bh & ch);
      var majl = (al & bl) ^ (al & cl) ^ (bl & cl);

      // Sigma0
      var sigma0h = ((al << 4) | (ah >>> 28)) ^ ((ah << 30) | (al >>> 2)) ^ ((ah << 25) | (al >>> 7));
      var sigma0l = ((ah << 4) | (al >>> 28)) ^ ((al << 30) | (ah >>> 2)) ^ ((al << 25) | (ah >>> 7));

      // Sigma1
      var sigma1h = ((el << 18) | (eh >>> 14)) ^ ((el << 14) | (eh >>> 18)) ^ ((eh << 23) | (el >>> 9));
      var sigma1l = ((eh << 18) | (el >>> 14)) ^ ((eh << 14) | (el >>> 18)) ^ ((el << 23) | (eh >>> 9));

      // K(round)
      var krh = k[i*2];
      var krl = k[i*2+1];

      // t1 = h + sigma1 + ch + K(round) + W(round)
      var t1l = hl + sigma1l;
      var t1h = hh + sigma1h + ((t1l >>> 0) < (hl >>> 0) ? 1 : 0);
      t1l += chl;
      t1h += chh + ((t1l >>> 0) < (chl >>> 0) ? 1 : 0);
      t1l += krl;
      t1h += krh + ((t1l >>> 0) < (krl >>> 0) ? 1 : 0);
      t1l += wrl;
      t1h += wrh + ((t1l >>> 0) < (wrl >>> 0) ? 1 : 0);

      // t2 = sigma0 + maj
      var t2l = sigma0l + majl;
      var t2h = sigma0h + majh + ((t2l >>> 0) < (sigma0l >>> 0) ? 1 : 0);

      // Update working variables
      hh = gh;
      hl = gl;
      gh = fh;
      gl = fl;
      fh = eh;
      fl = el;
      el = (dl + t1l) | 0;
      eh = (dh + t1h + ((el >>> 0) < (dl >>> 0) ? 1 : 0)) | 0;
      dh = ch;
      dl = cl;
      ch = bh;
      cl = bl;
      bh = ah;
      bl = al;
      al = (t1l + t2l) | 0;
      ah = (t1h + t2h + ((al >>> 0) < (t1l >>> 0) ? 1 : 0)) | 0;
    }

    // Intermediate hash
    h0l = h[1] = (h0l + al) | 0;
    h[0] = (h0h + ah + ((h0l >>> 0) < (al >>> 0) ? 1 : 0)) | 0;
    h1l = h[3] = (h1l + bl) | 0;
    h[2] = (h1h + bh + ((h1l >>> 0) < (bl >>> 0) ? 1 : 0)) | 0;
    h2l = h[5] = (h2l + cl) | 0;
    h[4] = (h2h + ch + ((h2l >>> 0) < (cl >>> 0) ? 1 : 0)) | 0;
    h3l = h[7] = (h3l + dl) | 0;
    h[6] = (h3h + dh + ((h3l >>> 0) < (dl >>> 0) ? 1 : 0)) | 0;
    h4l = h[9] = (h4l + el) | 0;
    h[8] = (h4h + eh + ((h4l >>> 0) < (el >>> 0) ? 1 : 0)) | 0;
    h5l = h[11] = (h5l + fl) | 0;
    h[10] = (h5h + fh + ((h5l >>> 0) < (fl >>> 0) ? 1 : 0)) | 0;
    h6l = h[13] = (h6l + gl) | 0;
    h[12] = (h6h + gh + ((h6l >>> 0) < (gl >>> 0) ? 1 : 0)) | 0;
    h7l = h[15] = (h7l + hl) | 0;
    h[14] = (h7h + hh + ((h7l >>> 0) < (hl >>> 0) ? 1 : 0)) | 0;
  }
};
//SHA512.js ends

//BN.js begins (also from SJCL)
/**
 * Constructs a new bignum from another bignum, a number or a hex string.
 */
sjcl.bn = function(it) {
  this.initWith(it);
};

sjcl.bn.prototype = {
  radix: 24,
  maxMul: 8,
  _class: sjcl.bn,

  copy: function() {
    return new this._class(this);
  },

  /**
   * Initializes this with it, either as a bn, a number, or a hex string.
   */
  initWith: function(it) {
    var i=0, k, n, l;
    switch(typeof it) {
    case "object":
      this.limbs = it.limbs.slice(0);
      break;

    case "number":
      this.limbs = [it];
      this.normalize();
      break;

    case "string":
      it = it.replace(/^0x/, '');
      this.limbs = [];
      // hack
      k = this.radix / 4;
      for (i=0; i < it.length; i+=k) {
	this.limbs.push(parseInt(it.substring(Math.max(it.length - i - k, 0), it.length - i),16));
      }
      break;

    default:
      this.limbs = [0];
    }
    return this;
  },

  /**
   * Returns true if "this" and "that" are equal.  Calls fullReduce().
   * Equality test is in constant time.
   */
  equals: function(that) {
    if (typeof that === "number") { that = new this._class(that); }
    var difference = 0, i;
    this.fullReduce();
    that.fullReduce();
    for (i = 0; i < this.limbs.length || i < that.limbs.length; i++) {
      difference |= this.getLimb(i) ^ that.getLimb(i);
    }
    return (difference === 0);
  },

  /**
   * Get the i'th limb of this, zero if i is too large.
   */
  getLimb: function(i) {
    return (i >= this.limbs.length) ? 0 : this.limbs[i];
  },

  /**
   * Constant time comparison function.
   * Returns 1 if this >= that, or zero otherwise.
   */
  greaterEquals: function(that) {
    if (typeof that === "number") { that = new this._class(that); }
    var less = 0, greater = 0, i, a, b;
    i = Math.max(this.limbs.length, that.limbs.length) - 1;
    for (; i>= 0; i--) {
      a = this.getLimb(i);
      b = that.getLimb(i);
      greater |= (b - a) & ~less;
      less |= (a - b) & ~greater;
    }
    return (greater | ~less) >>> 31;
  },

  /**
   * Convert to a hex string.
   */
  toString: function() {
    this.fullReduce();
    var out="", i, s, l = this.limbs;
    for (i=0; i < this.limbs.length; i++) {
      s = l[i].toString(16);
      while (i < this.limbs.length - 1 && s.length < 6) {
	s = "0" + s;
      }
      out = s + out;
    }
    return "0x"+out;
  },

  /** this += that.  Does not normalize. */
  addM: function(that) {
    if (typeof(that) !== "object") { that = new this._class(that); }
    var i, l=this.limbs, ll=that.limbs;
    for (i=l.length; i<ll.length; i++) {
      l[i] = 0;
    }
    for (i=0; i<ll.length; i++) {
      l[i] += ll[i];
    }
    return this;
  },

  /** this *= 2.  Requires normalized; ends up normalized. */
  doubleM: function() {
    var i, carry=0, tmp, r=this.radix, m=this.radixMask, l=this.limbs;
    for (i=0; i<l.length; i++) {
      tmp = l[i];
      tmp = tmp+tmp+carry;
      l[i] = tmp & m;
      carry = tmp >> r;
    }
    if (carry) {
      l.push(carry);
    }
    return this;
  },

  /** this /= 2, rounded down.	Requires normalized; ends up normalized. */
  halveM: function() {
    var i, carry=0, tmp, r=this.radix, l=this.limbs;
    for (i=l.length-1; i>=0; i--) {
      tmp = l[i];
      l[i] = (tmp+carry)>>1;
      carry = (tmp&1) << r;
    }
    if (!l[l.length-1]) {
      l.pop();
    }
    return this;
  },

  /** this -= that.  Does not normalize. */
  subM: function(that) {
    if (typeof(that) !== "object") { that = new this._class(that); }
    var i, l=this.limbs, ll=that.limbs;
    for (i=l.length; i<ll.length; i++) {
      l[i] = 0;
    }
    for (i=0; i<ll.length; i++) {
      l[i] -= ll[i];
    }
    return this;
  },

  mod: function(that) {
    that = new sjcl.bn(that).normalize(); // copy before we begin
    var out = new sjcl.bn(this).normalize(), ci=0;

    for (; out.greaterEquals(that); ci++) {

      that.doubleM();
    }
    for (; ci > 0; ci--) {
      that.halveM();
      if (out.greaterEquals(that)) {
	out.subM(that).normalize();
      }
    }
    return out.trim();
  },

  /** return inverse mod prime p.  p must be odd. Binary extended Euclidean algorithm mod p. */
  inverseMod: function(p) {
    var a = new sjcl.bn(1), b = new sjcl.bn(0), x = new sjcl.bn(this), y = new sjcl.bn(p), tmp, i, nz=1;

    if (!(p.limbs[0] & 1)) {
      throw (new sjcl.exception.invalid("inverseMod: p must be odd"));
    }

    // invariant: y is odd
    do {
      if (x.limbs[0] & 1) {
	if (!x.greaterEquals(y)) {
	  // x < y; swap everything
	  tmp = x; x = y; y = tmp;
	  tmp = a; a = b; b = tmp;
	}
	x.subM(y);
	x.normalize();

	if (!a.greaterEquals(b)) {
	  a.addM(p);
	}
	a.subM(b);
      }

      // cut everything in half
      x.halveM();
      if (a.limbs[0] & 1) {
	a.addM(p);
      }
      a.normalize();
      a.halveM();

      // check for termination: x ?= 0
      for (i=nz=0; i<x.limbs.length; i++) {
	nz |= x.limbs[i];
      }
    } while(nz);

    if (!y.equals(1)) {
      throw (new sjcl.exception.invalid("inverseMod: p and x must be relatively prime"));
    }

    return b;
  },

  /** this + that.  Does not normalize. */
  add: function(that) {
    return this.copy().addM(that);
  },

  /** this - that.  Does not normalize. */
  sub: function(that) {
    return this.copy().subM(that);
  },

  /** this * that.  Normalizes and reduces. */
  mul: function(that) {
    if (typeof(that) === "number") { that = new this._class(that); }
    var i, j, a = this.limbs, b = that.limbs, al = a.length, bl = b.length, out = new this._class(), c = out.limbs, ai, ii=this.maxMul;

    for (i=0; i < this.limbs.length + that.limbs.length + 1; i++) {
      c[i] = 0;
    }
    for (i=0; i<al; i++) {
      ai = a[i];
      for (j=0; j<bl; j++) {
	c[i+j] += ai * b[j];
      }

      if (!--ii) {
	ii = this.maxMul;
	out.cnormalize();
      }
    }
    return out.cnormalize().reduce();
  },

  /** this ^ 2.  Normalizes and reduces. */
  square: function() {
    return this.mul(this);
  },

  /** this ^ n.  Uses square-and-multiply.  Normalizes and reduces. */
  power: function(l) {
    if (typeof(l) === "number") {
      l = [l];
    } else if (l.limbs !== undefined) {
      l = l.normalize().limbs;
    }
    var i, j, out = new this._class(1), pow = this;

    for (i=0; i<l.length; i++) {
      for (j=0; j<this.radix; j++) {
	if (l[i] & (1<<j)) {
	  out = out.mul(pow);
	}
	pow = pow.square();
      }
    }

    return out;
  },

  /** this * that mod N */
  mulmod: function(that, N) {
    return this.mod(N).mul(that.mod(N)).mod(N);
  },

  /** this ^ x mod N */
  powermod: function(x, N) {
    var result = new sjcl.bn(1), a = new sjcl.bn(this), k = new sjcl.bn(x);
    while (true) {
      if (k.limbs[0] & 1) { result = result.mulmod(a, N); }
      k.halveM();
      if (k.equals(0)) { break; }
      a = a.mulmod(a, N);
    }
    return result.normalize().reduce();
  },

  trim: function() {
    var l = this.limbs, p;
    do {
      p = l.pop();
    } while (l.length && p === 0);
    l.push(p);
    return this;
  },

  /** Reduce mod a modulus.  Stubbed for subclassing. */
  reduce: function() {
    return this;
  },

  /** Reduce and normalize. */
  fullReduce: function() {
    return this.normalize();
  },

  /** Propagate carries. */
  normalize: function() {
    var carry=0, i, pv = this.placeVal, ipv = this.ipv, l, m, limbs = this.limbs, ll = limbs.length, mask = this.radixMask;
    for (i=0; i < ll || (carry !== 0 && carry !== -1); i++) {
      l = (limbs[i]||0) + carry;
      m = limbs[i] = l & mask;
      carry = (l-m)*ipv;
    }
    if (carry === -1) {
      limbs[i-1] -= this.placeVal;
    }
    return this;
  },

  /** Constant-time normalize. Does not allocate additional space. */
  cnormalize: function() {
    var carry=0, i, ipv = this.ipv, l, m, limbs = this.limbs, ll = limbs.length, mask = this.radixMask;
    for (i=0; i < ll-1; i++) {
      l = limbs[i] + carry;
      m = limbs[i] = l & mask;
      carry = (l-m)*ipv;
    }
    limbs[i] += carry;
    return this;
  },

  /** Serialize to a bit array */
  toBits: function(len) {
    this.fullReduce();
    len = len || this.exponent || this.limbs.length * this.radix;
    var i = Math.floor((len-1)/24), w=sjcl.bitArray, e = (len + 7 & -8) % this.radix || this.radix,
	out = [w.partial(e, this.getLimb(i))];
    for (i--; i >= 0; i--) {
      out = w.concat(out, [w.partial(this.radix, this.getLimb(i))]);
    }
    return out;
  },

  /** Return the length in bits, rounded up to the nearest byte. */
  bitLength: function() {
    this.fullReduce();
    var out = this.radix * (this.limbs.length - 1),
	b = this.limbs[this.limbs.length - 1];
    for (; b; b >>= 1) {
      out ++;
    }
    return out+7 & -8;
  }
};

sjcl.bn.fromBits = function(bits) {
  var Class = this, out = new Class(), words=[], w=sjcl.bitArray, t = this.prototype,
      l = Math.min(this.bitLength || 0x100000000, w.bitLength(bits)), e = l % t.radix || t.radix;

  words[0] = w.extract(bits, 0, e);
  for (; e < l; e += t.radix) {
    words.unshift(w.extract(bits, e, t.radix));
  }

  out.limbs = words;
  return out;
};

sjcl.bn.prototype.ipv = 1 / (sjcl.bn.prototype.placeVal = Math.pow(2,sjcl.bn.prototype.radix));
sjcl.bn.prototype.radixMask = (1 << sjcl.bn.prototype.radix) - 1;

/**
 * Creates a new subclass of bn, based on reduction modulo a pseudo-Mersenne prime,
 * i.e. a prime of the form 2^e + sum(a * 2^b),where the sum is negative and sparse.
 */
sjcl.bn.pseudoMersennePrime = function(exponent, coeff) {
  function p(it) {
    this.initWith(it);
    /*if (this.limbs[this.modOffset]) {
      this.reduce();
    }*/
  }

  var ppr = p.prototype = new sjcl.bn(), i, tmp, mo;
  mo = ppr.modOffset = Math.ceil(tmp = exponent / ppr.radix);
  ppr.exponent = exponent;
  ppr.offset = [];
  ppr.factor = [];
  ppr.minOffset = mo;
  ppr.fullMask = 0;
  ppr.fullOffset = [];
  ppr.fullFactor = [];
  ppr.modulus = p.modulus = new sjcl.bn(Math.pow(2,exponent));

  ppr.fullMask = 0|-Math.pow(2, exponent % ppr.radix);

  for (i=0; i<coeff.length; i++) {
    ppr.offset[i] = Math.floor(coeff[i][0] / ppr.radix - tmp);
    ppr.fullOffset[i] = Math.ceil(coeff[i][0] / ppr.radix - tmp);
    ppr.factor[i] = coeff[i][1] * Math.pow(1/2, exponent - coeff[i][0] + ppr.offset[i] * ppr.radix);
    ppr.fullFactor[i] = coeff[i][1] * Math.pow(1/2, exponent - coeff[i][0] + ppr.fullOffset[i] * ppr.radix);
    ppr.modulus.addM(new sjcl.bn(Math.pow(2,coeff[i][0])*coeff[i][1]));
    ppr.minOffset = Math.min(ppr.minOffset, -ppr.offset[i]); // conservative
  }
  ppr._class = p;
  ppr.modulus.cnormalize();

  /** Approximate reduction mod p.  May leave a number which is negative or slightly larger than p. */
  ppr.reduce = function() {
    var i, k, l, mo = this.modOffset, limbs = this.limbs, aff, off = this.offset, ol = this.offset.length, fac = this.factor, ll;

    i = this.minOffset;
    while (limbs.length > mo) {
      l = limbs.pop();
      ll = limbs.length;
      for (k=0; k<ol; k++) {
	limbs[ll+off[k]] -= fac[k] * l;
      }

      i--;
      if (!i) {
	limbs.push(0);
	this.cnormalize();
	i = this.minOffset;
      }
    }
    this.cnormalize();

    return this;
  };

  ppr._strongReduce = (ppr.fullMask === -1) ? ppr.reduce : function() {
    var limbs = this.limbs, i = limbs.length - 1, k, l;
    this.reduce();
    if (i === this.modOffset - 1) {
      l = limbs[i] & this.fullMask;
      limbs[i] -= l;
      for (k=0; k<this.fullOffset.length; k++) {
	limbs[i+this.fullOffset[k]] -= this.fullFactor[k] * l;
      }
      this.normalize();
    }
  };

  /** mostly constant-time, very expensive full reduction. */
  ppr.fullReduce = function() {
    var greater, i;
    // massively above the modulus, may be negative

    this._strongReduce();
    // less than twice the modulus, may be negative

    this.addM(this.modulus);
    this.addM(this.modulus);
    this.normalize();
    // probably 2-3x the modulus

    this._strongReduce();
    // less than the power of 2.  still may be more than
    // the modulus

    // HACK: pad out to this length
    for (i=this.limbs.length; i<this.modOffset; i++) {
      this.limbs[i] = 0;
    }

    // constant-time subtract modulus
    greater = this.greaterEquals(this.modulus);
    for (i=0; i<this.limbs.length; i++) {
      this.limbs[i] -= this.modulus.limbs[i] * greater;
    }
    this.cnormalize();

    return this;
  };

  ppr.inverse = function() {
    return (this.power(this.modulus.sub(2)));
  };

  p.fromBits = sjcl.bn.fromBits;

  return p;
};

// a small Mersenne prime
sjcl.bn.prime = {
  // NIST primes
  p192: sjcl.bn.pseudoMersennePrime(192, [[0,-1],[64,-1]]),
  p224: sjcl.bn.pseudoMersennePrime(224, [[0,1],[96,-1]]),
  p256: sjcl.bn.pseudoMersennePrime(256, [[0,-1],[96,1],[192,1],[224,-1]]),
  p384: sjcl.bn.pseudoMersennePrime(384, [[0,-1],[32,1],[96,-1],[128,-1]]),
  p521: sjcl.bn.pseudoMersennePrime(521, [[0,-1]])
};

sjcl.bn.random = function(modulus, paranoia) {
  if (typeof modulus !== "object") { modulus = new sjcl.bn(modulus); }
  var words, i, l = modulus.limbs.length, m = modulus.limbs[l-1]+1, out = new sjcl.bn();
  while (true) {
    // get a sequence whose first digits make sense
    do {
      words = sjcl.random.randomWords(l, paranoia);
      if (words[l-1] < 0) { words[l-1] += 0x100000000; }
    } while (Math.floor(words[l-1] / m) === Math.floor(0x100000000 / m));
    words[l-1] %= m;

    // mask off all the limbs
    for (i=0; i<l-1; i++) {
      words[i] &= modulus.radixMask;
    }

    // check the rest of the digitssj
    out.limbs = words;
    if (!out.greaterEquals(modulus)) {
      return out;
    }
  }
};

//ECC.js begins
//F. Ruiz: I added the 521-bit curve, took out elGamal etc. at the end, replaced by my own functions. Modifications are noted)

sjcl.ecc = {};

/**
 * Represents a point on a curve in affine coordinates.
 * @constructor
 * @param {sjcl.ecc.curve} curve The curve that this point lies on.
 * @param {bigInt} x The x coordinate.
 * @param {bigInt} y The y coordinate.
 */
sjcl.ecc.point = function(curve,x,y) {
  if (x === undefined) {
    this.isIdentity = true;
  } else {
    this.x = x;
    this.y = y;
    this.isIdentity = false;
  }
  this.curve = curve;
};

sjcl.ecc.point.prototype = {
  toJac: function() {
    return new sjcl.ecc.pointJac(this.curve, this.x, this.y, new this.curve.field(1));
  },

  mult: function(k) {
    return this.toJac().mult(k, this).toAffine();
  },

  /**
   * Multiply this point by k, added to affine2*k2, and return the answer in Jacobian coordinates.
   * @param {bigInt} k The coefficient to multiply this by.
   * @param {bigInt} k2 The coefficient to multiply affine2 this by.
   * @param {sjcl.ecc.point} affine The other point in affine coordinates.
   * @return {sjcl.ecc.pointJac} The result of the multiplication and addition, in Jacobian coordinates.
   */
  mult2: function(k, k2, affine2) {
    return this.toJac().mult2(k, this, k2, affine2).toAffine();
  },

  multiples: function() {
    var m, i, j;
    if (this._multiples === undefined) {
      j = this.toJac().doubl();
      m = this._multiples = [new sjcl.ecc.point(this.curve), this, j.toAffine()];
      for (i=3; i<16; i++) {
	j = j.add(this);
	m.push(j.toAffine());
      }
    }
    return this._multiples;
  },

  isValid: function() {
    return this.y.square().equals(this.curve.b.add(this.x.mul(this.curve.a.add(this.x.square()))));
  },

  toBits: function() {
    return sjcl.bitArray.concat(this.x.toBits(), this.y.toBits());
  }
};

/**
 * Represents a point on a curve in Jacobian coordinates. Coordinates can be specified as bigInts or strings (which
 * will be converted to bigInts).
 *
 * @constructor
 * @param {bigInt/string} x The x coordinate.
 * @param {bigInt/string} y The y coordinate.
 * @param {bigInt/string} z The z coordinate.
 * @param {sjcl.ecc.curve} curve The curve that this point lies on.
 */
sjcl.ecc.pointJac = function(curve, x, y, z) {
  if (x === undefined) {
    this.isIdentity = true;
  } else {
    this.x = x;
    this.y = y;
    this.z = z;
    this.isIdentity = false;
  }
  this.curve = curve;
};

sjcl.ecc.pointJac.prototype = {
  /**
   * Adds S and T and returns the result in Jacobian coordinates. Note that S must be in Jacobian coordinates and T must be in affine coordinates.
   * @param {sjcl.ecc.pointJac} S One of the points to add, in Jacobian coordinates.
   * @param {sjcl.ecc.point} T The other point to add, in affine coordinates.
   * @return {sjcl.ecc.pointJac} The sum of the two points, in Jacobian coordinates.
   */
  add: function(T) {
    var S = this, sz2, c, d, c2, x1, x2, x, y1, y2, y, z;
    if (S.curve !== T.curve) {
      throw("sjcl.ecc.add(): Points must be on the same curve to add them!");
    }

    if (S.isIdentity) {
      return T.toJac();
    } else if (T.isIdentity) {
      return S;
    }

    sz2 = S.z.square();
    c = T.x.mul(sz2).subM(S.x);

    if (c.equals(0)) {
      if (S.y.equals(T.y.mul(sz2.mul(S.z)))) {
	// same point
	return S.doubl();
      } else {
	// inverses
	return new sjcl.ecc.pointJac(S.curve);
      }
    }

    d = T.y.mul(sz2.mul(S.z)).subM(S.y);
    c2 = c.square();

    x1 = d.square();
    x2 = c.square().mul(c).addM( S.x.add(S.x).mul(c2) );
    x  = x1.subM(x2);

    y1 = S.x.mul(c2).subM(x).mul(d);
    y2 = S.y.mul(c.square().mul(c));
    y  = y1.subM(y2);

    z  = S.z.mul(c);

    return new sjcl.ecc.pointJac(this.curve,x,y,z);
  },

  /**
   * doubles this point.
   * @return {sjcl.ecc.pointJac} The doubled point.
   */
  doubl: function() {
    if (this.isIdentity) { return this; }

    var
      y2 = this.y.square(),
      a  = y2.mul(this.x.mul(4)),
      b  = y2.square().mul(8),
      z2 = this.z.square(),
      c  = this.x.sub(z2).mul(3).mul(this.x.add(z2)),
      x  = c.square().subM(a).subM(a),
      y  = a.sub(x).mul(c).subM(b),
      z  = this.y.add(this.y).mul(this.z);
    return new sjcl.ecc.pointJac(this.curve, x, y, z);
  },

  /**
   * Returns a copy of this point converted to affine coordinates.
   * @return {sjcl.ecc.point} The converted point.
   */
  toAffine: function() {
    if (this.isIdentity || this.z.equals(0)) {
      return new sjcl.ecc.point(this.curve);
    }
    var zi = this.z.inverse(), zi2 = zi.square();
    return new sjcl.ecc.point(this.curve, this.x.mul(zi2).fullReduce(), this.y.mul(zi2.mul(zi)).fullReduce());
  },

  /**
   * Multiply this point by k and return the answer in Jacobian coordinates.
   * @param {bigInt} k The coefficient to multiply by.
   * @param {sjcl.ecc.point} affine This point in affine coordinates.
   * @return {sjcl.ecc.pointJac} The result of the multiplication, in Jacobian coordinates.
   */
  mult: function(k, affine) {
    if (typeof(k) === "number") {
      k = [k];
    } else if (k.limbs !== undefined) {
      k = k.normalize().limbs;
    }

    var i, j, out = new sjcl.ecc.point(this.curve).toJac(), multiples = affine.multiples();

    for (i=k.length-1; i>=0; i--) {
      for (j=sjcl.bn.prototype.radix-4; j>=0; j-=4) {
	out = out.doubl().doubl().doubl().doubl().add(multiples[k[i]>>j & 0xF]);
      }
    }

    return out;
  },

/**
   * Multiply this point by k, added to affine2*k2, and return the answer in Jacobian coordinates.
   * @param {bigInt} k The coefficient to multiply this by.
   * @param {sjcl.ecc.point} affine This point in affine coordinates.
   * @param {bigInt} k2 The coefficient to multiply affine2 this by.
   * @param {sjcl.ecc.point} affine The other point in affine coordinates.
   * @return {sjcl.ecc.pointJac} The result of the multiplication and addition, in Jacobian coordinates.
   */
  mult2: function(k1, affine, k2, affine2) {
    if (typeof(k1) === "number") {
      k1 = [k1];
    } else if (k1.limbs !== undefined) {
      k1 = k1.normalize().limbs;
    }

    if (typeof(k2) === "number") {
      k2 = [k2];
    } else if (k2.limbs !== undefined) {
      k2 = k2.normalize().limbs;
    }

    var i, j, out = new sjcl.ecc.point(this.curve).toJac(), m1 = affine.multiples(),
        m2 = affine2.multiples(), l1, l2;

    for (i=Math.max(k1.length,k2.length)-1; i>=0; i--) {
      l1 = k1[i] | 0;
      l2 = k2[i] | 0;
      for (j=sjcl.bn.prototype.radix-4; j>=0; j-=4) {
        out = out.doubl().doubl().doubl().doubl().add(m1[l1>>j & 0xF]).add(m2[l2>>j & 0xF]);
      }
    }

    return out;
  },

  isValid: function() {
    var z2 = this.z.square(), z4 = z2.square(), z6 = z4.mul(z2);
    return this.y.square().equals(
	    this.curve.b.mul(z6).add(this.x.mul(
	      this.curve.a.mul(z4).add(this.x.square()))));
  }
};

/**
 * Construct an elliptic curve. Most users will not use this and instead start with one of the NIST curves defined below.
 *
 * @constructor
 * @param {bigInt} p The prime modulus.
 * @param {bigInt} r The prime order of the curve.
 * @param {bigInt} a The constant a in the equation of the curve y^2 = x^3 + ax + b (for NIST curves, a is always -3).
 * @param {bigInt} x The x coordinate of a base point of the curve.
 * @param {bigInt} y The y coordinate of a base point of the curve.
 */
sjcl.ecc.curve = function(Field, r, a, b, x, y) {
  this.field = Field;
  this.r = Field.prototype.modulus.sub(r);
  this.a = new Field(a);
  this.b = new Field(b);
  this.G = new sjcl.ecc.point(this, new Field(x), new Field(y));
};

sjcl.ecc.curve.prototype.fromBits = function (bits) {
  var w = sjcl.bitArray, l = this.field.prototype.exponent + 7 & -8,
      p = new sjcl.ecc.point(this, this.field.fromBits(w.bitSlice(bits, 0, l)),
			    this.field.fromBits(w.bitSlice(bits, l, 2*l)));
  if (!p.isValid()) {																	//modified to add alert in PassLok
	document.getElementById("mainmsg").innerHTML = '<span>Invalid Lock</span>';	//
    throw new sjcl.exception.corrupt("not on the curve!");							//
  }																						//
  return p;
};

//F. Ruiz: Added the NIST 521-bit elliptic curve parameters, removed the other curves since they are not used in PassLok

sjcl.ecc.curves = {

  c521: new sjcl.ecc.curve(				//these parameters are my addition to ecc.js
	sjcl.bn.prime.p521,
	"0x5AE79787C40D069948033FEB708F65A2FC44A36477663B851449048E16EC79BF6",
	- 3,
"0x051953eb9618e1c9a1f929a21a0b68540eea2da725b99b315f3b8b489918ef109e156193951ec7e937b1652c0bd3bb1bf073573df883d2c34f1ef451fd46b503f00",
"0xc6858e06b70404e9cd9e3ecb662395b4429c648139053fb521f828af606b4d3dbaa14b5e77efe75928fe1dc127a2ffa8de3348b3c1856a429bf97e7e31c2e5bd66",
"0x11839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650")
};

//End of SJCL code, some of its elGamal, ECDSA code is used in the functions below
</script>

<!--SCRYPT key stretching-->
<script>
//SJCL-SCRYPT.JS, by joe-invincible begins
var B, X, SIZE_MAX = Math.pow(2, 32) - 1;

sjcl.misc.scrypt = function(passwd, salt, N, r, p, dkLen) {

  function flipEndian(x) {
    var first = x & 0xFF;
    var second = (x >>> 8) & 0xFF;
    var third = (x >>> 16) & 0xFF;
    var fourth = (x >>> 24) & 0xFF;
    return (first << 24) | (second << 16) | (third << 8) | fourth;
  }

  function sanityCheck() {
    if (r * p >= Math.pow(2, 30)) {
      throw "The parameters r, p must satisfy r * p < 2^30";
    }
    if ((N < 2) || (N & (N - 1) != 0)) {
      throw "The parameter N must be a power of 2.";
    }
    SIZE_MAX = Math.pow(2, 32) - 1;
    if (N > SIZE_MAX / 128 / r) {
    throw "N too big.";
    }
    if (r > SIZE_MAX / 128 / p) {
      throw "r too big.";
    }
  }

  function scrypt(passwd, salt, N, r, p, dkLen) {
    B = sjcl.misc.pbkdf2(passwd, salt, 1, p * 128 * r * 8);
    var V = [];
    var XY = [];
    for (var i = 0; i < p; i++) {
      smix(B, i * 128 * r, r, N, V, XY);
    }
    return sjcl.misc.pbkdf2(passwd, B, 1, dkLen * 8);
  };

  function salsa20_8(B) {

    function R(a, b) {
      return (a << b) | (a >>> (32 - b));
    }

    var B32 = [];
    for (var i = 0; i < 16; i++) {
      B32[i] = flipEndian(B[i]);
    }

    var x = [];
    for (var i = 0; i < 16; i++) {
      x[i] = B32[i] | 0;
    }

    for (i = 8; i > 0; i -= 2) {
      x[4] ^= R(x[0] + x[12], 7);
      x[8] ^= R(x[4] + x[0], 9);
      x[12] ^= R(x[8] + x[4], 13);
      x[0] ^= R(x[12] + x[8], 18);
      x[9] ^= R(x[5] + x[1], 7);
      x[13] ^= R(x[9] + x[5], 9);
      x[1] ^= R(x[13] + x[9], 13);
      x[5] ^= R(x[1] + x[13], 18);
      x[14] ^= R(x[10] + x[6], 7);
      x[2] ^= R(x[14] + x[10], 9);
      x[6] ^= R(x[2] + x[14], 13);
      x[10] ^= R(x[6] + x[2], 18);
      x[3] ^= R(x[15] + x[11], 7);
      x[7] ^= R(x[3] + x[15], 9);
      x[11] ^= R(x[7] + x[3], 13);
      x[15] ^= R(x[11] + x[7], 18);
      x[1] ^= R(x[0] + x[3], 7);
      x[2] ^= R(x[1] + x[0], 9);
      x[3] ^= R(x[2] + x[1], 13);
      x[0] ^= R(x[3] + x[2], 18);
      x[6] ^= R(x[5] + x[4], 7);
      x[7] ^= R(x[6] + x[5], 9);
      x[4] ^= R(x[7] + x[6], 13);
      x[5] ^= R(x[4] + x[7], 18);
      x[11] ^= R(x[10] + x[9], 7);
      x[8] ^= R(x[11] + x[10], 9);
      x[9] ^= R(x[8] + x[11], 13);
      x[10] ^= R(x[9] + x[8], 18);
      x[12] ^= R(x[15] + x[14], 7);
      x[13] ^= R(x[12] + x[15], 9);
      x[14] ^= R(x[13] + x[12], 13);
      x[15] ^= R(x[14] + x[13], 18);
    }

    for (var i = 0; i < 16; i++) {
      B32[i] = (B32[i] + x[i]) | 0;
    }

    for (var i = 0; i < 16; i++) {
      B[i] = flipEndian(B32[i]);
    }

    return B;
  }

  function blockxor(S, Si, D, Di, len) {
    len /= 4;
    Si /= 4;
    Di /= 4;
    for (var i = 0; i < len; i++) {
      D[Di + i] ^= S[Si + i] | 0;
    }
  }

  function blockcopy(S, Si, D, Di, len) {
    len /= 4;
    Si /= 4;
    Di /= 4;
    for (var i = 0; i < len; i++) {
      D[Di + i] = S[Si + i] | 0;
    }
  }

  function blockmix_salsa8(BY, Bi, Yi, r) {
    X = [];
    var i;

    blockcopy(BY, Bi + (2 * r - 1) * 64, X, 0, 64);

    for (i = 0; i < 2 * r; i++) {
        blockxor(BY, i * 64, X, 0, 64);
        salsa20_8(X);
        blockcopy(X, 0, BY, Yi + (i * 64), 64);
    }

    for (i = 0; i < r; i++) {
        blockcopy(BY, Yi + (i * 2) * 64, BY, Bi + (i * 64), 64);
    }

    for (i = 0; i < r; i++) {
        blockcopy(BY, Yi + (i * 2 + 1) * 64, BY, Bi + (i + r) * 64, 64);
    }
  }

  function smix(B, Bi, r, N, V, XY) {
    var Xi = 0;
    var Yi = 128 * r;
    var i;

    blockcopy(B, Bi, XY, Xi, Yi);

    for (i = 0; i < N; i++) {
      blockcopy(XY, Xi, V, i * Yi, Yi);
      blockmix_salsa8(XY, Xi, Yi, r);
    }

    for (i = 0; i < N; i++) {
      var j = integerify(XY, Xi, r) & (N - 1);
      blockxor(V, j * Yi, XY, Xi, Yi);
      blockmix_salsa8(XY, Xi, Yi, r);
    }

    blockcopy(XY, Xi, B, Bi, Yi);
  }

  function integerify(B, Bi, r) {
    Bi = Bi + (2 * r - 1) * 64;
    return flipEndian(B[Bi / 4]);
  }

  sanityCheck();
  return scrypt(passwd, salt, N, r, p, dkLen);
}
//SJCL-SCRYPT.JS ends
</script>

<!--main PassLok code-->

<!--this only loads two word arrays: wordlist and blacklist. Beware if the code does anything else-->
<script src="dictionary_en.js"></script>

<!--Key and Lock functions-->
<script>
//Now the ORIGINAL PASSLOK CODE BEGINS

//detect mobile and store in global Boolean variable. Learn mode detected by setlearnmode() below. Detect Basic mode. Who calls Key.
var isMobile = (typeof window.orientation != 'undefined');
var learnOn = false;
var callKey = '';
var BasicButtons = true;

//global variables used for key box expiration
var keytimer = 0;
var keytime = new Date().getTime();

//set global variables for lock DB functions
if(!("lockDB" in localStorage)) localStorage["lockDB"] = "{}";  //initialize lockDB, which is a nested object
var lockDB = JSON.parse(localStorage.lockDB);					//database in Object form
var lockNames = [''].concat(Object.keys(lockDB));				//array for finding lock names

//Regex for searching
var searchExp = new RegExp(wordlist.join("|"),"g");
var searchBlackExp = new RegExp(blacklist.join("|"),"g");

//Alphabets for base conversion. Used in making and reading the ezLok format
var BASE38in = '0123456789abcdefghijklmnopqrstuvwxyz+/';
var BASE38out = '0123456789abcdefghijkLmnopqrstuvwxyz+/';		//uses capital L, which is often hard to tell from a 1 when printed
var BASE64 = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';

//function to test key strength and come up with appropriate key stretching. Based on WiseHash
function keyStrength(pwd,display) {
	var	keymsg = document.getElementById("keymsg"),
		decoymsg = document.getElementById("decoymsg"),
		intromsg = document.getElementById("intromsg"),
		keychangemsg = document.getElementById("keychangemsg");

	var entropy = entropycalc(pwd);

	if(entropy == 0){
		var msg = 'This is a known <span style="color:magenta">bad Key!</span>',
			iter = 4096
	}else if(entropy < 10){
		var msg = '<span style="color:magenta">Terrible!</span>',
			iter = 4096
	}else if(entropy < 20){
		var msg = '<span style="color:red">Weak!</span>',
			iter = 2048
	}else if(entropy < 40){
		var msg = '<span style="color:orange">Medium</span>',
			iter = 1024
	}else if(entropy < 60){
		var msg = '<span style="color:green">Good!</span>',
			iter = 512
	}else if(entropy < 80){
		var msg = '<span style="color:blue">Great!</span>',
			iter = 256
	}else{
		var msg = '<span style="color:cyan">Overkill  !!</span>',
			iter = 2
	}
	if(pwd.trim()==''){
		if(document.getElementById("decoyIn").style.display=="block"){
			msg = 'Enter the Decoy Password below'
		}else{
			msg = 'Enter your Key below'
		}
	}else{
		if (BasicButtons){
			msg = 'Key strength: ' + msg
		}else{
			msg = 'Key entropy: ' + Math.round(entropy*100)/100 + ' bits. ' + msg
		}
	}
if(display){																//these are to display the appropriate messages
	if(document.getElementById("keyscr").style.display=="block") keymsg.innerHTML = msg;
	if(document.getElementById("decoyIn").style.display=="block") decoymsg.innerHTML = msg;
	if(document.getElementById("introscr2").style.display=="block") intromsg.innerHTML = msg;
	if(document.getElementById("keyChange").style.display=="block") keychangemsg.innerHTML = msg;
}
	return iter
};

//takes a string and calculates its entropy in bits, taking into account the kinds of characters used and parts that may be in the general wordlist (reduced credit) or the blacklist (no credit)
function entropycalc(pwd){

//find the raw Keyspace
	var numberRegex = new RegExp("^(?=.*[0-9]).*$", "g");
	var smallRegex = new RegExp("^(?=.*[a-z]).*$", "g");
	var capRegex = new RegExp("^(?=.*[A-Z]).*$", "g");
	var base64Regex = new RegExp("^(?=.*[/+]).*$", "g");
	var otherRegex = new RegExp("^(?=.*[^a-zA-Z0-9/+]).*$", "g");

	pwd = pwd.replace(/\s/g,'');										//no credit for spaces

	var Ncount = 0;
	if(numberRegex.test(pwd)){
		Ncount = Ncount + 10;
	}
	if(smallRegex.test(pwd)){
		Ncount = Ncount + 26;
	}
	if(capRegex.test(pwd)){
		Ncount = Ncount + 26;
	}
	if(base64Regex.test(pwd)){
		Ncount = Ncount + 2;
	}
	if(otherRegex.test(pwd)){
		Ncount = Ncount + 31;											//assume only printable characters
	}

//start by finding words that might be on the blacklist (no credit)
	var pwd = reduceVariants(pwd);
	var wordsFound = pwd.match(searchBlackExp);							//array containing words found on the blacklist
	if(wordsFound){
		for(var i = 0; i < wordsFound.length;i++){
			pwd = pwd.replace(wordsFound[i],'');						//remove them from the string
		}
	}

//now look for regular words on the wordlist
	wordsFound = pwd.match(searchExp);									//array containing words found on the regular wordlist
	if(wordsFound){
		wordsFound = wordsFound.filter(function(elem, pos, self) {return self.indexOf(elem) == pos;})		//remove duplicates from the list
		var foundLength = wordsFound.length;							//to give credit for words found we need to count how many
		for(var i = 0; i < wordsFound.length;i++){
			pwd = pwd.replace(new RegExp(wordsFound[i], "g"),'');									//remove all instances
		}
	}else{
		var foundLength = 0;
	}

	pwd = pwd.replace(/(.+?)\1+/g,'$1');								//no credit for repeated consecutive character groups

	if(pwd != ''){
		return (pwd.length*Math.log(Ncount) + foundLength*Math.log(wordlist.length + blacklist.length))/Math.LN2
	}else{
		return (foundLength*Math.log(wordlist.length + blacklist.length))/Math.LN2
	}
}

//take into account common substitutions, ignore spaces and case
function reduceVariants(string){
	return string.toLowerCase().replace(/[o]/g,'0').replace(/[!i]/g,'1').replace(/[z]/g,'2').replace(/[e]/g,'3').replace(/[@a]/g,'4').replace(/[$s]/g,'5').replace(/[t]/g,'7').replace(/[b]/g,'8').replace(/[g]/g,'9').replace(/[]/g,'u');
}

//add entropy as forms are manipulated, optionally reset key box after 5 minutes
function ce() {
	sjcl.random.addEntropy(Math.floor((((new Date).getMilliseconds()) * 255) / 999), 2, "loadtime");
//	if ((new Date().getTime()) - keytime > 300000 && !document.getElementById('never').checked) {
//		document.getElementById('pwd').value = '';
//	}
};

//reads Key box and stops if there's something wrong. If the timer has run out, the Key is deleted
function readKey(){
	clearTimeout(keytimer);
	var period = 300000;

//start timer to erase Key
	if(!document.getElementById('never').checked){
		keytimer = setTimeout(function() {document.getElementById('pwd').value = ''}, period);
	}
//erase key at end of period, by a different way
	if ((new Date().getTime() - keytime > period) && !document.getElementById('never').checked) document.getElementById('pwd').value = '';
    keytime = new Date().getTime();

	var key = document.getElementById('pwd').value.trim();
	if (key == ""){
		any2key();
		if(callKey == 'initkey'){
			document.getElementById("keymsg").innerHTML = '<span style="color:green"><strong>Welcome to PassLok Privacy</strong></span><br />Please enter your secret Key';
		}else{
			document.getElementById("keymsg").innerHTML = 'Please enter your secret Key';
		}
		throw ('secret Key needed')
	}
	return key
}

//reads email from its box. This is appended to the Key for public-key functions
function readEmail(){
	var email = document.getElementById('email').value.trim();
	if (email == ""){
		any2email();
		throw ('email needed')
	};
	return email
}

//checks that the Key is the same as before, resumes operation
function acceptKey(){
	var key = document.getElementById('pwd').value.trim();
	if(key.length < 4){
		document.getElementById('keymsg').innerHTML = '<span style="color:red">This Key is too short</span>';
		throw("short Key")
	}
	if(striptags(key).length == 87 || striptags(key).length == 100){
		document.getElementById('keymsg').innerHTML = '<span style="color:red">This is a Lock. Enter your Key here</span>';
		throw("lock instead of key")
	}
	if(document.getElementById('checkKey').checked && lockDB['myself']) checkKey(key);
	key2any();
}

//try decrypting the Lock in 'myself' to see if the Key is the same as the last one used
var checkingKey = false;
function checkKey(key){
	checkingKey = true;
	var myLockcrypt = lockDB['myself'][0];
	var myLockplain = keyDecrypt(key,myLockcrypt.slice(1,myLockcrypt.length));
	checkingKey = false;
	return
}

//display Lock in the lower box of the Main tab.
function showLock(){
	callKey = 'showlock';
	var mainmsg = document.getElementById("mainmsg");				//for displaying messages above key box
		mainmsg.innerHTML = "";
	if (learnOn){
		var reply = confirm("The Lock matching the Key in this box will be placed in the lower box, replacing its contents. Cancel if this is not what you want.");
		if(reply===false) return;
	};
	var mykey = readKey();
	var myemail = readEmail();
	if(lockDB['myself']){
		var mylockcrypt = lockDB['myself'][0];
		var mylock = keyDecrypt(mykey, mylockcrypt.slice(1,mylockcrypt.length));
	}else{
		var mylock = makepub(mykey,myemail);						//append email to make Lock, to combat rainbow table attack
		storemyself(mykey,mylock);
	}
	if(document.getElementById('ezLok').checked){
		mylock = changeBase(mylock, BASE64, BASE38out).match(/.{1,5}/g).join("_");
		if (document.getElementById("notags").checked == false) mylock = "PL20ezLok=" + mylock + "=PL20ezLok";
	}else{
		if (document.getElementById("notags").checked == false) mylock = "PL20lok=" + mylock + "=PL20lok"
	}
	document.getElementById('mainBox').value = mylock;
	mainmsg.innerHTML = "The Lock matching your Key is in the box. Copy or email from here.";
	callKey = ''
};

function storemyself(mykey,mylock){
	var mylockcrypt = '~' + keyEncrypt(mykey,mylock);
	var newEntry = JSON.parse('{"myself":["' + mylockcrypt + '"]}');
	lockDB = sortObject(mergeObjects(lockDB,newEntry));
	if(lockDB['myself'][3] == null) storeEmail();
	localStorage.lockDB = JSON.stringify(lockDB);
	lockNames = [''].concat(Object.keys(lockDB));
	fillList();
}

//makes the public string of a private string
function makepub(secstr,salt){
	var curve = sjcl.ecc.curves["c521"],						//make curve object
		sec = toexponent(secstr,salt),								//retrieve Key, correctly formatted as an EC exponent
	    pub = curve.G.mult(sec),								//make public key or Lock
		pubstr = sjcl.codec.base64.fromBits(pub.toBits());
	return pubstr.slice(1,88)									//strip initial "A", only x part
};

//key reformatting and stretching for secret Key (shared key is formatted automatically by sjcl) for 521 bit keys
function toexponent(string,salt){
	var iter = keyStrength(string,false);						//get number of iterations from Key strength meter, Key only
	var w = sjcl.bitArray;
	return sjcl.bn.fromBits(w.bitSlice(sjcl.misc.scrypt(string,salt,iter,8,1,66)))	//iteration number variable according to Key strength, 528 bits
};

//this one makes the shared secret
function makeshared(secstr,xstr,salt){
	var curve = sjcl.ecc.curves["c521"],
		sec = toexponent(secstr,salt),
		ystr = yfromx(curve,'A' + xstr),				      	//retrieve y coordinate from x coordinate. Add the leading zero 'A' that SJCL adds because it uses 528 bits instead of 521
		pub = curve.fromBits(sjcl.codec.base64.toBits('A'+xstr+ystr)),  //make public key object containing both x and y
		sharedsec = pub.mult(sec),
		sharedstr = sjcl.codec.base64.fromBits(sharedsec.toBits());
	return sharedstr.slice(2,88)  								//strip spurious initial "A", only x part. Strip also 2nd char so it's not mistaken for a Lock
};

function yfromx(curve,xstr){
	var x = sjcl.bn.fromBits(sjcl.codec.base64.toBits(xstr)),   //the following to retrieve y coordinate from x coordinate
		y = curve.b.add(x.mul(curve.a.add(x.square())));		//this is actually y^2, square root by special case of Tonelli-Shanks follows
	var i;
	for (i=0; i<519; i++) {
  		y = y.square();											//performs y^((p+1)/4), since p = 2^521 - 1, (p+1)/4=2^519, all is mod p
		};
	return sjcl.codec.base64.fromBits(y.toBits());
};

//this strips initial and final tags, plus spaces and non-base64 characters in the middle
function striptags(string){
	string = string.replace(/\s/g,'');															//remove spaces
	string = string.split("=").sort(function (a, b) { return b.length - a.length; })[0];		//remove tags
	string = string.replace(/[^a-zA-Z0-9+/ ]+/g, ''); 											//takes out anything that is not base64
	return string
}

//this function replaces an item with its value on the lockDB database, decrypted, if the name exists, otherwise if gives a warning that it isn't a Lock
function replaceByItem(name,warning){
	var warningList = "";
	if(lockDB[name] == null) {					//not on database; see if it's a Lock, and otherwise add to warning list
		var namestr = striptags(name);
		if(namestr.length != 87 && namestr.length != 100){
			warningList = name
		}
	} else {									//found name on DB, so get value from the database and decrypt
		var	key = readKey(),
			string = lockDB[name][0];
		string = string.slice(1,string.length);					//strip initial '~'
		var whole = keyDecrypt(key,string),
			stripped = striptags(whole);
		if(stripped.length == 87 || stripped.length == 100) {name = stripped} else {name = whole};	//if it's a Lock, strip the tags
	}

	if (warningList != '' && warning){
		var agree = confirm('The following name was not found in your local directory. If you click OK, this string will be used as a shared Key for locking and unlocking the message. This could be a serious security hazard:\n\n' + warningList);
		if (!agree) throw('list encryption terminated by user')
	}
	return name
}

//changes the base of a number. inAlpha and outAlpha are strings containing the base code for the original and target bases, as in '0123456789' for decimal
//adapted from http://snippetrepo.com/snippets/bignum-base-conversion, by kybernetikos
function changeBase(number, inAlpha, outAlpha) {
	var targetBase = outAlpha.length,
		originalBase = inAlpha.length;
    var result = "";
    while (number.length > 0) {
        var remainingToConvert = "", resultDigit = 0;
        for (var position = 0; position < number.length; ++position) {
            var idx = inAlpha.indexOf(number[position]);
            if (idx < 0) {
                throw new Error('Symbol ' + number[position] + ' from the'
                    + ' original number ' + number + ' was not found in the'
                    + ' alphabet ' + inAlpha);
            }
            var currentValue = idx + resultDigit * originalBase;
            var remainDigit = Math.floor(currentValue / targetBase);
            resultDigit = currentValue % targetBase;
            if (remainingToConvert.length || remainDigit) {
                remainingToConvert += inAlpha[remainDigit];
            }
        }
        number = remainingToConvert;
        result = outAlpha[resultDigit] + result;
    }

	//add leading zeroes in Locks
	if(targetBase == 64 && result.length < 87){
		var padding = 'AAAAAAAAAAAAAAAAAAAA'.slice(0,87 - result.length);
		result = padding + result
	} else if (targetBase == 38 && result.length < 100){
		var padding = '0000000000000000000000'.slice(0,100 - result.length);
		result = padding + result
	}
    return result;
}

//puts an 86-character randome string in the "email" boxes
function randomToken(){
	var token = sjcl.codec.base64.fromBits(sjcl.random.randomWords('17','0')).slice(0,86);
	document.getElementById('emailIntro').value = token;
	document.getElementById('email').value = token;
}
</script>

<!--cryptographic functions-->
<script>
var encrypting;		//global flag so decoy input doesn't get confused

//AES encryption process: determines the kind of encryption by looking at the radio buttons and check boxes under the main box and the length of the presumed Lock
//This function handles short mode encryption only (no List). Otherwise, Encrypt_List() is called
function Encrypt_single(){
	callKey = 'encrypt';
	var shortOn = document.getElementById("shortmode").checked,
		tagsOff = document.getElementById("notags").checked,
		signedOn = document.getElementById("signedmode").checked,
		pfsOn = document.getElementById("pfsmode").checked,
		anonOn = document.getElementById("anonmode").checked,
		mainmsg = document.getElementById("mainmsg"),
		lockmsg = document.getElementById("lockmsg"),
		name = lockmsg.innerHTML,
		clipped = false,
		secstr = document.getElementById('lockBox').value.trim();			//this will be the encrypting Lock or shared Key (if it's a name, it will be replaced with value)
	var	pubstr = striptags(secstr);
	if (secstr == ""){
		mainmsg.innerHTML = 'You must select a stored Lock, or go to the Directory tab and enter one.';
		throw("lock box empty");
	}
	var listArray = secstr.split('\n');		//see if this is actually several Locks rather than one

	if(!shortOn){								//Encrypt_single() handles only short mode, otherwise Encrypt_List() is used instead
		Encrypt_List(listArray);
		return
	}
	if (listArray.length > 1 && listArray[1].slice(0,4) != 'http'){			//this is a List, which is not compatible with short mode, video URLs on 2nd line don't count
		mainmsg.innerHTML = '<span style="color:red">Short mode not available for multiple recipients</span>';
		throw('multiple Locks for short mode')
	}
		pubstr = listArray[0].trim();					//strip video URL, if any
	var	pubstrhold = pubstr;							//to hold it, in case it is a name
	pubstr = replaceByItem(pubstr,true);				//if it's the name of a stored item, use the decrypted item instead, if not and it isn't a Lock, there will be a warning
	if (pubstr.length == 100) pubstr = changeBase(pubstr.toLowerCase(), BASE38in, BASE64) 		//ezLok replaced by regular Lock

//now we do the different encryption modes

	if(pubstr.length != 87 && !pfsOn){							//key-locked mode, if no Lock is entered
		if (learnOn){
			var reply3 = confirm("The contents of the main box will be locked with the shared Key in the Locks box, and the result will replace the main box. Cancel if this is not what you want.");
			if(reply3==false) throw("sym encryption canceled");
		};
		secstr = replaceByItem(secstr,true);
		var iter = keyStrength(secstr,false);										//get number of iterations from Key strength meter
		var iv = sjcl.codec.base64.fromBits(sjcl.random.randomWords('2','0')),		//random initialization vector, 11 chars long
			salt = makesalt(iv,37),													//salt can hide 37 chars in short mode
			text = encodeURI(document.getElementById('mainBox').value).replace(/%20/g, ' ');
		if (text.length > 58) clipped = true;
			text = text + "                                                         ";  //clip or add spaces to make a 58 char message
			text = text.slice(0,58);
		var keystr = sjcl.codec.base64.fromBits(sjcl.misc.scrypt(secstr,salt,iter,8,1,33));				//scrypt key-stretching is applied here
		var cipherj = JSON.parse(sjcl.encrypt(keystr,text,{"iv":iv,"salt":salt,"ks":256,"iter":101}));
		if (learnOn){
			alert(name + " will need to place the same Key in the Locks box to unlock the message in the main box.");
		};
		document.getElementById('mainBox').value = "@" + cipherj.iv + cipherj.salt + cipherj.ct;
		if(isMobile){																	//get ready to put into SMS
			mainmsg.innerHTML = 'Locking successful. Copy and click SMS';
			selectMain()
		}
	}

	else if (pfsOn){									//PFS mode, uses permanent storage
		if (learnOn){
			var reply3 = confirm("The contents of the main box will be locked, in PFS mode, with the item selected in the Locks box, and the result will replace the main box. Cancel if this is not what you want. Cancel if this is not what you want.");
			if(reply3==false) throw("PFS locking canceled");
		};
		var key = readKey();												//secret Key for encrypting dummy Key before storage, check before anything
		var email = readEmail();											//this contains the salt
		if (lockDB[name] == null){											//no name on message area
			if (lockDB[pubstrhold]){										//but maybe the Directory lower box contains a valid name
				name = pubstrhold
			} else {
				mainmsg.innerHTML = '<span style="color:red">Select a recipient with a valid Lock by name</span>';
				throw("invalid name")
			}
		}
		var lastLockcipher = lockDB[name][3],								//retrieve dummy Lock from storage, [0] is the permanent Lock by that name
			turnstring = lockDB[name][4];									//this strings says whose turn it is to encrypt
		if (turnstring == 'next unlock'){
			var reply4 = confirm("It's not your turn to encrypt a PFS message for " + name + ". If you click OK, the PFS conversation with this recipient may become corrupted. Cancel if this is not what you want.");
			if(reply4 == false) throw("PFS locking canceled");
			}
		if (lastLockcipher != null) {										//if dummy exists, decrypt it first
			lastLockcipher = lastLockcipher.slice(1,lastLockcipher.length);
			var lastLock = keyDecrypt(key,lastLockcipher);
		} else {
			if (pubstr.length == 87){															//use permanent Lock, minus tags, if dummy doesn't exist
				var lastLock = pubstr
			}else{
				var lastLock = makepub(pubstr,'');
			}
		}
		var newKey = sjcl.codec.base64.fromBits(sjcl.random.randomWords('17','0')).slice(0,86),	//new dummy Key
			newLock = makepub(newKey,'');
		var lastKeycipher = lockDB[name][2];								//short mode uses last Key and last Lock. The new lock is sent unencrypted
		if (lastKeycipher != null){
			lastKeycipher = lastKeycipher.slice(1,lastKeycipher.length);
			var lastKey = keyDecrypt(key,lastKeycipher);
			var pfsSalt = ''
		} else {															//use permanent Key if dummy doesn't exist
			if (pubstr.length == 87){
				var pfsSalt = email;
				var lastKey = key
			}else{
				var pfsSalt = '';
				var lastKey = pubstr
			}
		}
		var keystr = makeshared(lastKey,lastLock,pfsSalt),
			iv = sjcl.codec.base64.fromBits(sjcl.random.randomWords('2','0')),					//11 char serial in short mode, no salt
			salt = "",
			text = encodeURI(document.getElementById('mainBox').value).replace(/%20/g, ' ');
		if (text.length > 37) clipped = true;
			text = text + "                                                         ";   		//clip or add spaces to make a 37 char message
			text = text.slice(0,37);
		var cipherj = JSON.parse(sjcl.encrypt(keystr,text,{"iv":iv,"salt":salt,"ks":256,"iter": 101}));
		document.getElementById('mainBox').value = "$" + cipherj.iv + cipherj.salt + newLock + cipherj.ct;
		if(isMobile){														//prepare for SMS
			mainmsg.innerHTML = 'Locking successful. To be unlocked by ' + name + ' in PFS mode. Copy and click SMS';
			selectMain()
		}
		lockDB[name][2] = '~' + keyEncrypt(key,newKey);							//new Key is stored in the permanent database
		lockDB[name][4] = 'next unlock';
		localStorage.lockDB = JSON.stringify(lockDB);

		if(testChromeSync()){												//if Chrome sync is available, change in sync storage
			syncChromeLock(name,JSON.stringify(lockDB[name]))
		}
	}

	else if (signedOn){								//signed mode, make encryption key from secret Key and recipient's Lock
		if (learnOn){
			var reply3 = confirm("The contents of the main box will be locked with your secret secret Key and the Lock in the Locks box, and the result will replace the main box. Cancel if this is not what you want.");
			if(reply3 == false) throw("signed encryption canceled");
		};
		var key = readKey();
		var email = readEmail();
		if (lockDB[name]){
			var sharedKeycipher = lockDB[name][1];
		} else if(lockDB[pubstrhold]){
			var sharedKeycipher = lockDB[pubstrhold][1];
		}
		if (sharedKeycipher != null){
			var sharedKey = keyDecrypt(key,sharedKeycipher)
		} else {
			var sharedKey = makeshared(key,pubstr,email);								//add email to the key
			if (lockDB[name]){
				lockDB[name][1] = keyEncrypt(key,sharedKey);
				localStorage.lockDB = JSON.stringify(lockDB)

				if(testChromeSync()){											//if Chrome sync is available, change in sync storage
					syncChromeLock(name,JSON.stringify(lockDB[name]))
				}
			}
		}
		var iv = sjcl.codec.base64.fromBits(sjcl.random.randomWords('2','0')),
			salt = makesalt(iv,37),														//salt can hide 37 chars in short mode
			text = encodeURI(document.getElementById('mainBox').value).replace(/%20/g, ' ');
		if (text.length > 58) clipped = true;
			text = text + "                                                         ";  //clip or add spaces to make a 58 char message
			text = text.slice(0,58);
		var cipherj = JSON.parse(sjcl.encrypt(sharedKey,text,{"iv":iv,"salt":salt,"ks":256,"iter": 101}));
		if (learnOn){
			alert(lockmsg + " will need your Lock and his/her secret Key to unlock the message in the main box.");
		};
		document.getElementById('mainBox').value = "#" + cipherj.iv + cipherj.salt + cipherj.ct;
		if(isMobile){
			mainmsg.innerHTML = 'Locking successful. Copy and click SMS';
			selectMain()
		}
	}

	else if (anonOn){								//anonymous mode, using only the recipient's Lock
		if (learnOn){
			var reply = confirm("The contents of the main box will be locked with the Lock in the Locks box and the result will be placed in the main box. This is irreversible. Cancel if this is not what you want.");
			if(reply == false) throw("public encryption canceled");
		};
		if(name == '') name = "the recipient";
		var secstrdum = sjcl.codec.base64.fromBits(sjcl.random.randomWords('17','0')).slice(0,87),	//make dummy Key
			pubstrdum = makepub(secstrdum,'');															//makes 87 char dummy public key, initial A stripped
		var keystr = makeshared(secstrdum,pubstr,'');													//make AES key from dummy secret and recipient's public key
		var iv = sjcl.codec.base64.fromBits(sjcl.random.randomWords('2','0')),						//11 char serial in short mode, no salt
			salt = "",
			text = encodeURI(document.getElementById('mainBox').value).replace(/%20/g, ' ');
		if (text.length > 38) clipped = true;
			text = text + "                                                         ";  			//clip or add spaces to make a 38 char message
			text = text.slice(0,38);
		var cipherj = JSON.parse(sjcl.encrypt(keystr,text,{"iv":iv,"salt":salt,"ks":256,"iter": 101}));   //use 256 bit keys, min stretching for random key
		if (learnOn){
			alert(name + " will need to place his/her secret Key in the key box to unlock the message in the main box.");
		}
		document.getElementById('mainBox').value = cipherj.iv + cipherj.salt + pubstrdum + cipherj.ct;	//display adding dummy public key and anonymous tags, depending on mode
		if(isMobile){
			mainmsg.innerHTML = 'Locking successful. Copy and click SMS';
			selectMain()
		}
	}
	if (clipped) mainmsg.innerHTML = "<span style='color:orange'>The message has been truncated</span>"
	document.getElementById('decoyText').value = "";
	document.getElementById('decoyPwdIn').value = "";
	document.getElementById('decoyPwdOut').value = "";
	callKey = '';
};

//encrypts for a list of recipients. First makes a 256-bit message key, then gets the Lock or shared Key for each recipient and encrypts the message key with it
//the output string contains each encrypted key along with 66 bits of an encrypted form of the recipient's item, so he/she can find the right encrypted key
function Encrypt_List(listArray){
	var shortOn = document.getElementById("shortmode").checked,
		tagsOff = document.getElementById("notags").checked,
		signedOn = document.getElementById("signedmode").checked,
		pfsOn = document.getElementById("pfsmode").checked,
		anonOn = document.getElementById("anonmode").checked,
		mainmsg = document.getElementById("mainmsg"),
		lockmsg = document.getElementById("lockmsg");
	if(shortOn){
		mainmsg.innerHTML = '<span style="color:red">Short mode not available for multiple recipients</span>'
		throw('short mode not available')
	}

	var warningList = "";
	for (var index = 0; index < listArray.length; index++){									//scan lines and pop a warning if some are not names on DB or aren't Locks
		var name = listArray[index].trim();
		if (name.slice(0,4)=='http') {
			listArray[index] = '';
			name = ''
		}
		if (name != ''){
			if(lockDB[name] == null) {					//not on database; see if it's a Lock, and otherwise add to warning list
				var namestr = striptags(name);
				if(namestr.length != 87 && namestr.length != 100){
					if (warningList==""){warningList = name} else {warningList = warningList + '\n' + name}
				}
			}
		}
	}
	if (warningList != ''){
		var agree = confirm('The names on the list below were not found in your local directory. If you click OK, they will be used as shared Keys for locking and unlocking the message. This could be a serious security hazard:\n\n' + warningList);
		if (!agree) throw('list encryption terminated by user')
	}

	var	msgkey = sjcl.codec.base64.fromBits(sjcl.random.randomWords('8','0')).slice(0,43),		//message key a little over 256-bit
		iv = sjcl.codec.base64.fromBits(sjcl.random.randomWords('4','0')),
		text = document.getElementById('mainBox').value;

	if (anonOn) {
		if (learnOn){
			var reply = confirm("The contents of the main box will be anonymously locked with the Locks of the recipients listed, so that all of them can read it with their respective Keys, and the result will replace the main box. Cancel if this is not what you want.");
			if(reply == false) throw("anonymous list encryption canceled");
		}
		var salt = makesalt(iv,87);										//salt hides 87 chars in anonymous, 152 otherwise. Tags are different, too
		if(tagsOff){														//initial tag
			var outString = "!"
		} else {
			var outString = "PL20msa=!"
		}
	} else if(pfsOn){
		if (learnOn){
			var reply = confirm("The contents of the main box will be locked in PFS mode with the Locks of the recipients listed, so that all of them can read it with their respective Keys, and the result will replace the main box. Cancel if this is not what you want.");
			if(reply == false) throw("anonymous list encryption canceled");
		}
		var salt = makesalt(iv,87);
		if(tagsOff){
			var outString = "$"
		} else {
			var outString = "PL20msp=$"
		}
	} else {
		if (learnOn){
			var reply = confirm("The contents of the main box will be locked with the Locks of the recipients listed and signed with your Key, so that all of them can read it by supplying your Lock, and the result will replace the main box. Cancel if this is not what you want.");
			if(reply == false) throw("signed list encryption canceled");
		}
		var salt = makesalt(iv,152);
		if(tagsOff){
			var outString = "#"
		} else {
			var outString = "PL20mss=#"
		}
	}
	var cipherj = JSON.parse(sjcl.encrypt(msgkey,text,{"iv":iv,"salt":salt,"ks":256,"iter":101}));		 //main encryption event, but don't add it yet
	outString = outString + cipherj.iv + cipherj.salt;

	if (anonOn) {															//for anonymous mode, make dummy Lock and add it to the output string
		var secstrdum = sjcl.codec.base64.fromBits(sjcl.random.randomWords('17','0')).slice(0,87),
			pubstrdum = makepub(secstrdum,'');
		outString = outString + pubstrdum
	}

	//for each item on the List (unless empty), encrypt the message key and add it, prefaced by the first 256 bits of the ciphertext when the item is encrypted with message iv and salt, and the shared key
	for (var index = 0; index < listArray.length; index++){
		var name = listArray[index].trim();
		if (name != ''){
			if(lockDB[name] != null) {										//get item from the lockDB database and decrypt it before using it
				if (key == null) var key = readKey();
				var string = lockDB[name][0],
					secstr = keyDecrypt(key,string.slice(1,string.length));
			} else var secstr = name;										//allow for adding items directly to the List, now strip tags to see if it's a Lock
			var pubstr = striptags(secstr);
			if (pubstr.length == 100) pubstr = changeBase(pubstr.toLowerCase(), BASE38in, BASE64) 		//get Lock from ezLok
			if (pubstr.length == 87  || pfsOn){							//if it's a Lock, do anonymous, PFS or signed encryption, and add the result to the output
			
				if (signedOn){
					if (key == null) var key = readKey();
					var email = readEmail();
					if(lockDB[name]!=null){
						var sharedKeycipher = lockDB[name][1];			//permanent key shared with recipient, for encrypting the new dummy Lock
						if (sharedKeycipher != null){
							var sharedKey = keyDecrypt(key,sharedKeycipher);
						} else {
							var sharedKey = makeshared(key,pubstr,email);
							lockDB[name][1] = keyEncrypt(key,sharedKey);
						}
					} else {
						var sharedKey = makeshared(key,pubstr,email)
					}
					var	cipherj2 = JSON.parse(sjcl.encrypt(sharedKey,msgkey,{"iv":iv,"salt":salt,"ks":256,"iter": 101})),
						idtag = JSON.parse(sjcl.encrypt(sharedKey,pubstr,{"iv":iv,"salt":salt,"ks":256,"iter": 101}));

				} else if (anonOn){
					var sharedKey = makeshared(secstrdum,pubstr,'');
					var	cipherj2 = JSON.parse(sjcl.encrypt(sharedKey,msgkey,{"iv":iv,"salt":salt,"ks":256,"iter": 101})),
						idtag = JSON.parse(sjcl.encrypt(sharedKey,pubstr,{"iv":iv,"salt":salt,"ks":256,"iter": 101}));

				} else if (pfsOn){
					if(lockDB[name] == null){
						if(lockDB[lockmsg.innerHTML] != null && listArray.length == 1){
							name = lockmsg.innerHTML
						} else {
							mainmsg.innerHTML = 'In PFS mode, recipient Locks must be stored';
							throw('name not on lockDB')
						}
					}
					if (key == null) var key = readKey();
					var email = readEmail();
					var dualKeycipher = lockDB[name][1],
						turnstring = lockDB[name][4];
					if (turnstring=='next unlock'){
						var reply4 = confirm("It's not your turn to lock a PFS message for " + name + ". If you click OK, the PFS conversation with this recipient may become corrupted. Cancel if this is not what you want.");
						if(reply4 == false) throw("PFS locking canceled");
					}
					if (pubstr.length == 87){
						if (dualKeycipher != null){
							var dualKey = keyDecrypt(key,dualKeycipher);
						} else {
							var dualKey = makeshared(key,pubstr,email);
							lockDB[name][1] = keyEncrypt(key,dualKey);
						}
						var pfsSalt = ''
					}else{
						var dualKey = secstr;
						var pfsSalt = ''
					}
					var lastLockcipher = lockDB[name][3];					//retrieve dummy Lock from storage, [0] is the permanent Lock by that name
					if (lastLockcipher != null) {								//if dummy exists, decrypt it first
						lastLockcipher = lastLockcipher.slice(1,lastLockcipher.length);
						var lastLock = keyDecrypt(key,lastLockcipher);
					} else {													//use permanent Lock, minus tags, if dummy doesn't exist
						if (pubstr.length == 87){
							var lastLock = pubstr
						}else{
							var lastLock = makepub(secstr,'');
						}
					}
					var secstrdum = sjcl.codec.base64.fromBits(sjcl.random.randomWords('17','0')).slice(0,87),		//different dummy key for each recipient
						pubstrdum = makepub(secstrdum,'');
					var sharedKey = makeshared(secstrdum,lastLock,pfsSalt);
					lockDB[name][2] = '~' + keyEncrypt(key,secstrdum);				//new Key is stored in the permanent database
					lockDB[name][4] = 'next unlock';
					localStorage.lockDB = JSON.stringify(lockDB);

					if(testChromeSync()){										//if Chrome sync is available, change in sync storage
						syncChromeLock(name,JSON.stringify(lockDB[name]))
					}
				//sharedKey depends on the newLock, so use the permanent shared Key instead for making the idtag and encrypting the newLock
					var	cipherj2 = JSON.parse(sjcl.encrypt(sharedKey,msgkey,{"iv":iv,"salt":salt,"ks":256,"iter": 101})),
						idtag = JSON.parse(sjcl.encrypt(dualKey,pubstr,{"iv":iv,"salt":salt,"ks":256,"iter": 101})),
						newLockcipher = JSON.parse(sjcl.encrypt(dualKey,pubstrdum,{"iv":iv,"salt":salt,"ks":256,"iter": 101}));
				}
				
			} else {														//if it's not a Lock, do a symmetric encryption instead, with appropriate key stretching
				var iter = keyStrength(secstr,false),
					keyStretched = sjcl.codec.base64.fromBits(sjcl.misc.scrypt(secstr,salt,iter,8,1,33)),
					cipherj2 = JSON.parse(sjcl.encrypt(keyStretched,msgkey,{"iv":iv,"salt":salt,"ks":256,"iter":101})),
					idtag = JSON.parse(sjcl.encrypt(secstr,secstr,{"iv":iv,"salt":salt,"ks":256,"iter":101}));
			}
			if (pfsOn){
				outString = outString + '%' + idtag.ct.slice(0,11) + '%' + newLockcipher.ct + cipherj2.ct;
			} else {
				outString = outString + '%' + idtag.ct.slice(0,11) + '%' + cipherj2.ct;
			}
		}
	}

	//finish off by adding the encrypted message and tags
	outString = outString + '%' + cipherj.ct
	if (tagsOff) {
			document.getElementById('mainBox').value = outString
	} else {
		if(anonOn){
			document.getElementById('mainBox').value = outString + "=PL20msa"
		} else if(pfsOn){
			document.getElementById('mainBox').value = outString + "=PL20msp"
		} else {
			document.getElementById('mainBox').value = outString + "=PL20mss"
		}
	}
	mainmsg.innerHTML = 'Locking successful. Select and copy.'
	callKey = '';
}

//decrypts a string encrypted with the secret Key, 11 char serial, no salt, variable key stretching
function keyDecrypt(key,cipherstring){
	var	iv = cipherstring.slice(0,11),
		ct = cipherstring.slice(11,cipherstring.length),
		iter = keyStrength(key,false);
	var keyStretched = sjcl.codec.base64.fromBits(sjcl.misc.scrypt(key,'',iter,8,1,33));
	var cipherstr2 = '{"iv":"' + iv + '","salt":"' + '' + '","ct":"' + ct + '","ks":256,"iter":101}';
	return sjcl.decrypt(keyStretched,cipherstr2)
}

//encrypts a string with the secret Key, 11 char serial, no salt, variable key stretching
function keyEncrypt(key,plainstring){
	var	iv = sjcl.codec.base64.fromBits(sjcl.random.randomWords('2','0')),				//minimum iterations = 101
		iter = keyStrength(key,false);
	var keyStretched = sjcl.codec.base64.fromBits(sjcl.misc.scrypt(key,'',iter,8,1,33));
	var cipherj2 = JSON.parse(sjcl.encrypt(keyStretched,plainstring,{"iv":iv,"salt":"","ks":256,"iter":101}));
	return cipherj2.iv + cipherj2.ct
}

//encrypts a hidden message into the salt value used by regular encryption, or makes a random salt also encoded by AES so it's indistinguishable
function makesalt(iv,leng){
	if (document.getElementById("decoymode").checked){
		if (learnOn){
			var reply = confirm("You are adding a hidden message in Decoy mode. Cancel if this is not what you want, then uncheck Decoy mode below.");
			if(reply == false) throw("decoy encryption canceled");
		};
		if ((document.getElementById('decoyPwdIn').value.trim() == "")||(document.getElementById('decoyText').value.trim() == "")){ //stop to display the decoy entry form if there is no hidden message or key
			document.getElementById("decoyIn").style.display = "block";				//display decoy form, and back shadow
			document.getElementById("shadow").style.display = "block";
			if(!isMobile) document.getElementById('decoyText').focus();
			throw ("stopped for decoy input")
		}
		var key = document.getElementById('decoyPwdIn').value,
			text = encodeURI(document.getElementById('decoyText').value.replace(/%20/g, ' ')),
			iter = keyStrength(key,false);												//key may be weak, so stretch it
	} else {																				//no decoy mode, so salt comes from random text and key, no extra stretching
		var key = sjcl.codec.base64.fromBits(sjcl.random.randomWords('8','0')),
			text = sjcl.codec.base64.fromBits(sjcl.random.randomWords('57','0')).slice(0,214),
			iter = 2;
	};
	while (text.length < leng) {															//clip or add spaces to make the number of characters required
			text = text + "          ";
		};
		text = text.slice(0,leng);
		var keyStretched = sjcl.codec.base64.fromBits(sjcl.misc.scrypt(key,'',iter,8,1,33));
		var cipherj = JSON.parse(sjcl.encrypt(keyStretched,text,{"iv":iv,"salt":"","ks":256,"iter":101}));
		document.getElementById('decoyPwdIn').value = "";
		document.getElementById('decoyText').value = "";
		return cipherj.ct;
};

//AES decryption process: determines which kind of encryption by looking at first character after the initial tag. Calls Encrypt_single as appropriate
function Decrypt_single(){
	callKey = 'decrypt';
	encrypting = true;
	var decoyOn = document.getElementById("decoymode").checked,
		keymsg = document.getElementById("keymsg"),
		mainmsg = document.getElementById("mainmsg"),
		lockmsg = document.getElementById("lockmsg");
	keymsg.innerHTML = "";
	mainmsg.innerHTML = "";
	if(document.getElementById('lockBox').value.slice(0,1) == '~') decryptItem();	//if Lock or shared Key is encrypted, decrypt it
	var name = lockmsg.innerHTML,
		cipherstr = document.getElementById('mainBox').value.trim(),
		secstr = document.getElementById('lockBox').value.trim();
	if (cipherstr == ""){																//if the main box is empty, display a warning
		mainmsg.innerHTML = 'Nothing to lock or unlock';
		throw("main box empty");
	};
	cipherstr = cipherstr.split("=").sort(function (a, b) { return b.length - a.length; })[0];   //remove end tags

	//here detect if the message is for multiple recipients, and if so call the appropriate function
	var cipherArray = cipherstr.split('%');
	if(cipherArray.length > 3){
		if (cipherArray[1].length == 11){
			Decrypt_List(cipherArray);
			return
		}
	}

	var pubstr = striptags(secstr);													//this holds a Lock or shared Key (or a name leading to it)
	var type = cipherstr.slice(0,1);													//get encryption type. !=public, @=symmetric, #=signed, ~=Key-encrypted
		cipherstr = cipherstr.replace(/[^a-zA-Z0-9+/ ]+/g, '');					//remove anything that is not base64

	if (cipherstr.length == 160){					//short anonymous decryption
		if (learnOn){
			var reply = confirm("The short message in the main box was locked with your personal Lock, and will now be unlocked if your secret Key has been entered, replacing the locked message. Cancel if this is not what you want.");
			if(reply == false) throw("public decryption canceled");
		};																		//make sure there is no List in Lock box
		var key = readKey();
		var email = readEmail();
		var	iv = cipherstr.slice(0,11),												//get iv, salt, and later ct data and public key
			salt = "";
		var pubstrdum = cipherstr.slice(11,98);
		var keystr = makeshared(key,pubstrdum,email);
		var	ct = cipherstr.slice(98,cipherstr.length);
		cipherstr = '{"iv":"' + iv + '","salt":"' + salt + '","ct":"' + ct + '","ks":256,"iter":101}';	//add labels and keylength to data, minimum keystretching
		document.getElementById('mainBox').value = decodeURI(sjcl.decrypt(keystr,cipherstr)).trim();
		if(!decoyOn) mainmsg.innerHTML = 'Unlock successful'
	}

	else if (type == "~"){																//secret Key encrypted item, such as a complete lockDB database
		if (learnOn){
			var reply = confirm("The message in the main box was locked with your secret Key, and will now be unlocked if your secret Key has been entered. If it is a database it will be placed in the Locks screen so you can merge it into the stored database. If it contains settings, they will replace your current setings, including the email/token.  Cancel if this is not what you want.");
			if(reply == false) throw("secret Key decryption canceled");
		};
		var key = readKey();
		document.getElementById('lockBox').value = keyDecrypt(key,cipherstr);
		if(document.getElementById('lockBox').value.slice(0,6) == 'myself'){		//string contains settings; add them after confirmation

			var reply = confirm("If you click OK, the settings from the backup will replace the current settings, possibly including a random token. This cannot be undone.");
			if (reply == false) throw("settings restore canceled");

			mergeLockDB();
			document.getElementById("mainmsg").innerHTML = 'The settings have been replaced with those in this backup';
			document.getElementById('lockBox').value = ''
		}else{																		//stored local directory; display so it can be edited
			document.getElementById("lockmsg").innerHTML = 'Extracted items. Click <strong>Merge</strong> to add them to the local directory.';
			main2lock();
		}
	}

	else if (type == "$"){							//PFS decryption
		if (learnOn){
			var reply = confirm("The message in the main box was locked in PFS mode with your personal Lock and will now be unlocked, replacing the locked message, if your secret Key has been entered. Cancel if this is not what you want.");
			if(reply == false) throw("public decryption canceled");
		};
			noList();
		if (lockDB[name] == null){														//no single name selected
			name = pubstr;
			if (lockDB[name] == null){													//try again using the string in the lockBox as name
				mainmsg.innerHTML = '<span style="color:red">Select a sender with a valid Lock</span>';
				throw("invalid name")
			}
			pubstr = replaceByItem(pubstr,false);										//put Lock in box, ready to go
			if (pubstr.length == 100) pubstr = changeBase(pubstr.toLowerCase(), BASE38in, BASE64)
		}
		var key = readKey();
		var email = readEmail();
		var lastKeycipher = lockDB[name][2],											//retrieve dummy Key from storage, [0] is the permanent Lock by that name
			turnstring = lockDB[name][4];												//this strings says whose turn it is to encrypt
		if (turnstring=='next lock'){
			var reply4 = confirm("It's not your turn to decrypt a PFS message from " + name + ". If you click OK, the PFS conversation with this sender may become corrupted. Cancel if this is not what you want.");
			if(reply4 == false) throw("PFS unlock canceled");
		}
		if (lastKeycipher != null) {
			lastKeycipher = lastKeycipher.slice(1,lastKeycipher.length);
			var lastKey = keyDecrypt(key,lastKeycipher);
			var pfsSalt = ''
		} else {																		//if it doesn't exist, use permanent Key
			if (pubstr.length == 87){
				var lastKey = key;
				var pfsSalt = email
			}else{
				var lastKey = pubstr;
				var pfsSalt = ''
			}
		}
		var lastLockcipher = lockDB[name][3];											//short mode uses last Key and last Lock
		if (lastLockcipher != null) {													//if dummy exists, decrypt it first
			lastLockcipher = lastLockcipher.slice(1,lastLockcipher.length);
			var lastLock = keyDecrypt(key,lastLockcipher)
		} else {																		//use permanent Lock, minus tags, if dummy doesn't exist
			if (pubstr.length != 87 && pubstr.length != 100){
				if(lockDB[pubstr]) pubstr = replaceByItem(pubstr,false)					//if it's a name, get the actual Lock
			}
			if (pubstr.length == 100) pubstr = changeBase(pubstr.toLowerCase(), BASE38in, BASE64) 		//get Lock from ezLok
			if (pubstr.length == 87){
				var lastLock = pubstr;
			}else{
				var lastLock = makepub(pubstr,'')
			}
		}
		var	iv = cipherstr.slice(0,11),
			salt = "",
			newLock = cipherstr.slice(11,98),
			ct = cipherstr.slice(98,cipherstr.length),
			keystr = makeshared(lastKey,lastLock,pfsSalt),
			cipherstr2 = '{"iv":"' + iv + '","salt":"' + salt + '","ct":"' + ct + '","ks":256,"iter":101}';
		document.getElementById('mainBox').value = decodeURI(sjcl.decrypt(keystr,cipherstr2)).trim();
		if (!decoyOn) mainmsg.innerHTML = 'Unlock successful. You can read this only once.'
		lockDB[name][3] = '~' + keyEncrypt(key,newLock);
		lockDB[name][4] = 'next lock';
		localStorage.lockDB = JSON.stringify(lockDB);

		if(testChromeSync()){															//if Chrome sync is available, change in sync storage
			syncChromeLock(name,JSON.stringify(lockDB[name]))
		}
	}

	else if (type == "#"){							//signed decryption
		if (learnOn){
			var reply = confirm("The message in the main box was locked with your Lock and the sender's Key, and will now be unlocked, replacing the locked message, if your secret Key has been entered. Cancel if this is not what you want.");
			if(reply == false) throw("signed decryption canceled");
		};
			noList();
		if (pubstr == ''){
			mainmsg.innerHTML = "<span style='color:red'>Identify the sender or enter his/her Lock</span>";
			throw("lock box empty");
		}
		var key = readKey();
		var email = readEmail();
		if (lockDB[name] == null){
			name = pubstr;																//try again using the string in the lockBox as name
		}
		if (lockDB[name]) var sharedKeycipher = lockDB[name][1];
		if (sharedKeycipher != null){
			var sharedKey = keyDecrypt(key,sharedKeycipher)
		} else {
			pubstr = replaceByItem(pubstr,false);
			if (pubstr.length == 100) pubstr = changeBase(pubstr.toLowerCase(), BASE38in, BASE64) 		//replace ezLok with standard
			var sharedKey = makeshared(key,pubstr,email)
			if (lockDB[name]) {
				lockDB[name][1] = keyEncrypt(key,sharedKey);
				localStorage.lockDB = JSON.stringify(lockDB);

				if(testChromeSync()){													//if Chrome sync is available, change in sync storage
					syncChromeLock(name,JSON.stringify(lockDB[name]))
				}
			}
		}
		var	iv = cipherstr.slice(0,11),
			salt = cipherstr.slice(11,71),
			ct = cipherstr.slice(71,cipherstr.length);
		if (decoyOn) decoydecrypt(iv,salt);
		var cipherstr2 = '{"iv":"' + iv + '","salt":"' + salt + '","ct":"' + ct + '","ks":256,"iter":101}';
		if (cipherstr.length == 159){
			document.getElementById('mainBox').value = decodeURI(sjcl.decrypt(sharedKey,cipherstr2)).trim();
			if (!decoyOn) mainmsg.innerHTML = 'Unlock successful'
		}else{
			document.getElementById('mainBox').value = decodeURI(sjcl.decrypt(sharedKey,cipherstr2));
			if (!decoyOn) mainmsg.innerHTML = 'Unlock successful'
		}
	}

	else if (type == "@"){							//symmetric decryption
		if (learnOn){
			var reply2 = confirm("The message in the main box was locked with a shared Key, and will now be unlocked if the same Key is present in the Locks box. The result will replace the locked message. Cancel if this is not what you want.");
			if(reply2 == false) throw("sym decryption canceled");
		};
			noList();																	//shared Key can't be multi-line
		if (secstr == ''){
			mainmsg.innerHTML = '<span style="color:red">Enter shared Key</span>';
			throw("symmetric key empty");
		}
		secstr = replaceByItem(secstr,false);										//if it's a name in the box, get the real item
		var	iv = cipherstr.slice(0,11),
			salt = cipherstr.slice(11,71),
			ct = cipherstr.slice(71,cipherstr.length);
		var keystr = secstr;
		if (decoyOn) decoydecrypt(iv,salt);
		var iter = keyStrength(keystr,false);										//get number of iterations from Key strength meter
		var keystr=sjcl.codec.base64.fromBits(sjcl.misc.scrypt(keystr,salt,iter,8,1,33));
		var cipherstr2 = '{"iv":"' + iv + '","salt":"' + salt + '","ct":"' + ct + '","ks":256,"iter":101}';
		document.getElementById('mainBox').value = decodeURI(sjcl.decrypt(keystr,cipherstr2)).trim();
		if (!decoyOn) mainmsg.innerHTML = 'Unlock successful'
	}else{
		Encrypt_single()																//none of the known encrypted types, therefore encrypt rather than decrypt
	};
	callKey = '';
};

//deletes the Lock box if there is a List in there. Used in decryption, since sometimes that box needs to hold a single Lock, shared key, or name
function noList(){
	var array = document.getElementById('lockBox').value.trim().split('\n');
	if(array.length > 1 && array[1].slice(0,4) != 'http') document.getElementById('lockBox').value = '';		//2nd line might be a video URL
}

//decrypts a message encrypted for multiple recipients. Encryption can be signed, anonymous, or symmetric
function Decrypt_List(cipherArray){
	encrypting = true;
	var decoyOn = document.getElementById("decoymode").checked,
		keymsg = document.getElementById("keymsg"),
		mainmsg = document.getElementById("mainmsg"),
		lockmsg = document.getElementById("lockmsg");
	keymsg.innerHTML = "";
	mainmsg.innerHTML = "";
	var name = lockmsg.innerHTML,
		type = cipherArray[0].slice(0,1);													//type is 1st character
	for (var i=0; i < cipherArray.length; i++){
		cipherArray[i] = cipherArray[i].replace(/[^a-zA-Z0-9+/ ]+/g, '')				//take out anything that is not base64
	}
	var iv = cipherArray[0].slice(0,22);
	if (type == '!' || type == '$') {														//anonymous of PFS, shorter salt because of the dummy Lock
		var salt = cipherArray[0].slice(22,149),
			pubstrdum = cipherArray[0].slice(149,236)									//dummy Lock
	} else {
		var salt = cipherArray[0].slice(22,236)
	}
	if (decoyOn) decoydecrypt(iv,salt);													//decoy decryption
	noList();																				//no List allowed in Lock box. Only one item, if that
	var ct = cipherArray[cipherArray.length - 1],										//exclude the type flag
		secstr = document.getElementById('lockBox').value.trim(),						//should be Lock or shared Key, maybe a name
		secstrhold = secstr;
	secstr = replaceByItem(secstr,false);												//if it's a name, replace it with the decrypted item, no warning
	var	pubstr = striptags(secstr);
	if (pubstr.length == 100) pubstr = changeBase(pubstr.toLowerCase(), BASE38in, BASE64) 				//ezLok case

	if(lockDB['myself'] == null) key2any();												//make this entry if it has been deleted

	//now make the idtag to be searched for, depending on the type of encryption. First the shared Key that encrypts the idtag

	if (type == '#' || type == '$'){				//signed mode first, PFS is the same at this point
		if (learnOn){
			var reply = confirm("The contents of the message in the main box will be unlocked with your secret Key, provided the sender's Lock or shared Key are in the in the Locks box. Cancel if this is not what you want.");
			if(reply == false) throw("signed list decryption canceled");
		}
		if (pubstr == ''){
			mainmsg.innerHTML = "<span style='color:red'>Enter the sender's Lock or shared Key</span>";
			throw("lock box empty");
		}
		if (key == null) var key = readKey();
		var email = readEmail();
		if (pubstr.length == 87){															//assuming this is a Lock, not a shared Key. See below for the other case
			if (lockDB[name]){																//get permanent shared Key from storage, or make it if not stored
				var sharedKeycipher = lockDB[name][1];
			}else if(lockDB[secstrhold]){													//get name from Lock box instead of message
				name = secstrhold;
				var sharedKeycipher = lockDB[name][1];
			}
			if (sharedKeycipher != null){
				var sharedKey = keyDecrypt(key,sharedKeycipher)
			} else {																		//no shared key found, so making a new one
				var sharedKey = makeshared(key,pubstr,email);
				if (lockDB[name]) {
					lockDB[name][1] = keyEncrypt(key,sharedKey);
					localStorage.lockDB = JSON.stringify(lockDB);

					if(testChromeSync()){													//if Chrome sync is available, change in sync storage
						syncChromeLock(name,JSON.stringify(lockDB[name]))
					}
				}
			}
			var string = lockDB['myself'][0];
			secstr = keyDecrypt(key,string.slice(1,string.length));							//this contains my Lock
		} else {																			//assuming it's a regular shared Key in common with the sender
			var sharedKey = secstr;
		}

	} else {										//anonymous mode
		if (learnOn){
			var reply = confirm("The contents of the message in the main box will be unlocked with your secret Key. Cancel if this is not what you want.");
			if(reply===false) throw("anonymous list decryption canceled");
		}
		if (pubstr.length == 87 || pubstr == '' || pubstr.split('\n').length > 1){		//test for Lock, empty, multiline(has video URL, since Lists have been filtered by now)
			if (key == null) var key = readKey();
			var email = readEmail();
			var sharedKey = makeshared(key,pubstrdum,email),
				string = lockDB['myself'][0];
			secstr = keyDecrypt(key,string.slice(1,string.length));
		} else {																		//use a shared Key instead
			var sharedKey = secstr	;
		}
	}
	var iter = keyStrength(sharedKey,false);										//should be 2 for everything except bad shared Keys
	var keyStretched = sjcl.codec.base64.fromBits(sjcl.misc.scrypt(sharedKey,salt,iter,8,1,33));
	var	idtag = JSON.parse(sjcl.encrypt(sharedKey,secstr,{"iv":iv,"salt":salt,"ks":256,"iter":101})).ct.slice(0,11);
	
	//look for the id tag and return the string that follows it
	for (i = 1; i < cipherArray.length; i++){
		if (idtag == cipherArray[i]) {
			var msgkeycipher = cipherArray[i+1];
		}
	}
	if(typeof msgkeycipher == 'undefined'){
		mainmsg.innerHTML = 'No message found for you';
		throw('idtag not found')
	}
	//got the encrypted message key, now decrypt it, and finally the main message. The process for PFS mode is more involved
	if (pubstr.length != 87 && pubstr.length != 0 && type != '$'){
		var keyStretched = sjcl.codec.base64.fromBits(sjcl.misc.scrypt(sharedKey,salt,iter,8,1,33))
		var cipherstr2 = '{"iv":"' + iv + '","salt":"' + salt + '","ct":"' + msgkeycipher + '","ks":256,"iter":101}',
			msgkey = sjcl.decrypt(keyStretched,cipherstr2).trim();
	} else if (type != '$'){
		var cipherstr2 = '{"iv":"' + iv + '","salt":"' + salt + '","ct":"' + msgkeycipher + '","ks":256,"iter":101}',
			msgkey = sjcl.decrypt(sharedKey,cipherstr2).trim();

	//for PFS mode, first we separate the encrypted new Lock from the proper message key, then decrypt the new Lock and combine it with the stored Key (if any) to get the ephemeral shared Key, which unlocks the message Key
	} else {
		var newLockcipher = msgkeycipher.slice(0,127);
		msgkeycipher = msgkeycipher.slice(127,msgkeycipher.length);
		var cipherstr2 = '{"iv":"' + iv + '","salt":"' + salt + '","ct":"' + newLockcipher + '","ks":256,"iter":101}',
			newLock = sjcl.decrypt(sharedKey,cipherstr2).trim();
		if(!lockDB[name]) name = secstrhold;													//if the name is not displayed, try with the content of the lock box
		if(!lockDB[name]){																	//if it still doesn't work, message and bail out
			mainmsg.innerHTML = 'The sender must be in the directory';
			throw('sender not in directory')
		}
		var lastKeycipher = lockDB[name][2],												//retrieve dummy Key from storage
			turnstring = lockDB[name][4];													//this strings says whose turn it is to encrypt
		if (turnstring=='next lock'){
			var reply4 = confirm("It's not your turn to decrypt a PFS message from " + name + ". If you click OK, the PFS conversation with this sender may become corrupted. Cancel if this is not what you want.");
			if(reply4===false) throw("PFS unlock canceled");
		}
		if (lastKeycipher != null) {
			lastKeycipher = lastKeycipher.slice(1,lastKeycipher.length);
			var lastKey = keyDecrypt(key,lastKeycipher);
			var pfsSalt = ''
		} else {																			//if a dummy Key doesn't exist, use permanent Key
			if (pubstr.length == 87){
				var lastKey = key;
				var pfsSalt = email
			}else{
				var lastKey = secstr;
				var pfsSalt = ''
			}
		}
		var	keystr = makeshared(lastKey,newLock,pfsSalt),
			cipherstr2 = '{"iv":"' + iv + '","salt":"' + salt + '","ct":"' + msgkeycipher + '","ks":256,"iter":101}';
		var	msgkey = sjcl.decrypt(keystr,cipherstr2).trim();
		lockDB[name][3] = '~' + keyEncrypt(key,newLock);										//store the new dummy Lock
		lockDB[name][4] = 'next lock';
		localStorage.lockDB = JSON.stringify(lockDB);

		if(testChromeSync()){																//if Chrome sync is available, change in sync storage
			syncChromeLock(name,JSON.stringify(lockDB[name]))
		}
	}
	var cipherstr = '{"iv":"' + iv + '","salt":"' + salt + '","ct":"' + ct + '","ks":256,"iter":101}';
	document.getElementById('mainBox').value = sjcl.decrypt(msgkey,cipherstr);
	if (!decoyOn) mainmsg.innerHTML = 'Unlock successful';
	callKey = '';
}

//decrypt the message hidden in the salt, for decoy mode
function decoydecrypt(iv,ct){
	var mainmsg = document.getElementById("mainmsg");
	mainmsg.innerHTML = "";
	if (learnOn){
		var	key2 = prompt("Decoy mode is selected, so please write the Password used to lock the hidden message. If you don't expect a hidden message, uncheck Decoy mode below.");
	} else {
	if (document.getElementById('decoyPwdOut').value.trim() == ""){					//stop to display the decoy key entry form if there is no key entered
		document.getElementById("decoyOut").style.display = "block";
		document.getElementById("shadow").style.display = "block";
		if(!isMobile) document.getElementById('decoyPwdOut').focus();
		throw ("stopped for decoy input")
	}
	var key2 = document.getElementById('decoyPwdOut').value,
		iter = keyStrength(key2,false);
	document.getElementById('decoyPwdOut').value = ""
	};
	var keyStretched = sjcl.codec.base64.fromBits(sjcl.misc.scrypt(key2,'',iter,8,1,33))
	var	cipherstr2 = '{"iv":"' + iv + '","salt":"' + "" + '","ct":"' + ct + '","ks":256,"iter":101}';
	mainmsg.innerHTML = 'Hidden message: <span style="color:blue">' + decodeURI(sjcl.decrypt(keyStretched,cipherstr2)) + '</span>'
};

//takes a SHA512 hash of the plaintext and generates an ECDSA signature
function Signhash(){
	callKey = 'sign';
	var keymsg = document.getElementById("keymsg"),
		mainmsg = document.getElementById("mainmsg");
		keymsg.innerHTML = "";
		mainmsg.innerHTML = "";
	if (learnOn){
		var reply = confirm("A signature matching the contents of the main box will be made using your secret Key, and the resulting signature will be added to the end of the main box. Cancel if this is not what you want.");
		if(reply == false) throw("signature canceled");
	};
	var secstr = readKey();
	var email = readEmail();
	var pubstr = striptags(secstr),
		hash = sjcl.hash.sha512.hash(document.getElementById('mainBox').value.trim()),		//take SHA512 hash of trimmed plaintext
		sec = toexponent(secstr,email),
		curve = sjcl.ecc.curves["c521"],
		R = curve.r,
		l = R.bitLength(),
    	k = sjcl.bn.random(R.sub(1), 0).add(1),
    	r = curve.G.mult(k).x.mod(R),
		s = sjcl.bn.fromBits(hash).add(r.mul(sec)).mul(k.inverseMod(R)).mod(R),
		sigstr = sjcl.codec.base64.fromBits(sjcl.bitArray.concat(r.toBits(l), s.toBits(l))),	//make it base64
		iv = sjcl.codec.base64.fromBits(sjcl.random.randomWords('2','0')),						//for hidden message, if activated
		padding = makesalt(iv,40);
	if (document.getElementById("notags").checked === false){
			//strip initial "A" and add decoy iv & padding and tags
		document.getElementById('mainBox').value = document.getElementById('mainBox').value + "\n\n" + "PL20sig=" + sigstr.slice(1,sigstr.length) + iv.slice(0,11) + padding + "=PL20sig";
	}else{
		document.getElementById('mainBox').value = document.getElementById('mainBox').value + "\n\n" + sigstr.slice(1,sigstr.length) + iv.slice(0,11) + padding
	}
	callKey = ''
};

//verifies the ECDSA signature of a hash of the plaintext, calls Signhash as appropriate. Algorithm from SJCL ecc.js, but not the latest version
function Verifyhash(){
	encrypting = false;
	var keymsg = document.getElementById("keymsg"),
		lockmsg = document.getElementById("lockmsg"),
		mainmsg = document.getElementById("mainmsg");
		keymsg.innerHTML = "";
		mainmsg.innerHTML = "";
	var text = document.getElementById('mainBox').value.trim();
	if (text == ""){																				//nothing in text box
		mainmsg.innerHTML = '<span style="color:red">Nothing to sign or verify</span>';
		throw("no text")
	};
	if(document.getElementById('lockBox').value.slice(0,1)=='~') decryptItem();
	var	sign = text.split(/\r?\n/);
		sign = sign[sign.length-1];																//this is a signature if added as last line of text
	var sigstr = striptags(sign);
	if (!(sigstr.length == 250)){																	//no signature tag, therefore making sign
		Signhash();
		throw("no signature, creating one")
	};
	var	pubstr = document.getElementById('lockBox').value.trim();
	if (pubstr == ""){
		mainmsg.innerHTML = 'Enter a Lock to verify the signature.';
		throw("no lock present")
	};
	if (learnOn){
		var reply = confirm("The text in the main box has been signed with somebody's secret Key. I will now verify if the sign is correct for this text and the matching Lock, which should be present in the Locks box, and will display the result in a popup. Cancel if this is not what you want.");
		if(reply == false) throw("sign verification canceled");
	};
		pubstr = striptags(pubstr);
	if (pubstr.length != 87 && pubstr.length != 100){											//not a Lock, but maybe it's a name
		if (lockDB[pubstr]) pubstr = replaceByItem(pubstr,false);
	}
	if (pubstr.length == 100) pubstr = changeBase(pubstr.toLowerCase(), BASE38in, BASE64) 						//ezLok replaced by regular Lock
	if (pubstr.length != 87){
		mainmsg.innerHTML = '<span style="color:red">Enter a valid Lock</span>';
		throw("invalid public key")
	};
		text = text.replace(/\r?\n?[^\r\n]*$/, "");												//remove last line
	var hash = sjcl.hash.sha512.hash(text.trim()),												//take SHA512 hash of plaintext, ignoring initial and end spaces
		curve = sjcl.ecc.curves["c521"],
		xstr = "A" + pubstr.slice(0,pubstr.length),
		ystr = yfromx(curve,xstr),
	 	pub = curve.fromBits(sjcl.codec.base64.toBits(xstr+ystr)),
		rs = sjcl.codec.base64.toBits("A" + sigstr.slice(0,175)),								//recover signature part
		w = sjcl.bitArray,
        R = curve.r,
        l = R.bitLength(),
        r = sjcl.bn.fromBits(w.bitSlice(rs,0,l)),
        s = sjcl.bn.fromBits(w.bitSlice(rs,l,2*l)),
		u = s.inverseMod(R),
        hG = sjcl.bn.fromBits(hash).mul(u).mod(R),
        hA = r.mul(u).mod(R),
		check = true,
		r2 = curve.G.mult2(hG, hA, pub).x.mod(R);
		if (!r2.equals(r)){																		//hack from when y is the wrong root of y^2
			var y = sjcl.bn.fromBits(sjcl.codec.base64.toBits(ystr)),
				p = curve.field.modulus.copy(),
				y2 = p.sub(y),																		//this should be the right y
				ystr2 = sjcl.codec.base64.fromBits(y2.toBits());
			pub = curve.fromBits(sjcl.codec.base64.toBits(xstr+ystr2));
			r2 = curve.G.mult2(hG, hA, pub).x.mod(R);
		};																							//end of wrong root hack
	if (r.equals(0) || s.equals(0) || r.greaterEquals(R) || s.greaterEquals(R) || !r2.equals(r)) check = false;
	if (check) {
		mainmsg.innerHTML = '<span style="color:green">The signature is VERIFIED</span>'
		}
	else {
		mainmsg.innerHTML = '<span style="color:magenta">The signature has FAILED verification</span>'
		};
	if (document.getElementById("decoymode").checked){								//this part to extract the hidden message, if it exists
		var iv = sigstr.slice(175,186),
			padding = sigstr.slice(186,250);
		decoydecrypt(iv, padding);
	};
};
</script>

<!--extra functions for mail, etc.-->
<script>
//displays how many characters are left, in Short mode
function charsLeft(){
	var mainmsg = document.getElementById("mainmsg");
	if(document.getElementById("shortmode").checked){									//don't do anything unless it's short mode
		var chars = encodeURI(document.getElementById('mainBox').value).replace(/%20/g, ' ').length;
		var pubstr = striptags(document.getElementById('lockBox').value);
//		if(pubstr.length != 87){														//symmetric mode, 58 chars
//			var limit = 58
		if(document.getElementById("anonmode").checked){						//anonymous mode, 38 chars
			var limit = 38
		} else if(document.getElementById("signedmode").checked){						//signed mode, 58 chars
			var limit = 58
		} else if(document.getElementById("pfsmode").checked){							//pfs mode, 37 chars
			var limit = 37
		}
		if (chars <= limit){
			mainmsg.innerHTML = chars + " characters out of " + limit + " used"
		} else {
			mainmsg.innerHTML = '<span style="color:orange">Maximum length exceeded. The message will be truncated</span>'
		}
	} else {
		mainmsg.innerHTML = "";
	}
}

//formats results depending on tags present and sends to default email
function sendMail() {
	var	mainmsg = document.getElementById("mainmsg");
		mainmsg.innerHTML = "";
	if (learnOn){
		var reply = confirm("A new tab will open, including the contents of this box in your default email. You still need to supply the recipient's address and a title. Only Locks and locked or signed text are allowed. Cancel if this is not what you want.");
		if(reply===false) throw("email canceled");
	};
	if (lockDB['myself']){
		var mylock = lockDB['myself'][0],
			key = document.getElementById("pwd").value;
		if (key.trim() == '') {any2key(); return}
		mylock = 'PL20lok=' + keyDecrypt(key,mylock.slice(1,mylock.length))	+ '=PL20lok'		//this contains my Lock
	} else {
		mylock = 'Lock not attached'
	}
	var cipherstr = document.getElementById('mainBox').value;
	cipherstr = cipherstr.split("=").sort(function (a, b) { return b.length - a.length; })[0];
	var type = cipherstr.slice(0,1);
if (document.getElementById("notags").checked === false){							//add tags if checked, add explanatory text
	if(type==="!"){
    	var link = "mailto:"+ "?subject=" + "&body=Anonymous message locked with PassLok v.2.0 %0D%0A%0D%0AUnlock with your secret Key. %0D%0A%0D%0A" + encodeURIComponent(document.getElementById('mainBox').value) + "%0D%0A%0D%0AHere's my Lock if you want to reply to me:%0D%0A%0D%0A" + encodeURIComponent(mylock) + "%0D%0A%0D%0AGet PassLok at https://passlok.com";
	} else if (type==="@"){
		var link = "mailto:"+ "?subject=" + "&body=Message locked with PassLok v.2.0 %0D%0A%0D%0AUnlock with shared Key. %0D%0A%0D%0A" + encodeURIComponent(document.getElementById('mainBox').value) + "%0D%0A%0D%0AHere's my Lock if you want to reply to me:%0D%0A%0D%0A" + encodeURIComponent(mylock) + "%0D%0A%0D%0AGet PassLok at https://passlok.com";
	} else if (type==="#"){
		var link = "mailto:"+ "?subject=" + "&body=Signed message locked with PassLok v.2.0 %0D%0A%0D%0AUnlock with your secret Key and my Lock. %0D%0A%0D%0A" + encodeURIComponent(document.getElementById('mainBox').value) + "%0D%0A%0D%0AHere's my Lock if you want to reply to me:%0D%0A%0D%0A" + encodeURIComponent(mylock) + "%0D%0A%0D%0AGet PassLok at https://passlok.com";
	} else if (type==="$"){
		var link = "mailto:"+ "?subject=" + "&body=PFS message locked with PassLok v.2.0 %0D%0A%0D%0AUnlock with your secret Key and my Lock. %0D%0A%0D%0A" + encodeURIComponent(document.getElementById('mainBox').value) + "%0D%0A%0D%0AHere's my Lock if you want to reply to me:%0D%0A%0D%0A" + encodeURIComponent(mylock) + "%0D%0A%0D%0AGet PassLok at https://passlok.com";
	} else if (type==="~"){
		var link = "mailto:"+ "?subject=My PassLok database" + "&body=Database locked with PassLok v.2.0 %0D%0A%0D%0AUnlock with my secret Key. %0D%0A%0D%0A" + encodeURIComponent(document.getElementById('mainBox').value);
	} else if (cipherstr.length==87 || cipherstr.replace(/_/g,'').length==100){
		var link = "mailto:"+ "?subject=" + "&body=This is my PassLok v.2.0 Lock, use it to send me messages and verify my signature. %0D%0A%0D%0A" + encodeURIComponent(document.getElementById('mainBox').value) +"%0D%0A%0D%0AGet PassLok at https://passlok.com";
	} else if (cipherstr.length===160){
		var link = "mailto:"+ "?subject=" + "&body=Short message locked with PassLok v.2.0 %0D%0A%0D%0AStrip everything but the locked message and unlock normally.%0D%0A%0D%0A" + encodeURIComponent(document.getElementById('mainBox').value) + "%0D%0A%0D%0AHere's my Lock if you want to reply to me:%0D%0A%0D%0A" + encodeURIComponent(mylock) + "%0D%0A%0D%0AGet PassLok at https://passlok.com";
	} else if (cipherstr.length===250){
		var link = "mailto:"+ "?subject=" + "&body=The following is a text signed with PassLok v.2.0. Verify using my Lock, which is this:%0D%0A%0D%0A" + encodeURIComponent(mylock) + "%0D%0A%0D%0AGet PassLok at https://passlok.com%0D%0A%0D%0AThe text, followed by the signature,  BEGINS BELOW THIS LINE:%0D%0A%0D%0A" + encodeURIComponent(document.getElementById('mainBox').value);

	} else {																		//may be a longish signed text, so try a little harder
		var cipherstrArray = document.getElementById('mainBox').value.split('\n'),
			length = cipherstrArray.length,
			cipherstr = cipherstrArray[length-1];
		cipherstr = cipherstr.split("=").sort(function (a, b) { return b.length - a.length; })[0];
		if (cipherstr.length==250){
			var link = "mailto:"+ "?subject=" + "&body=The following is a text signed with PassLok v.2.0. Verify using my Lock, which is this:%0D%0A%0D%0A" + encodeURIComponent(mylock) + "%0D%0A%0D%0AHere's my Lock if you want to reply to me:%0D%0A%0D%0A" + encodeURIComponent(mylock) + "%0D%0A%0D%0AGet PassLok at https://passlok.com";
		} else {
			mainmsg.innerHTML = 'Only Locks, and locked or signed text are allowed for Email';
			throw("illegal text")
		}
	}
}else{																				//tags unchecked, no extra text
	if((type=="!")||(type=="@")||(type=="#")||(type=="$")||(cipherstr.length==87)||(cipherstr.length==100)||(cipherstr.length==250)||(cipherstr.length==160)){
		var link = "mailto:"+ "?subject=" + "&body=" + encodeURIComponent(document.getElementById('mainBox').value);
	}else{
		mainmsg.innerHTML = '<span style="color:red">Only Locks, and locked or signed text are allowed for Email</span>';
		throw("illegal text")
	}
}
	if(isMobile){ 	 											//new window for PC, same window for mobile
		window.open(link,"_parent")
	} else {
		window.open(link,"_blank")
	}
}

//calls texting app (works on mobile only)
function sendSMS(){
	if(isMobile){
		if (learnOn){
			var reply = confirm("The default texting app will now open. You need to have copied your short locked message to the clipboard before doing this, if you want to send one. This only works in smartphones. Cancel if this is not what you want.");
			if(reply===false) throw("SMS canceled");
		};
		window.open("SMS:","_parent")							//open SMS on mobile
	} else {
		document.getElementById('mainmsg').innerHTML = 'SMS function is only available on mobile devices'
	}
};
</script>

<!--Shamir Secret Sharing Scheme-->
<script>
//this function implements the Shamir Secret Sharing Scheme, taking the secret from the main box and putting the result back there, and vice-versa.
function secretshare(){
	var mainmsg = document.getElementById("mainmsg"),
		main = document.getElementById('mainBox').value.trim();
	if((main.slice(0,8).match(/p\d{3}/) && main.slice(0,2)=='PL') || (main.match(/\n\nA/) && main.slice(0,1)=='A')){		//main box has parts: join parts
		var shares = main.replace(/\n\s*\n/g, '\n').split("\n"),					//go from newline-containing string to array
			n = shares.length,
			quorumarr = main.match(/p\d{3}/);															//quorum in tags is "p" plus 3 digits in a row, first instance
		if(quorumarr == null) {var quorum = n} else {var quorum = parseInt(quorumarr[0].slice(1,4))};	//if tags are missing, ignore quorum, otherwise read it form tags
		if(n < quorum){																//not enough parts
			mainmsg.innerHTML = '<span style="color:red">According to the tags, you need ' + (quorum - n) + ' more parts in the box</span>'
		};
		for (var i=0; i < shares.length; i++) {
			shares[i] = shares[i].split("=").sort(function (a, b) { return b.length - a.length; })[0];	//remove tags
			var isLock = shares[i].length;
			shares[i] = "8" + sjcl.codec.hex.fromBits(sjcl.codec.base64.toBits(shares[i].replace(/[^a-zA-Z0-9+/ ]+/g, '')));	//retrieve from base64 back to hex and add initial "8" to each item
		};
		if (learnOn){
			var reply = confirm("The parts in the main box will be joined to retrieve the original item, which will be placed in this box. Please make sure that there are enough parts. Cancel if this is not what you want.");
			if(reply===false) throw("SSSS join canceled");
		};
		if(n === 1){
			mainmsg.innerHTML = '<span style="color:red">Only one part in main box</span>';
			throw("insufficient parts")
		};
		var	sechex = secrets.combine(shares),
			secret = sjcl.codec.utf8String.fromBits(sjcl.codec.hex.toBits(sechex));
		document.getElementById('mainBox').value = secret;
		mainmsg.innerHTML = 'Join successful';
	} else {																		//main box empty: split secret in the box
		if (main == "") {
			mainmsg.innerHTML = '<span style="color:red">The box is empty</span>';
			throw("No key in the key box")
		};
		if (learnOn){
			var reply = confirm("The item in the box will be split into several partial items, which will replace the contents of the box. A popup will ask for the total number of parts, and the minimum needed to reconstruct the original item. Cancel if this is not what you want.");
			if(reply===false) throw("SSSS split canceled");
		};
		var number = document.getElementById('partsNumber').value;
		if (number.trim() == ""){													//stop to display the entry form if it is empty
			document.getElementById("partsIn").style.display = "block";
			document.getElementById("shadow").style.display = "block";
			if(!isMobile) document.getElementById('partsNumber').focus();
			throw ("stopped for # of parts input")
		}
		var quorum = document.getElementById('partsQuorum').value;					//this value defaults to the total number if empty
		if (quorum.trim() == ""){
			quorum = number
		}
		document.getElementById('partsNumber').value = "";							//on re-execution, read the box and reset it
		document.getElementById('partsQuorum').value = "";
		quorum = parseInt(quorum);
		number = parseInt(number);
		if(number < 2){number = 2} else if(number > 255) {number = 255};
		if (quorum > number) quorum = number;
		var	sechex = sjcl.codec.hex.fromBits(sjcl.codec.utf8String.toBits(document.getElementById('mainBox').value)),
			shares = secrets.share(sechex,number,quorum);
		displayshare(shares,quorum);
		mainmsg.innerHTML = number + ' parts made. ' + quorum + ' required to reconstruct';
		partsInBox = true
	};
	document.getElementById("partsIn").style.display = "none";
	document.getElementById("shadow").style.display = "none"
};

function displayshare(shares,quorum){
	var length = shares[0].length,
		quorumst = "00" + quorum,
		tagsOff = document.getElementById("notags").checked;
		quorumst = quorumst.substr(quorumst.length-3);

	//strip initial "8" and display each share in a new line, base 64, with tags
	if(!tagsOff){
		var	output = "PL20p" + quorumst + "=" + sjcl.codec.base64.fromBits(sjcl.codec.hex.toBits(shares[0].slice(1,length))).replace(/=+/g, '') + "=PL20p" + quorumst;

	//trim final "=" and display with tags
	}else{
		var	output = sjcl.codec.base64.fromBits(sjcl.codec.hex.toBits(shares[0].slice(1,length))).replace(/=+/g, '')
	}
	for (var i=1; i < shares.length; i++) {
		if(!tagsOff){
			output = output + "\n\n" + "PL20p" + quorumst + "=" + sjcl.codec.base64.fromBits(sjcl.codec.hex.toBits(shares[i].slice(1,length))).replace(/=+/g, '') + "=PL20p" + quorumst;
		}else{
			output = output + "\n\n" + sjcl.codec.base64.fromBits(sjcl.codec.hex.toBits(shares[i].slice(1,length))).replace(/=+/g, '')
		}
	};
	document.getElementById('mainBox').value = output;
};
</script>

<!--text and image steganograghy-->
<script>
//The following code is to convert the contents of main box into fake text, and backward. This can be useful against email scanners.

if (typeof code == 'undefined'){			//default text for base64 to words conversion, global variable
	var defaultcovertext = "The licenses for most software and other practical works are designed to take away your freedom to share and change the works. By contrast, the GNU General Public License is intended to guarantee your freedom to share and change all versions of a program to make sure it remains free software for all its users. We, the Free Software Foundation, use the GNU General Public License for most of our software; it applies also to any other work released this way by its authors. You can apply it to your programs, too. When we speak of free software, we are referring to freedom, not price. Our General Public Licenses are designed to make sure that you have the freedom to distribute copies of free software (and charge for them if you wish), that you receive source code or can get it if you want it, that you can change the software or use pieces of it in new free programs, and that you know you can do these things. To protect your rights, we need to prevent others from denying you these rights or asking you to surrender the rights. Therefore, you have certain responsibilities if you distribute copies of the software, or if you modify it: responsibilities to respect the freedom of others. For example, if you distribute copies of such a program, whether gratis or for a fee, you must pass on to the recipients the same freedoms that you received. You must make sure that they, too, receive or can get the source code. And you must show them these terms so they know their rights. Developers that use the GNU GPL protect your rights with two steps: (1) assert copyright on the software, and (2) offer you this License giving you legal permission to copy, distribute and or modify it. For the developers' and authors' protection, the GPL clearly explains that there is no warranty for this free software. For both users' and authors' sake, the GPL requires that modified versions be marked as changed, so that their problems will not be attributed erroneously to authors of previous versions.";
	var covertext = defaultcovertext;
		covertext = covertext.replace(/   +/g, "\t").replace(/  +/g, " ").replace(/\n /g,"\n\t");	//remove multiple spaces, space after linefeed
	var code = covertext.toLowerCase().replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()'"]|_/g, "").replace(/\s+/g, " ").split(" ");
		code = code.filter(function(n){return n});													//remove nulls
		code = code.filter(function(elem, pos, self) {return self.indexOf(elem) == pos;});			//global array containing the words, no duplicates
	var keyAlphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=~!@#$%_" + "\n",	//base64 plus other characters used in PassLok strings
		remainder = code.length % keyAlphabet.length,
		noptions = Math.floor(code.length / keyAlphabet.length);
}

//This function checks for words or spaces encoding and calls the approrpiate decoders. If no encoding is detected, it calls the words encoder
function words(){
	var mainmsg = document.getElementById("mainmsg");
		mainmsg.innerHTML = "";
	if(document.getElementById('mainBox').value.match(/  +/g) != null) {				//detect double spaces and if there are any invoke spaces decoder
		fromSpaces()
	}else{
		var text = document.getElementById('mainBox').value;							//get rid of null characters, if any
		if(text.trim() == ""){
			mainmsg.innerHTML = '<span style="color:red">No text in the box</span>';
			throw("no text")
		}
		var	textlow = text.toLowerCase().replace(/[,\.]+/g,'').replace(/\n+/g,' '),		//make lowercase and strip periods, commas and newlines
			textvector = textlow.split(" "),											//break up the main box into an array of words
			inwords = true,
			indices = new Array();
		for (var i = 0; i < textvector.length; i++){									//find the words in the covertext
			var index = searchStringInArray(textvector[i],code);
			indices[i] = index;															//put the indices into an array
			if(index == -1) inwords = false												//if any word is not in the covertext, this was not encoded with Words method
		}
		if (inwords) {																	//if encoded in words, call words decoder
			fromWords(indices);
			mainmsg.innerHTML = 'Message extracted from Words encoding'
		} else {																		//otherwise call words encoder
			toWords(text);
			mainmsg.innerHTML = 'Message encoded into words of this text. Decoding requires the same Cover text'
		}
	}
}

//this is almost the same as above, but if it doesn't detect encoding present, it calls the spaces encoder instead
function spaces(){
	var mainmsg = document.getElementById("mainmsg");
		mainmsg.innerHTML = "";
	if(document.getElementById('mainBox').value.match(/  +/g) != null) {				//detect double spaces and if there are any invoke spaces decoder
		fromSpaces()
	}else{
		var text = document.getElementById('mainBox').value;
		if(text.trim() == ""){
			mainmsg.innerHTML = '<span style="color:red">No text in the box</span>';
			throw("no text");
		}
		var	textlow = text.toLowerCase().replace(/[,\.]+/g,'').replace(/\n+/g,' '),		//make lowercase and strip periods, commas and newlines
			textvector = textlow.split(" "),											//break up the main box into an array of words
			inwords = true,
			indices = new Array();
		for (var i = 0; i < textvector.length; i++){									//find the words in the covertext
			var index = searchStringInArray(textvector[i],code);
			indices[i] = index;															//put the indices into an array
			if(index == -1) inwords = false												//if any word is not in the covertext, this was not encoded with Words method
		}
		if (inwords) {																	//if encoded in words, call words decoder
			fromWords(indices);
			mainmsg.innerHTML = 'Message extracted from Words encoding'
		} else {																		//otherwise call spaces encoder
			toSpaces();
			if(mainmsg.innerHTML=="") mainmsg.innerHTML = 'Message encoded into spaces of this text. Decoding does not require the same Cover text'
		}
	}
}

//the following two are to encode or decode each character of the main box into a word from the covertext
function toWords(text){
	var mainmsg = document.getElementById("mainmsg");
		mainmsg.innerHTML = "";
	if (learnOn){
			var reply = confirm("The contents of the main box will be replaced with fake text containing it in encoded form. The recipient must have the same Cover text. Cancel if this is not what you want.");
			if(reply===false) throw("toWords canceled");
	}
		var output = code[randomindex(keyAlphabet.indexOf(text[0]))];
		for (var i = 1; i < text.length; i++){
			var index = keyAlphabet.indexOf(text[i]);
			if(index == -1){
				mainmsg.innerHTML = '<span style="color:red">This text contains illegal characters for a PassLok string</span>';
				throw("illegal characters in the main box")
			}
			output = output + randompunct() + code[randomindex(index)]					//add some random commas and periods, and spaces between words
		}
		//capitalize initial and after period, add final period.
		output = output.replace(/[.][\s\n][a-z]/g,function(a){return a.toUpperCase();}).replace(/[a-z]/,function(a){return a.toUpperCase();}) + ".";
		document.getElementById('mainBox').value = output
}

function fromWords(indices){
	if (learnOn){
		var reply = confirm("The encoded text in the main box will be replaced with the original text from which it came. Cancel if this is not what you want.");
		if(reply===false) throw("fromWords canceled");
	}
		var output = "";
		for (var i = 0; i < indices.length; i++){
			output = output + keyAlphabet[indices[i] % keyAlphabet.length]
		}
		document.getElementById('mainBox').value = output
}

//Computes an index taking the full range of words in the covertext
function randomindex(index){
	if(index >= remainder){
		var choice = Math.floor(Math.random() * noptions)
	}else{
		var choice = Math.floor(Math.random() * (noptions + 1))
	}
	return index + choice*keyAlphabet.length
}

//To find words in the code. Returns the index if found, or -1 if not found
function searchStringInArray (str, strArray) {
    for (var j = 0; j < strArray.length; j++) {
        if (strArray[j] == str) return j;
    }
    return -1;
}

//This is to generate random periods, commans and newlines, per the percentage brackets below, plus spaces when appropriate
function randompunct(){
	var percent = Math.ceil(Math.random() * 100);
	if (percent < 7) {
		return ". "
	} else if(percent < 13) {
		return ", "
	} else if(percent < 14) {
		return ".\n"
	} else {
		return " "
	}
}

//the following functions are to hide text into a text cover, as binary double spaces. It needs 7 cover words for each ASCII characters, 42 for non-ASCII
function encoder(bin){
	var textsplit = covertext.split(" ");
	var spaces = textsplit.length - 1;
	var missing = bin.length - spaces;
	var turns = 0;
	if (spaces < bin.length){
		while (spaces < bin.length){
			textsplit = textsplit.concat(covertext.split(" "));
			spaces = textsplit.length - 1;
			turns = turns + 1
		}
		mainmsg.innerHTML = '<span style="color:red">The cover text was too short. It was repeated ' + turns + ' times. If this is not acceptable, repeat with a larger cover.</span>';
	}
		textsplit = textsplit.slice(0,bin.length+2);
	var newtext = textsplit[0];
	for(var i=0; i < textsplit.length-1; i++){
		newtext = newtext + stegospace(bin.slice(i,i+1)) + textsplit[i+1]
	}
	return newtext
}

function decoder(text){
	var bin = "";
	var textsplit = text.split(" ");
	for(var i=1; i < textsplit.length-1; i++){
		if (textsplit[i] == ""){
			bin = bin + "1";
			i = i + 1					//skip next word
		}else{
			bin = bin + "0"
		}
	}
	return bin
}

function stegospace(bin){
	if(bin == "1"){
		return "  "						//double space
	}else{
		return " "						//regular space
	}
}

function toSpaces() {
	var mainmsg = document.getElementById("mainmsg");
		mainmsg.innerHTML = "";
	if (learnOn){
		var reply = confirm("The contents of the main box will be replaced with encoded text which contains the original text as irregular spacing. Cancel if this is not what you want.");
		if(reply===false) throw("toSpaces canceled");
	}
  var output="";
	var input = document.getElementById('mainBox').value.trim();
    for (var i=0; i < input.length; i++) {
		if(keyAlphabet.indexOf(input[i]) == -1){
			mainmsg.innerHTML = '<span style="color:red">This text contains illegal characters for a PassLok string</span>';
			throw("illegal characters in the main box")
		}
		var bin = "000" + input[i].charCodeAt(0).toString(2);
        output = output + bin.slice(bin.length-7,bin.length);
    }
	document.getElementById('mainBox').value = encoder(output)
}

function fromSpaces() {
	if (learnOn){
		var reply = confirm("The encoded text in the main box will be replaced with the original text from which it came. Cancel if this is not what you want.");
		if(reply===false) throw("fromWords canceled");
	}
	var mainmsg = document.getElementById("mainmsg");
	var output="";
	var input=decoder(document.getElementById('mainBox').value);
    for (var i=0; i < input.length; i=i+7) {
		var bin = input.slice(i,i+7);
        output = output + String.fromCharCode(parseInt(bin,2));
    }
	document.getElementById('mainBox').value = output.replace(/\x00/g,'');		//take out nulls, in case text was added to finish the last sentence.
	mainmsg.innerHTML = 'Message extracted from Spaces encoding'
}

//this one is to display the cover text or change it as requested
function newcover(string){
	var mainmsg = document.getElementById("mainmsg");
		mainmsg.innerHTML = "";
	if(string.trim() == ""){														//if the box is empty display the cover text
		if (learnOn){
			var reply = confirm("The cover text will be displayed in the main box. Cancel if this is not what you want.");
			if(reply==false) throw("covertext display canceled");
		}
		document.getElementById('mainBox').value = covertext
	}else{																			//otherwise store new cover text
		if (learnOn){
			var reply = confirm("If you click OK, the cover text will be replaced with the contents of this box, which will be deleted.");
			if(reply==false) throw("covertext change canceled");
		}
//remove multiple spaces, spaces after linefeed
		var newcovertext = string.replace(/   +/g, "\t").replace(/  +/g, " ").replace(/\n /g,"\n\t");
		if (newcovertext.match(/[\u3400-\u9FBF]/) != null) newcovertext = newcovertext.split('').join(' ').replace(/  +/g, ' ');		//add spaces if Chinese, Korean, or Japanese
		var	newcode = newcovertext.toLowerCase().replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()'"]|_/g, "").replace(/\s+/g, " ").split(" ");  	//removes punctuation, collapses spaces to single space
			newcode = newcode.filter(function(n){return n});																			//remove nulls
			newcode = newcode.filter(function(elem, pos, self) {return self.indexOf(elem) == pos;});									//remove repeats
		if (newcode.length >= keyAlphabet.length){										//enough length for words method
			code = newcode;															//store into global variables
			covertext = newcovertext;
			remainder = code.length % keyAlphabet.length;
			noptions = Math.floor(code.length / keyAlphabet.length);
			mainmsg.innerHTML = '<span style="color:green">Cover text changed</span>'
		} else {
			mainmsg.innerHTML = '<span style="color:red">This text is too short for a Cover</span>';
			throw("text sample too short");
		}
	}
}

// load image for hiding text
var importImage = function(e) {
	if (learnOn){
		var reply = confirm("An image stored in this device will replace the current image. Cancel if this is not what you want.");
		if(reply==false) throw("image import canceled");
	}

    var reader = new FileReader();

    reader.onload = function(event) {
        // set the preview
        document.getElementById('preview').style.display = 'block';
        document.getElementById('preview').src = XSSfilter(event.target.result);
    };

    reader.readAsDataURL(e.target.files[0]);
	document.getElementById('preview').onload = function(){updateCapacity()}
};

//show how much text can be hidden in the image
function updateCapacity(){
	var image = document.getElementById('preview');
	var capacity = Math.floor(image.naturalHeight*image.naturalWidth*3/8) - 1;
	var textsize = document.getElementById('mainBox').value.length;
	if(textsize <= capacity){
	document.getElementById('imagemsg').innerHTML='This image can hide ' + capacity + ' characters. The main box has ' + textsize + ' characters'
	}else{
		document.getElementById('imagemsg').innerHTML='This image can hide ' + capacity + ' characters. <span style="color:red">But the main box has ' + textsize + ' characters</span>'
	}
}

//put text into image, which turns into PNG
function encodeImage(){
	if (learnOn){
		var reply = confirm("The text in the previous box will be encoded into this image, which can then be copied and sent to others. Cancel if this is not what you want.");
		if(reply==false) throw("encode image canceled");
	}
	var text = document.getElementById('mainBox').value;
	var imagemsg = document.getElementById('imagemsg');

//bail out if this is not a PassLok string. Otherwise, this method can handle the full UTF-16 character set
	for (var i = 0; i < text.length; i++){
		var index = keyAlphabet.indexOf(text[i]);			//keyAlphabet is a global variable defined in the text steganography section
		if(index == -1){
			imagemsg.innerHTML = '<span style="color:red">The text contains illegal characters for a PassLok string</span>';
			throw("illegal characters in box")
		}
	}

	var encodedImage = steganography.encode(encodetoUTF16(text),document.getElementById('preview').src);
    // view the new image
    document.getElementById('preview').src = XSSfilter(encodedImage);
	document.getElementById('preview').onload = function(){
		imagemsg.innerHTML = 'Text hidden in the image. Save it now.'
	}
}

//extract text from image
function decodeImage(){
	if (learnOn){
		var reply = confirm("The text hidden in this image, if any, will be extracted and placed in the previous box, replacing its contents. This does not yet work on mobile devices. Cancel if this is not what you want.");
		if(reply==false) throw("decode image canceled");
	}
	var imagemsg = document.getElementById('imagemsg');
	var loadedImage = XSSfilter(document.getElementById('preview').src);
	var text = decodefromUTF16(steganography.decode(loadedImage));
	if (text == ''){
		imagemsg.innerHTML = 'This image does not contain any hidden text'
	}else{
		document.getElementById('mainBox').value = text;
		imagemsg.innerHTML = 'Go back to see the text extracted from this image'
	}
}

//this encodes two 8-bit characters into one 16-bit, effectively doubling the hiding capacity of an image
function encodetoUTF16(text){
	if (text.length % 2 == 0){
		var out = ' '
	}else{
		var out = ''						//somehow, an odd number of characters has fewer problems at the end, so pad the even strings
	}
	for(i=0;i<text.length;i=i+2){
		var char1 = text.slice(i,i+1).charCodeAt().toString(16),
			char2 = text.slice(i+1,i+2).charCodeAt().toString(16);
		out = out + String.fromCharCode('0x'+char1+char2);
	}
	return out + ' '
}

//decode from the above
function decodefromUTF16(text){
	var out = '';
	for(i=0;i<text.length;i++){
		var charIn = text.slice(i,i+1).charCodeAt().toString(16),
			char1 = String.fromCharCode('0x'+charIn.slice(0,2)),
			char2 = String.fromCharCode('0x'+charIn.slice(2,4));
		out = out + char1 + char2;
	}
	return out.trim()
}
</script>

<!--local Directory functions-->
<script>
//get name and Lock from form and merge them with the lockDB object, then store
function addLock(){
	if (learnOn){
		var reply = confirm("The item in the box will be added to the permanent directory. Cancel if this is not what you want.");
		if(reply==false) throw("lockDB add canceled");
	}
	callKey = 'addlock';
	var lockmsg = document.getElementById("lockmsg");
	var name = document.getElementById('locknameBox').value.trim(),
		lock = document.getElementById('lockBox').value.trim();
	if (XSSfilter(name)!=name){
		lockmsg.innerHTML = 'This is not a valid name';
		throw('name contained XSS-illegal characters')
	}
	var lockarray = lock.split('\n');
	var isList = (lockarray.length > 1 && lockarray[1].slice(0,4) != 'http');			//identify List
	if (lock ==''){
		if(!lockDB['myself'] || BasicButtons) return;									//don't do it in Basic mode
		var ran = true;
		lock = sjcl.codec.base64.fromBits(sjcl.random.randomWords('17','0')).slice(0,86);   //make a random Key and store it below if a name is provided
		document.getElementById('lockBox').value = lock;
	}
	if (name !=''){
		var key = readKey(),
			lockcrypt = keyEncrypt(key,lock);
		lockcrypt = '~' + lockcrypt;
		if(isList) name = '--' + name + '--';										//dashes bracket name for Lists
			var newEntry = JSON.parse('{"' + name + '":["' + lockcrypt + '"]}');
			lockDB = sortObject(mergeObjects(lockDB,newEntry));
			localStorage.lockDB = JSON.stringify(lockDB);
			lockNames = [''].concat(Object.keys(lockDB));
			window.setTimeout(function(){											//this needs to be on a timer for iOS
				if (ran) {
					lockmsg.innerHTML = '<span style="color:green">Random Key stored to local directory with name </span>' + name
				} else if(striptags(lock).length == 87 || striptags(lock).length == 100){
					lockmsg.innerHTML = '<span style="color:green">Lock saved to local directory with name </span>' + name
				} else if(isList){
					lockmsg.innerHTML = '<span style="color:green">List saved to local directory with name </span>' + name
				} else {
					lockmsg.innerHTML = '<span style="color:green">Item saved to local directory with name </span>' + name
				};
			}, 100);
			fillList();

			if(testChromeSync()){													//if Chrome sync is available, add to sync storage
				syncChromeLock(name,'["' + lockcrypt + '"]')
			}

	} else {
		lockmsg.innerHTML = '<span style="color:red">Cannot save without a name</span>'
	};
	suspendFindLock = false;
	callKey = ''
}

//delete a particular key in Object lockDB, then store
function removeLock(){
	if (learnOn){
		var reply = confirm("The item displayed in the box will be removed from the permanent directory. This is irreversible. Cancel if this is not what you want.");
		if(reply==false) throw("lockDB remove canceled");
	}
	var lockmsg = document.getElementById("lockmsg");
	var name = lockmsg.innerHTML;
	if (lockDB[name] == null){
		lockmsg.innerHTML = 'To remove an item, its name must be displayed <strong>here</strong>';
		throw('bad name')
	}
	delete lockDB[name];
	localStorage.lockDB = JSON.stringify(lockDB);
	lockNames = [''].concat(Object.keys(lockDB));
	window.setTimeout(function(){										//this needs to be on a timer for iOS
		lockmsg.innerHTML = XSSfilter(name) + ' deleted';
	}, 100);
	fillList();

		if(testChromeSync()){											//if Chrome sync is available, remove from sync storage
			if(confirm('Item removed from local storage. Do you want to remove it also from the Chrome sync area?')) remChromeLock(name)
		}

	suspendFindLock = false;
}

//this is to just delete the PFS data for a particular key (or reset the current list)
function resetPFS(){
	var lockmsg = document.getElementById("lockmsg");
	if (document.getElementById('lockBox').value.trim().split('\n').length > 1){		//use button to reset current List if a List is displayed, nothing to do with normal use
		if (learnOn){
			var reply = confirm("The list currently being formed will be reset. Cancel if this is not what you want.");
			if(reply==false) throw("List reset canceled");
		}
		currentList = '';
		lockmsg.innerHTML = 'Current list reset';
		return
	}
//now the real stuff
	if (learnOn){
		var reply = confirm("The data needed to maintain a PFS conversation with this sender/recipient will be deleted, so the ongoing conversation cannot be continued. This is irreversible. Cancel if this is not what you want.");
		if(reply==false) throw("myself reset canceled");
	}
	var name = lockmsg.innerHTML;
	if (lockDB[name] == null){
		lockmsg.innerHTML = 'The item to be reset must be displayed first';
		throw('bad name')
	}
	if ((lockDB[name][1] == null) && (lockDB[name][2] == null) && (lockDB[name][3] == null)){
		lockmsg.innerHTML = 'Nothing to reset';
		throw('no PFS data')
	}
	lockDB[name].splice(1,4);
	localStorage.lockDB = JSON.stringify(lockDB);

		if(testChromeSync()){											//if Chrome sync is available, change in sync storage
			syncChromeLock(name,JSON.stringify(lockDB[name]))
		}

	lockmsg.innerHTML = 'PFS data for ' + XSSfilter(name) + ' deleted';
	suspendFindLock = false
}

var suspendFindLock = false							//when true, user can input a name without deleting the lock box

//searches for name in Locks database and returns the Lock, displays full name as well. Invoked as the user types
function findLock(){
	var lockmsg = document.getElementById("lockmsg");
	lockmsg.innerHTML = '';
	var string = document.getElementById('locknameBox').value;
	var stringstrip = striptags(string);
	if(stringstrip.length == 87 || stringstrip.length == 100){									//it's a Lock in the wrong box. Move it
		document.getElementById('lockBox').value = string;
		document.getElementById('locknameBox').value = '';
		lockmsg.innerHTML = 'Locks go in the lower box. You can give it a name and save it';
		suspendFindLock = true;
		return
	}
	var index = searchStringInArrayDB(string,lockNames);
	if (index > 0){
		var name = lockNames[index];
		lockmsg.innerHTML = XSSfilter(name);
		document.getElementById('lockBox').value = lockDB[name][0]
	}else{
		lockmsg.innerHTML = '';
		document.getElementById('lockBox').value = ''
	}
}

//decrypts the contents of the Locks Box
function decryptLock(){
	callKey = 'decryptlock';
	var lockmsg = document.getElementById("lockmsg");
	var firstchar = document.getElementById('lockBox').value.slice(0,1);
	if(firstchar == '~' || firstchar == '^') {
		decryptItem();
	}
	if(document.getElementById('lockBox').value != ''){
		var listArray = document.getElementById('lockBox').value.split('\n');
		if(document.getElementById('lockBox').value.split(' ').length >= keyAlphabet.length){
			newcover(document.getElementById('lockBox').value);							//this for loading cover text from lock screen
			lockmsg.innerHTML = 'New Cover text extracted and ready to use'
		} else if(listArray.length > 1 && listArray[1].slice(0,4) != 'http'){
			lockmsg.innerHTML = 'List extracted'
		} else if(striptags(document.getElementById('lockBox').value).length == 87 || striptags(document.getElementById('lockBox').value).length == 100){
			lockmsg.innerHTML = 'Lock extracted'
		} else if(document.getElementById('lockBox').value.length == 86){
			lockmsg.innerHTML = 'Random Key extracted'
		} else {
			lockmsg.innerHTML = 'Shared Key extracted'
		}
	}
	callKey = ''
}

//if a newline is entered, puts the expanded contents of the name box in the lock box, and waits for another item
var currentList = '';

function addToList(){
	if (learnOn){
		var reply = confirm("The item displayed will be added to the current list. Cancel if this is not what you want.");
		if(reply==false) throw("add to list canceled");
	}
	var lockmsg = document.getElementById("lockmsg"),
		currentItem = document.getElementById('lockBox').value;
	if(lockmsg.innerHTML != ''){
		var namenumber = currentItem.split('\n').length;

//if the item is itself a list or there is no name, add the contents rather than the displayed name
		if (namenumber > 1 || document.getElementById('locknameBox').value==''){
			if(currentList == ''){
				currentList = currentItem
			}else{
				currentList = currentList + '\n' + currentItem
			}
			lockmsg.innerHTML = namenumber + ' items added to the current list'
		} else {
			if(currentList == ''){
				currentList = lockmsg.innerHTML
			}else{
				currentList = currentList + '\n' + lockmsg.innerHTML
			}
			lockmsg.innerHTML = XSSfilter(lockmsg.innerHTML) + ' added to the current list'
		}
	} else {
		if (currentList !=''){
			lockmsg.innerHTML = 'This is the (temporary) current list'
		} else {
			lockmsg.innerHTML = 'No items on the current list'
		}
	}
	var listArray = currentList.replace(/\n+/g,'\n').split('\n');
	listArray = listArray.filter(function(elem, pos, self) {return self.indexOf(elem) == pos;});	//remove duplicates
	currentList = listArray.join('\n');
	document.getElementById('lockBox').value = currentList.trim();
	currentList = document.getElementById('lockBox').value;
	suspendFindLock = false
}

//automatically decrypts an item stored encrypted in the lockDB database. It uses the permanent Key
function decryptItem(){
	if(callKey != 'decryptlock') callKey = 'decryptitem';
	var	key = readKey(),
		string = document.getElementById('lockBox').value.trim();
	if(string == "") throw('nothing to decrypt');
	string = string.slice(1,string.length);															//strip initial '~'
	document.getElementById('lockBox').value = keyDecrypt(key,string);
	if(callKey != 'decryptlock') callKey = ''
}

//add a few spaces and newlines, then remove brackets, etc., extra spaces, put in alphabetical order
function showLockDB(){
	if (learnOn){
		var reply = confirm("The complete directory of Locks, shared Keys, etc. stored in this device will be displayed. Cancel if this is not what you want.");
		if(reply==false) throw("lockDB show canceled");
	}
	var lockmsg = document.getElementById("lockmsg");
	if(localStorage.lockDB != "{}"){
		var alphalockDB = lockDB;
		document.getElementById('lockBox').value = JSON.stringify(alphalockDB,null,4).replace(/[{}"\[\]]/g,'').replace(/\n    /g,'\n').replace(/ \n/g,'\n').replace(/,\n/g,'\n').trim();
		lockmsg.innerHTML = 'These are the items stored in this device';
	}else{
		lockmsg.innerHTML = '<span style="color:red">There are no stored items</span>';
	}
	suspendFindLock = false
}

//as above, but just the 'myself' entry
function showMyself(){
	var mainmsg = document.getElementById("mainmsg");
	if(lockDB['myself']){
		var alphalockDB = lockDB['myself'];
		document.getElementById('mainBox').value = 'myself:\n' + JSON.stringify(alphalockDB,null,4).replace(/[{}"\[\]]/g,'').replace(/\n    /g,'\n').replace(/ \n/g,'\n').replace(/,\n/g,'\n').trim();
		mainmsg.innerHTML = 'These are your stored settings';
	}else{
		mainmsg.innerHTML = '<span style="color:red">No settings to store</span>';
	}
	suspendFindLock = false
}

//reconstruct the original JSON string from the newlines and spaces as displayed by showLockDB
function mergeLockDB(){
	callKey = 'mergedb';
	var lockmsg = document.getElementById("lockmsg"),
		lockstr = document.getElementById('lockBox').value.trim(),		//see if these are Locks for a possible DH merge, which is not the main function of this button
		mainstr = document.getElementById('mainBox').value.trim();
	if (lockstr == ''){
		lockmsg.innerHTML = 'Nothing to merge';
		throw('invalid merge')
	}
	if (lockstr.slice(0,1) == '~') {
		var key = readKey();
		lockstr = keyDecrypt(key,lockstr.slice(1,lockstr.length))
	}
	var lockstr2 = striptags(lockstr),
		mainstr2 = striptags(mainstr),
		locklen = lockstr2.length,
		mainlen = mainstr2.length;
	if(((locklen==87 || locklen==100) && (mainlen==87 || mainlen==100)) || (!(locklen==87 || locklen==100) && !(mainlen==87 || mainlen==100) && lockstr.split('\n').length == 1)){
		lockmsg.innerHTML = '<span style="color:orange">One and only one of the items to be merged must be a Lock<span>';
		throw('invalid DH merge')
	}
	if (locklen == 87 || locklen == 100){					//if it's a Lock in the lock box, merge it with the Key, clear lock box so it doesn't get merged next time
		if (mainstr == ''){
			lockmsg.innerHTML = 'Nothing to merge this Lock with';
			throw('invalid merge')
		}
		if (learnOn){
			var reply = confirm("The Lock in the Locks box will be combined with the Key in the main box, and the resulting Key will replace both. Cancel if this is not what you want.");
			if(reply===false) throw("merge canceled");
		};
		if (lockstr2.length == 100) lockstr2 = changeBase(lockstr2.toLowerCase(), BASE38in, BASE64); 		//ezLok replaced by regular Lock
		document.getElementById('mainBox').value = makeshared(mainstr,lockstr2,'');
		document.getElementById('lockBox').value = document.getElementById('mainBox').value;
		lockmsg.innerHTML = 'Lock merged with Key in main box';
		throw ("it was a lock, merged with key")
	} else if ((mainlen == 87 || mainlen == 100) && lockstr.split('\n').length == 1 && lockstr!=''){		//if it's a Lock in the main box and not multiline in the lock box
		if (learnOn){
			var reply = confirm("The Key in the Locks box will be combined with the Lock in the main box, and the resulting Key will replace both. Cancel if this is not what you want.");
			if(reply===false) throw("merge canceled");
		};
		if (mainstr2.length == 100) mainstr2 = changeBase(mainstr2.toLowerCase(), BASE38in, BASE64)
		document.getElementById('mainBox').value = makeshared(lockstr,mainstr2,'');
		document.getElementById('lockBox').value = document.getElementById('mainBox').value;
		lockmsg.innerHTML = 'Key merged with Lock in main box';
		throw ("it was a key, merged with lock")

	} else if(lockstr.split('\n').length > 1){

	//now the real database merge, which implies multiline
	if (learnOn){
		var reply = confirm("The items in the box will be merged into the permanent directory, replacing existing items of the same name. This is irreversible. Cancel if this is not what you want.");
		if(reply==false) throw("lockDB merge canceled");
	}
	var newDB = JSON.parse('{"' + document.getElementById('lockBox').value.trim().replace(/\n +/g,'\n').replace(/:\n/g,'":["').replace(/\n\n/g,'"],"').replace(/\n/g,'","') + '"]}');
		lockDB = sortObject(mergeObjects(lockDB,newDB));
		localStorage.lockDB = JSON.stringify(lockDB);
		lockNames = [''].concat(Object.keys(lockDB));
		window.setTimeout(function(){
			lockmsg.innerHTML = 'Items merged into database';
		}, 100);
		fillList();

		if(testChromeSync()){
			for(var name in lockDB){										//if Chrome sync is available, change all this in sync storage
				syncChromeLock(name,JSON.stringify(lockDB[name]))
			}
		}
	}
	fillList();
	suspendFindLock = false;
	callKey = ''
}

//makes encrypted backup of the whole DB, then if allowed clears lockDB object, then stores
function moveLockDB(){
	callKey = 'movedb';
	var lockmsg = document.getElementById("lockmsg");
	var key = readKey();

	//first encrypt lockDB, as displayed by showLockDB
	showLockDB();
	document.getElementById('mainBox').value = 'PL20dir=~' + keyEncrypt(key,document.getElementById('lockBox').value.trim()) + '=PL20dir';
	lockmsg.innerHTML = '<span>Database in Main tab</span>'

	//now check that the user really wants to delete the database
	var answer = confirm("The database has been exported to the Main tab. If you click OK, it will now be erased from this device. This cannot be undone.");
	if (answer == false) throw("lockDB erase canceled");
		lockDB = {};
		localStorage.lockDB = JSON.stringify(lockDB);
		lockNames = [''].concat(Object.keys(lockDB));
		lockmsg.innerHTML = '<span style="color:purple">Stored items erased</span>';
	fillList();
	suspendFindLock = false;
	callKey = ''
}

//makes encrypted backup of the 'myself' entry only, then if allowed clears it, then stores
function moveMyself(){
	callKey = 'movemyself';
	var mainmsg = document.getElementById("mainmsg");
	var key = readKey();

	//first encrypt myself data, as displayed by showLockDB
//	showLockDB();
	showMyself();
	document.getElementById('mainBox').value = 'PL20bak=~' + keyEncrypt(key,document.getElementById('mainBox').value.trim()) + '=PL20bak';
	var msg = 'The item in the box contains your backed-up settings<br>To restore them, click Lock/Unlock';
	mainmsg.innerHTML = msg;

	//now check that the user really wants to delete the database
	var answer = confirm("Your settings, including the email/token, have been backed up. If you click OK, they will now be erased from this device. This cannot be undone.");
	if (answer == false) throw("myself erase canceled");
		delete lockDB['myself'];
		localStorage.lockDB = JSON.stringify(lockDB);
		lockNames = [''].concat(Object.keys(lockDB));
	fillList();
	mainmsg.innerHTML = 'Your settings, including the email/token, have been erased<br>' + msg;
	suspendFindLock = false;
	callKey = ''
}

//merges two objects; doesn't sort the keys
function mergeObjects(obj1,obj2){
    var obj3 = {};
    for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
    for (var attrname in obj2) { obj3[attrname] = obj2[attrname]; }
    return obj3;
}

//sorts object keys alphabetically
function sortObject(o) {
    var sorted = {},
    	key, a = [];
    for (key in o) {
    	if (o.hasOwnProperty(key)) {
    		a.push(key);
    	}
    }
    a.sort(insensitive);							//this depends on next function
    for (key = 0; key < a.length; key++) {
    	sorted[a[key]] = o[a[key]];
    }
    return sorted;
}

//to make sorting case-insensitive
function insensitive(s1, s2) {
  var s1lower = s1.toLowerCase();
  var s2lower = s2.toLowerCase();
  return s1lower > s2lower? 1 : (s1lower < s2lower? -1 : 0);
}

//finds first partial match of string str and returns index of array element
function searchStringInArrayDB (str, strArray) {
	var reg = new RegExp(str, "i");					//make it case-insensitive
    for (var j=0; j<strArray.length; j++) {
		if (strArray[j] != null){
    		if (strArray[j].match(reg)) return j;
		}
    }
    return -1;
}

//decrypts lockDB items one by one and encrypts them with new Key
function recryptDB(oldkey,newkey){
	for(var name in lockDB){
		delete lockDB[name][1];													//this entry is useless after Key is changed. Will be remade later
		for(var index = 0; index < lockDB[name].length; index++){
			var content = lockDB[name][index];
			if(content){
				if(content.slice(0,1) == '~'){										//do only encrypted items
					content = keyDecrypt(oldkey,content.slice(1,content.length));
					content = '~' + keyEncrypt(newkey,content);
					lockDB[name][index] = content;
				}
			}
			if(testChromeSync() && index == 0){									//if Chrome sync is available, add to sync storage
				syncChromeLock(name,'["' + content + '"]')
			}
		}
	}
//change Lock stored under name 'myself'
	var email = readEmail();
	var newlock = makepub(newkey,email);
	newlock = '~' + keyEncrypt(newkey,newlock);
	lockDB['myself'][0] = newlock;
	localStorage.lockDB = JSON.stringify(lockDB);
}

//reads old and new Key from boxes and calls recryptDB so lockDB is re-encrypted with the new Key
function changeKey(){
	callKey = 'changekey';
	if (learnOn){
		var reply = confirm("The local directory will be re-encrypted with a new Key. Cancel if this is not what you want.");
		if(reply == false) throw("lockDB recrypt canceled");
	}
	var changemsg = document.getElementById("keychangemsg");
	var oldkey = readKey(),
		newkey = document.getElementById('newKey').value.trim(),
		newkey2 = document.getElementById('newKey2').value.trim();
	if (newkey.trim() == "" || newkey2.trim() == ""){								//stop to display the entry form if new Key is empty
		document.getElementById("keyChange").style.display = "block";
		document.getElementById("shadow").style.display = "block";
		changemsg.innerHTML = 'Enter the new Key in both boxes';
		if(!isMobile){
			if(newkey.trim() == ""){
				document.getElementById("newKey").focus()
			}else{
				document.getElementById("newKey2").focus()
			}
		}
		throw ("stopped for new Key input")
	}
	if(newkey.trim() != newkey2.trim()){												//check that the two copies match before going ahead
		changemsg.innerHTML = "<span style='color:red'>The two Keys don't match</span>";
		throw ("Keys don't match")
	}

//everything OK, so do it!
	recryptDB(oldkey,newkey);
	document.getElementById('newKey').value = "";									//on re-execution, read the box and reset it
	document.getElementById('newKey2').value = "";
	document.getElementById('keyChange').style.display = 'none';
	document.getElementById('shadow').style.display = 'none';
	document.getElementById('pwd').value = newkey;									//refill Key box, too
	if(document.getElementById('keyscr').style.display == 'block') document.getElementById('keyscr').style.display = 'none';
	document.getElementById('mainmsg').innerHTML = '<span style="color:green">The Key has changed</span>';
	document.getElementById('lockmsg').innerHTML = '<span style="color:green">The Key has changed</span>';
	callKey = '';
}

//grab the names in lockDB and put them on the Main tab selection box
function fillList(){
	var x = document.getElementById("locklist");
	if(document.getElementById('extrabuttonstop').style.display == 'block' && document.getElementById('basicbuttonstop').style.display != 'block'){		//steganography buttons showing
		x.innerHTML = '<option value="" disabled selected style="color:#639789;">Choose one stored Cover text:</option><option value="default">default</option>';
		for(var name in lockDB){
			if(lockDB[name][0].length > 500){										//only cover texts, which are long
				x.innerHTML = x.innerHTML + '<option value="' + name + '">' + name + '</option>'
			}
		}
	}else{																			//normal behavior
		x.innerHTML = '<option value="" disabled selected style="color:#639789;">Hold Ctrl or cmd for several:</option>';
		for(var name in lockDB){
			if(lockDB[name][0].length < 500){										//exclude cover texts, which are long
				x.innerHTML = x.innerHTML + '<option value="' + name + '">' + name + '</option>'
			}
		}
	}
	resetList()
}

//take the selected names and put them in the Locks lower box. If any is a List, extract and merge with the other names, removing duplicates
var isList = false;												//so a decryption failure knows how to end
function fillBox(){
	callKey = 'fillbox';
	var x = document.getElementById("locklist");
	document.getElementById('lockBox').value = '';
	var list = '';
	for (var i = 0; i < x.options.length; i++) {
    	if(x.options[i].selected == true){
			if(x.options[i].value.slice(0,2) == '--'){					//it's a List, so decrypt it and add the contents to the box
				var itemcrypt = lockDB[x.options[i].value][0];
				if (!key) var key = readKey();
				isList = true;											//to return here if the Key is wrong
				list = list + '\n' + keyDecrypt(key,itemcrypt.slice(1,itemcrypt.length));
			}else if(x.options[i].value == 'default'){					//default cover selected
				var covername = 'default';
				newcover(defaultcovertext)
			}else if(lockDB[x.options[i].value][0].length > 500){		//it's a Cover, so decrypt it and make it the new Cover
				var covername = x.options[i].value;
				var covercrypt = lockDB[covername][0];
				if (!key) var key = readKey();
				isList = true;
				newcover(keyDecrypt(key,covercrypt.slice(1,covercrypt.length)));
			}else{
         		list = list + '\n' + x.options[i].value;
			}
    	}
  	}
	var array = list.trim().split('\n');
	if (array[0] != ''){
		array = array.filter(function(elem, pos, self) {return self.indexOf(elem) == pos;});  			//remove duplicates
		array = array.filter(function(n){return n});													//remove nulls
		array.sort();																					//alphabetical order
		list = '';
		var msg = 'Lock selected for: ';
		for(var index = 0; index < array.length; index++){
			list = list + '\n' + array[index];
			msg = msg + array[index] + ', '
		}
		document.getElementById('lockBox').value = list.trim();
	} else if(covername){
		var msg = covername + ' Cover text loaded';
	} else {
		var msg = '';
	}
	document.getElementById('mainmsg').innerHTML = XSSfilter(msg);
	document.getElementById('lockmsg').innerHTML = '';
	isList = false;
	callKey = '';
}

//This is needed on mobile, since just clicking the list doesn't execute the command. Executed on blur
function refillBox(){
	if(isMobile) fillBox()
}

//empty the selection box on Main tab
function resetList(){
	var x = document.getElementById("locklist");
	for (var i = 0; i < x.options.length; i++) {
    	x.options[i].selected = false
  	}
	if(document.getElementById('extrabuttonstop').style.display == 'block' && document.getElementById('basicbuttonstop').style.display != 'block'){
		document.getElementById('mainmsg').innerHTML = 'Default Cover text active'
	}else{
		document.getElementById('lockBox').value = '';
		document.getElementById('mainmsg').innerHTML = 'No Locks selected'
	}
}
</script>

<!--functions for switching screens, etc.-->
<script>

//this is for showing and hiding text in key box and other password input boxes
function showsec(){
  var showPasswordCheckBox = document.getElementById("showKey");
  if(showPasswordCheckBox.checked){
        document.getElementById('pwd').type="TEXT";
  }else{
      document.getElementById('pwd').type="PASSWORD";
  }
};

function showdecoyIn(){
  var showPasswordCheckBox = document.getElementById("showdecIn");
  if(showPasswordCheckBox.checked){
        document.getElementById('decoyPwdIn').type="TEXT";
  }else{
      document.getElementById('decoyPwdIn').type="PASSWORD";
  }
};

function showdecoyOut(){
  var showPasswordCheckBox = document.getElementById("showdecOut");
  if(showPasswordCheckBox.checked){
        document.getElementById('decoyPwdOut').type="TEXT";
  }else{
      document.getElementById('decoyPwdOut').type="PASSWORD";
  }
};

function showIntro(){
  var showPasswordCheckBox = document.getElementById("showIntroKey");
  if(showPasswordCheckBox.checked){
        document.getElementById('pwdIntro').type="TEXT";
  }else{
      document.getElementById('pwdIntro').type="PASSWORD";
  }
};

function showNewKey(){
  var showNewKeyCheckBox = document.getElementById("showNewKey");
  if(showNewKeyCheckBox.checked){
		document.getElementById('newKey').type="TEXT";
		document.getElementById('newKey2').type="TEXT";
  }else{
		document.getElementById('newKey').type="PASSWORD";
		document.getElementById('newKey2').type="PASSWORD";
  }
};

function box2cover(){
	newcover(document.getElementById('mainBox').value)
}

//for selecting text in Main tab and other simple functions
function selectMain(){
	document.getElementById('mainBox').selectionStart=0;
	document.getElementById('mainBox').selectionEnd=document.getElementById('mainBox').value.length;
}
function clearMain(){
	document.getElementById('mainBox').value = '';
	document.getElementById('mainmsg').innerHTML = '';
}
function clearLocks(){
	document.getElementById('lockBox').value='';
	document.getElementById('locknameBox').value='';
	document.getElementById('lockmsg').innerHTML='';
	suspendFindLock = false;
}
function clearIntro(){
	document.getElementById('pwdIntro').value = '';
	document.getElementById('keyIntromsg').innerHTML = '';
	document.getElementById('pwd').value = '';
	document.getElementById('keymsg').innerHTML = '';
}

//to exit the special intro screen
function showlockIntro(){
	document.getElementById('pwd').value = document.getElementById('pwdIntro').value;
	document.getElementById('email').value = document.getElementById('emailIntro').value;
	openClose('introscr2');
	showLock();
	key2any();
	storeIntroEmail();
}

//store email entered on intro screen
function storeIntroEmail(){
	var email = document.getElementById('emailIntro').value.trim();
	if (email == ''){
		document.getElementById('keyIntromsg').innerHTML = '<span style="color:red">You must give some public info</span>';
		throw('email is empty');
	}
	document.getElementById('email').value = email;
	storeEmail()
}

//store email entered on email screen
function storeEmail(){
	var email = document.getElementById('email').value.trim();
	if (email == ''){
		any2email();
		document.getElementById('emailmsg').innerHTML = '<span style="color:red">You must write something in the box</span>';
		throw('email is empty');
	}
	var key = readKey(),
	emailcrypt = keyEncrypt(key,email);
	emailcrypt = '~' + emailcrypt;
//	emailcrypt = email;
	if(lockDB['myself']){
		lockDB['myself'][3] = emailcrypt;
	}
	localStorage.lockDB = JSON.stringify(lockDB);
}

//go to 2nd intro screen, and back
function go2intro2(){
	openClose('introscr');
	openClose('introscr2');
}

//these close input dialogs
function closebox() {
	document.getElementById("shadow").style.display = "none";
	document.getElementById("keyscr").style.display = "none";
	document.getElementById("decoyIn").style.display = "none";
	document.getElementById("decoyOut").style.display = "none";
	document.getElementById("partsIn").style.display = "none";
	document.getElementById("keyChange").style.display = "none";
	document.getElementById("emailscr").style.display = "none";
}
function cancelKey(){
	document.getElementById('pwd').value = '';
	closebox()
}
function cancelEmail(){
	document.getElementById('email').value = '';
	closebox()
}
function cancelDecoyIn(){
	document.getElementById('decoyPwdIn').value = '';
	closebox()
}
function cancelDecoyOut(){
	document.getElementById('decoyPwdOut').value = '';
	closebox()
}
function cancelPartsIn(){
	document.getElementById('partsNumber').value = '';
	closebox()
}
function cancelKeyChange(){
	document.getElementById('newKey').value = '';
	closebox();
	if(document.getElementById('keyscr').style.display == 'block') document.getElementById('keyscr').style.display = 'none'
}
function hide5min(){
	if(document.getElementById('never').checked){
		document.getElementById('5min').style.display = "none"
	}else{
		document.getElementById('5min').style.display = "block"
	}
}

//triggered if the user types Enter in the name box of the locks screen
function locknameKeyup(evt){
	evt = evt || window.event												//IE6 compliance
	if (evt.keyCode == 13) {												//sync from Chrome or decrypt if hit Return
		if(document.getElementById("lockmsg").innerHTML == ''){				//found nothing, so try to get it from Chrome sync
			if(testChromeSync()){
				var name = document.getElementById("locknameBox").value;
				getChromeLock(name);
			}
		} else {												//decrypt 1st time if found locally, 2nd time if synced from Chrome
			if(!document.getElementById("lockmsg").innerHTML.match('not found in your Chrome')){
				var firstchar = document.getElementById('lockBox').value.slice(0,1);
				if(firstchar == '~' || firstchar == '^'){
					decryptLock()
				}
			}
		}
	} else if (!suspendFindLock){return findLock()};
}

//displays Keys strength and resets Key timer
function pwdKeyup(evt){
	clearTimeout(keytimer);
	keytimer = setTimeout(function() {document.getElementById('pwd').value = ''}, 300000);
	keytime = new Date().getTime();
	evt = evt || window.event
	if (evt.keyCode == 13){acceptKey()} else{
		 return keyStrength(document.getElementById('pwd').value,true);
	}
}

//Key strength display on intro screen
function introKeyup(){
	return keyStrength(document.getElementById('pwdIntro').value,true);
}

//same but for decoy In screen
function decoyKeyup(evt){
	evt = evt || window.event
	if (evt.keyCode == 13){submitDecoyIn()} else{
		 return keyStrength(document.getElementById('decoyPwdIn').value,true);
	}
}

//same for key Change screen
function newKeyup(evt){
	evt = evt || window.event
	if (evt.keyCode == 13){changeKey()} else{
		 return keyStrength(document.getElementById('newKey').value,true);
	}
}

//this one looks at the second box and announces a match
function newKey2up(evt){
	evt = evt || window.event
	if (evt.keyCode == 13){changeKey()} else {
		var msg = document.getElementById('keychangemsg'),
			newkey = document.getElementById('newKey').value,
			newkey2 = document.getElementById('newKey2').value,
			length = newkey.length,
			length2 = newkey2.length;
		if(length != length2){
			if(newkey2 == newkey.slice(0,length2)){
				msg.innerHTML = 'Keys match so far. ' + (length-length2) + ' characters to go'
			} else {
				msg.innerHTML = "<span style='color:magenta'>Keys don't match</span>"
			}
		}else{
			if(newkey2 == newkey){
				msg.innerHTML = "<span style='color:green'>Keys match!</span>"
			} else {
				msg.innerHTML = "<span style='color:magenta'>Keys don't match</span>"
			}
		}
	}
}

//activated when the user clicks OK on a decoy screen
function submitDecoyIn(){
	closebox();
	if(encrypting){Decrypt_single()}else{Verifyhash()};
}

//Enter has the same effect as clicking OK in decoy and parts box
function decoyKeyupOut(evt){
	evt = evt || window.event
	if (evt.keyCode == 13){submitDecoyOut()};
}
function submitDecoyOut(){
	closebox();
	if(encrypting){Decrypt_single()}else{Verifyhash()};
}
function partsKeyup(evt){
	evt = evt || window.event
	if (evt.keyCode == 13){submitParts()};
}
function submitParts(){
	if(!isNaN(document.getElementById('partsNumber').value)){
	closebox();
	secretshare();
	}
}
function emailKeyup(evt){
	evt = evt || window.event
	if (evt.keyCode == 13){email2any()};
}

//for switching between sets of buttons
function main2extra(){
	openClose("mainbuttonstop");
	openClose("mainbuttonsbot");
	openClose("extrabuttonstop");
	openClose("extrabuttonsbot");
	fillList();
}

//switch to Advanced mode, and back
function basic2main(){
	if(document.getElementById('mainbuttonstop').style.display == 'block' || document.getElementById('basicbuttonstop').style.display == 'block'){
		openClose("mainbuttonstop");
		openClose("mainbuttonsbot");
	}else if(document.getElementById('extrabuttonstop').style.display == 'block'){
		openClose("extrabuttonstop");
		openClose("extrabuttonsbot");
	}
	openClose("basicbuttonstop");
	openClose("basicbuttonsbot");
	openClose("basiclockbuttonstop");
	openClose("basiclockbuttonsbot");
	openClose("lockbuttonstop");
	openClose("lockbuttonsbot");
	if(lockDB['myself']){
		if (lockDB['myself'][2] != 'advanced'){
			lockDB['myself'][2] = 'advanced';
			document.getElementById('basicmode').checked = false;
			document.getElementById('advancedmode').checked = true;
			BasicButtons = false
		}else{
			lockDB['myself'][2] = 'basic';
			document.getElementById('basicmode').checked = true;
			document.getElementById('advancedmode').checked = false;
			BasicButtons = true
		}
		localStorage.lockDB = JSON.stringify(lockDB)
	};
	fillList();
}

//makes the ezLok choice permanent
function ezLokStore(){
	if(lockDB['myself']){
		if (document.getElementById('ezLok').checked){
			lockDB['myself'][4] = 'ezLokOn'
		} else {
			lockDB['myself'][4] = 'ezLokOff'
		}
	}
	localStorage.lockDB = JSON.stringify(lockDB)
}

//opens Directory tab for input if something seems to be missing
function main2lock(){
	tabLinks['mainTab'].className = '';
	tabLinks['dirTab'].className = 'selected';
	contentDivs['mainTab'].className = 'tabContent hide';
	contentDivs['dirTab'].className = 'tabContent';
	focusBox();
}

//open image screen
function main2image(){
	if (learnOn){
		var reply = confirm("A new screen will open so you can load an image and hide the contents of the box in it. This only works for valid PassLok output. Cancel if this is not what you want.");
		if(reply == false) throw("Image canceled");
	};
	openClose('imagescr');
	if(document.getElementById('preview').src.slice(0,4)!='data'){
		document.getElementById('imagemsg').innerHTML='Click the button above to load an image'
	}else{
		updateCapacity()
	}
};

//return from image screen
function image2main(){
	if(document.getElementById('imagescr').style.display=='block'){
		openClose('imagescr');
	}
}

//go to general directory frame
function lock2dir(){
	if(document.getElementById('keyscr').style.display=='block') return;
	if(document.getElementById('lockdir').style.display=='none') loadLockDir();
	var locklength = striptags(document.getElementById('mainBox').value).length;
	if ((locklength == 87 || locklength == 100) && document.getElementById('lockdir').style.display != "block"){

//if populated, send Lock to directory
		var lockdirframe = document.getElementById('lockdirframe');
		lockdirframe.contentWindow.postMessage(document.getElementById('mainBox').value, 'https://passlok.com');
		lockdirframe.onload = function() {
	    	lockdirframe.contentWindow.postMessage(document.getElementById('mainBox').value, 'https://passlok.com');		//so that the Lock directory gets the Lock, too
		};
		document.getElementById('lockdir').style.display = "block";
		return
	}
	openClose('lockdir');
	focusBox()
}

//return from general directory frame
function dir2any(){
	openClose('lockdir');
	focusBox()
}

//to load general Lock directory only once
function loadLockDir(){
	if(document.getElementById('lockdirframe').src != 'https://passlok.com/lockdir') document.getElementById('lockdirframe').src = 'https://passlok.com/lockdir';
}

function help2quiz(){
	if(document.getElementById('quizframe').src != 'quiz.html') document.getElementById('quizframe').src = 'quiz.html';
	if(contentDivs['helpTab'].className == 'tabContent'){
		tabLinks['helpTab'].className = '';
		contentDivs['helpTab'].className = 'tabContent hide';
	}else{
		tabLinks['helpTab'].className = 'selected';
		contentDivs['helpTab'].className = 'tabContent';
	}
	openClose('quizscr')
}

//called when the Key box is empty
function any2key(){
	document.getElementById('shadow').style.display = 'block';
	document.getElementById('keyscr').style.display = 'block';
	if(document.getElementById("email").value.trim=='') any2email();
	if(!isMobile) document.getElementById("pwd").focus()
}

//called when the email box is empty
function any2email(){
	document.getElementById('shadow').style.display = 'block';
	document.getElementById('emailscr').style.display = 'block';
	if(!isMobile) document.getElementById("email").focus()
}

//close screens and reset Key timer when leaving the Key box. Restarts whatever was being done when the Key was found missing.
function key2any(){
	clearTimeout(keytimer);
	keytimer = setTimeout(function() {document.getElementById('pwd').value = ''}, 300000)	//reset timer for 5 minutes, then delete Key
	keytime = new Date().getTime();
var mykey = document.getElementById('pwd').value.trim();
	document.getElementById('keyscr').style.display = 'none';
	document.getElementById('shadow').style.display = 'none';
	if(lockDB['myself'] == null && mykey != ''){		//if "myself" lockDB entry containing the Key's matching Lock is not present, add it
		var email = readEmail();
		var mylock = makepub(mykey,email);
		storemyself(mykey,mylock);
	};
	if(lockDB['myself'][3] != null){					//fill email box
		var emailcrypt = lockDB['myself'][3];
		document.getElementById('email').value = keyDecrypt(mykey, emailcrypt.slice(1,emailcrypt.length));
	}
	if (callKey == 'encrypt'){						//now complete whatever was being done when the Key was found missing
		Encrypt_single()
	}else if(callKey == 'decrypt'){
		Decrypt_single()
	}else if(callKey == 'sign'){
		Signhash()
	}else if(callKey == 'addlock'){
		addLock()
	}else if(callKey == 'decryptitem'){
		decryptItem()
	}else if(callKey == 'decryptlock'){
		decryptLock()
	}else if(callKey == 'mergedb'){
		mergeLockDB()
	}else if(callKey == 'movedb'){
		moveLockDB()
	} else if(callKey == 'showlock'){
		showLock()
	} else if(callKey == 'fillbox'){
		fillBox()
	} else if(callKey == 'changekey'){
		changeKey()
	} else if(callKey == 'movemyself'){
		moveMyself()
	}
	focusBox()
}

//leave email screen, passing through key screen
function email2any(){
	storeEmail();
	document.getElementById('emailscr').style.display = 'none';
	if(document.getElementById('checkKey').checked && lockDB['myself']) checkKey(document.getElementById('pwd').value);
	key2any();
}

//put cursor in the box. Handy when using keyboard shortcuts
function focusBox(){
	if (!isMobile){															//on mobile, don't focus
		if(document.getElementById('keyscr').style.display == 'block'){
			document.getElementById("pwd").focus()
		} else if(contentDivs['dirTab'].className == 'tabContent'){
			document.getElementById("locknameBox").focus()
		} else {
			document.getElementById("mainBox").focus()
		}
	}
}

//sets Learn mode when the appropriate box is checked
function setlearnmode(){
	if (document.getElementById("learnmode").checked) {learnOn = true} else {learnOn = false}
}

//to see if there is a Chrome sync data area. Works for Chrome apps and extensions
function testChromeSync(){
	if(isChrome){
	if(chrome.storage){
		if(chrome.storage.sync){
			return true
		} else {return false}
	} else {return false}
	}
}

//simple XSS filter for use in innerHTML-editing statements. Removes stuff between angle brackets
function XSSfilter(string){
	return string.replace(/<(.*?)>/gi, "")
}

<!-- Text hide trick, by Sandeep Gangadharan 2005-->
if (document.getElementById) {
 document.writeln('<style type="text/css"><!--')
 document.writeln('.texter {display:none} @media print {.texter {display:block;}}')
 document.writeln('//--></style>') }

function openClose(theID) {
 if (document.getElementById(theID).style.display === "block") { document.getElementById(theID).style.display = "none" }
 else { document.getElementById(theID).style.display = "block" } };
// end of hide trick

<!--variables and functions for making tabs, by Matt Doyle 2009-->
    var tabLinks = new Array();
    var contentDivs = new Array();

    function initTabs() {

      // Grab the tab links and content divs from the page
      var tabListItems = document.getElementById('tabs').childNodes;
      for ( var i = 0; i < tabListItems.length; i++ ) {
        if ( tabListItems[i].nodeName == "LI" ) {
          var tabLink = getFirstChildWithTagName( tabListItems[i], 'A' );
          var id = getHash( tabLink.getAttribute('href') );
          tabLinks[id] = tabLink;
          contentDivs[id] = document.getElementById( id );
        }
      }

      // Assign onclick events to the tab links, and
      // highlight the first tab
      var i = 0;

      for ( var id in tabLinks ) {
        tabLinks[id].onclick = showTab;
        tabLinks[id].onfocus = function() { this.blur() };
        if ( i == 0 ) tabLinks[id].className = 'selected';
        i++;
      }

      // Hide all content divs except the first
      var i = 0;

      for ( var id in contentDivs ) {
        if ( i != 0 ) contentDivs[id].className = 'tabContent hide';
        i++;
      }
    }

    function showTab() {
      var selectedId = getHash( this.getAttribute('href') );

      // Highlight the selected tab, and dim all others.
      // Also show the selected content div, and hide all others.
      for ( var id in contentDivs ) {
        if ( id == selectedId ) {
          tabLinks[id].className = 'selected';
          contentDivs[id].className = 'tabContent';
        } else {
          tabLinks[id].className = '';
          contentDivs[id].className = 'tabContent hide';
        }
      }

      // Stop the browser following the link
      return false;
    }

    function getFirstChildWithTagName( element, tagName ) {
      for ( var i = 0; i < element.childNodes.length; i++ ) {
        if ( element.childNodes[i].nodeName == tagName ) return element.childNodes[i];
      }
    }

    function getHash( url ) {
      var hashPos = url.lastIndexOf ( '#' );
      return url.substring( hashPos + 1 );
    }
//end of tab functions

//function to search in Help tab, from JAVASCRIPTER.NET 2011
var TRange=null;

function findString (str) {
 if (parseInt(navigator.appVersion)<4) return;
 var strFound;
 if (window.find) {

  // CODE FOR BROWSERS THAT SUPPORT window.find

  strFound=self.find(str);
  if (!strFound) {
   strFound=self.find(str,0,1);
   while (self.find(str,0,1)) continue;
  }
 }
 else if (navigator.appName.indexOf("Microsoft")!=-1) {

  // EXPLORER-SPECIFIC CODE

  if (TRange!=null) {
   TRange.collapse(false);
   strFound=TRange.findText(str);
   if (strFound) TRange.select();
  }
  if (TRange==null || strFound==0) {
   TRange=self.document.body.createTextRange();
   strFound=TRange.findText(str);
   if (strFound) TRange.select();
  }
 }
 else if (navigator.appName=="Opera") {
  alert ("Opera browsers not supported, sorry...")
  return;
 }
 if (!strFound){
	 document.getElementById('helpmsg').innerHTML = 'Text not found in the titles'
 }else{
	 document.getElementById('helpmsg').innerHTML = 'Text highlighted below. Click again to see more results'
 }
 return;
}

//The main script in the head ends here.
</script>

<!--special functions that work only with Chrome apps and extensions-->
<script>
//to put Lock into sync storage
function syncChromeLock(name,data) {
    var jsonfile = {};
    jsonfile[name.toLowerCase()] = data;
    chrome.storage.sync.set(jsonfile);
}

//to retrieve Lock from sync storage. The code specifying what to do with the item is here because the get operation is asynchronous
function getChromeLock(name) {
    chrome.storage.sync.get(name.toLowerCase(), function (obj) {
		var lockdata = obj[name.toLowerCase()];
		if(lockdata){
			storeChromeLock(name,lockdata)
		} else if(name.slice(0,2) != '--'){
			var name2 = '--' + name.toLowerCase() + '--';			//it may be a List, so change the name and try again
			lockdata = obj[name2];
			getChromeLock(name2)
		} else {
			if (name.slice(0,2) == '--') name = name.slice(2,name.length-2);
			document.getElementById("lockmsg").innerHTML = XSSfilter(name) + ' not found in your Chrome sync area'
		}
	});
}

function storeChromeLock(name,lockdata){
	lockDB[name] = JSON.parse(lockdata);
	document.getElementById("lockBox").value = lockDB[name][0];
	document.getElementById("lockmsg").innerHTML = XSSfilter(name) + ' added from your Chrome sync area';
	lockDB = sortObject(lockDB);
	localStorage.lockDB = JSON.stringify(lockDB);
	lockNames = [''].concat(Object.keys(lockDB));
	fillList();
}

//to completely remove an entry
function remChromeLock(name) {
    chrome.storage.sync.remove(name.toLowerCase());
}
</script>

</head>

<body>

<!--Tabs-->
<ul id="tabs">
      <li><a href="#mainTab" title="messages go here (alt-M)" accesskey="m">Main</a></li>
      <li><a href="#dirTab" title="Locks go here (alt-M)" accesskey="d">Directory</a></li>
      <li><a href="#optionsTab" title="several modes available (alt-O)" accesskey="o">Options</a></li>
      <li><a href="#helpTab" title="help for all functions (alt-M)" accesskey="h">Help</a></li>
    </ul>

<!--Main tab-->
<div class="tabContent" id="mainTab">
  <div align="center">
<br /><br /><br />
	<span id="mainmsg">Welcome to PassLok Privacy. Use the top box to select stored Locks. Hold Ctrl or cmd to select several.</span><br /><br />
    <select id='locklist' size='4' multiple></select>
    <button id="resetListButton" value="resetList" style="border:1px solid #dedede; color: #666666; background: #e6e6e6;" title="reset selection">Reset</button><br />
<div id="basicbuttonstop" class="texter" style="font-size:0;display: block;">
	<button class="cssbutton" id="clearMainButtonBasic" value="Clear" style="font-size:22px;padding:14px;" title="clear the text in the box">Clear</button><!--
--><button class="cssbutton" id="selectMainButtonBasic" value="Select" style="font-size:22px;padding:14px;" title="select the text in the box">Select</button><!--
--><button class="cssbutton" id="sendMailButtonBasic" value="Mail" style="font-size:22px;padding:14px;" title="put the box contents in an email using the default client (alt-E)" accesskey="e">Email</button>
</div>
<div id="mainbuttonstop" class="texter" style="display: none;">
	<button class="cssbutton" id="clearMainButton" value="Clear" style="" title="clear the text in the box">Clear</button><!--
--><button class="cssbutton" id="selectMainButton" value="Select" style="" title="select the text in the box">Select</button><!--
--><button class="cssbutton" id="sendMailButton" value="Mail" style="" title="put the box contents in an email using the default client (alt-E)">Email</button><!--
--><button class="cssbutton" id="main2extraButton" value="More" style="color:orange;" title="replace main buttons with those for extra functions (alt-.)" accesskey=".">&#9660;</button>
</div>
<div id="extrabuttonstop" class="texter" style="display: none;">
	<button class="cssbutton" id="sendSMSButton" value="SMS" style="" title="mobile: open the default Texting app">SMS</button><!--
--><button class="cssbutton" id="imageButton" value="Image" style="" title="open image hiding functions (alt-I)" accesskey="i">Image</button><!--
--><button class="cssbutton" id="secretshareButton" value="Split/Join" style="" title="split plain box contents into several random-looking parts, or rejoin parts in the box (alt-J)" accesskey="j">Split/Join</button><!--
--><button class="cssbutton" id="extra2mainButton" value="Less" style="color:orange;" title="return main buttons (alt-.)">&#9650;</button>
</div>
    </div>
    <div align="center">
    <textarea class="cssbox" id="mainBox" name="text" rows="9" style="" placeholder="The text to be locked, unlocked, or signed goes here.   Before locking or verifying, you need to enter the other person's Lock." accesskey=";"></textarea>
    </div>
	<div align="center">
<div id="basicbuttonsbot" class="texter" style="display: block;">
   <button class="cssbutton" id="decryptButtonBasic" value="Lock/Unlock" style="font-size:22px;padding:14px;color:blue;" title="lock plain text in the box, unlock locked text (alt-L)" accesskey="l">Lock/Unlock</button><!--
--><button class="cssbutton" id="showlockButtonBasic" value="myLock" style="font-size:22px;padding:14px;" title="display your Lock (alt-K)" accesskey="k">myLock</button><!--
-->
</div>
<div id="mainbuttonsbot" class="texter" style="display: none;">
   <button class="cssbutton" id="decryptButton" value="Lock/Unlock" style="color:blue;padding-right:10px;padding-left:10px;" title="lock plain text in the box, unlock locked text (alt-U)" accesskey="">Lock/Unlock</button><!--
--><button class="cssbutton" id="verifyButton" value="Sign/Verify" style="padding-right:10px;padding-left:10px;" title="add signature based on secret Key and box contents, or verify existing signature (alt-V)" accesskey="v">Sign/Verify</button><!--
--><button class="cssbutton" id="showlockButton" value="myLock" style="padding-right:10px;padding-left:10px;" title="display your Lock (alt-K)">myLock</button><br />
</div>
<div id="extrabuttonsbot" class="texter" style="display: none;">
	<button class="cssbutton" id="wordsButton" value="Words" style="" title="hide box contents as words (recipient must have the Cover text), or reveal hidden contents (alt-W)" accesskey="w">Words</button><!--
--><button class="cssbutton" id="spacesButton" value="Spaces" style="" title="hide box contents as spaces between words (recipient does not need the Cover text, but long), or reveal hidden contents (alt-S)" accesskey="s">Spaces</button><!--
--><button class="cssbutton" id="coverButton" value="Cover" style="" title="if box is empty, display the current Cover text, otherwise set box contents as Cover text (alt-C)" accesskey="c">Cover</button><br />
</div>
  </div>
    </div>

<!--Directory tab-->
<div class="tabContent" id="dirTab">
    <div align="center">
    <br /><br /><br />
    	<span id="lockmsg">Enter Locks in the lower box. The top box is for Lock names</span><br />
    	<input type="text" class="cssbox" id="locknameBox" onKeyUp="locknameKeyup(event,'locknameBox');" style="" name="text" placeholder="Enter the name first, then enter the Lock in the lower box."/></div>
    <div align="center" id="basiclockbuttonstop" class="texter" style="display: block;">
     <button class="cssbutton" id="clearLocksButtonBasic" value="Clear" style="font-size:22px;padding:14px;" title="clear both boxes">Clear</button><!--
--><button class="cssbutton" id="addLockButtonBasic" value="Save" style="font-size:22px;padding:14px" title="save lower box into the local directory with the name given in the upper box | if lower box is empty, make random item">Save</button><!--
--><button class="cssbutton" id="removeLockButtonBasic" value="Del." style="font-size:22px;padding:14px" title="delete the item whose name is displayed">Delete</button>
    </div>
    <div align="center" id="lockbuttonstop" class="texter" style="display: none;">
   <button class="cssbutton" id="clearLocksButton" value="Clear" style="" title="clear both boxes">Clear</button><!--
--><button class="cssbutton" id="addLockButton" value="Save" style="" title="save lower box into the local directory with the name given in the upper box | if lower box is empty, make random item">Save</button><!--
--><button class="cssbutton" id="removeLockButton" value="Delete" style="" title="delete the item whose name is displayed">Delete</button><!--
--><button class="cssbutton" id="resetPFSButton" value="Reset" style="" title="reset PFS data for the item whose name is displayed | if a List is displayed, clear the current List">Reset</button>
    </div>
		<textarea class="cssbox" id="lockBox" style="" name="text" rows="9" placeholder="Enter Locks and shared Keys here.   If you want to save it, first enter a name for it in the box above."></textarea>
	<div align="center" id="basiclockbuttonsbot" class="texter" style="display: block;">
     <button class="cssbutton" id="lock2dirButtonBasic" value="Directory" style="font-size:22px;padding:14px" title="open a screen containing the general PassLok directory (alt-G)" accesskey="g">General Directory</button>
    </div>
	<div align="center" id="lockbuttonsbot" class="texter" style="display: none;">
	<button class="cssbutton" id="addToListButton" value="List" style="" title="if lower box is empty display the current List, otherwise add box contents to the current List">List</button><!--
--><button class="cssbutton" id="showLockDBButton" value="All" style="" title="show the entire local directory">All</button><!--
--><button class="cssbutton" id="mergeLockDBButton" value="Merge" style="" title="merge lower box contents into the local directory | Diffie-Hellman merge of this and the main screen contents">Merge</button><!--
--><button class="cssbutton" id="moveLockDBButton" value="Move" style="" title="archive entire local directory, then delete it">Move</button><br />
<button class="cssbutton" id="lock2dirButton" value="Directory" style="" title="open a screen containing the general PassLok directory (alt-G)" accesskey="g">General Directory</button>
    </div>
    </div>

<!--Options tab-->
<div class="tabContent" id="optionsTab">
	<br /><br />
    &nbsp;&nbsp;Interface:<br /><br />&nbsp;&nbsp;<input type="radio" name="interfacemodes" id="basicmode"  title="basic mode; only essential functions (alt-B)" accesskey="b" checked/>&nbsp; Basic&nbsp;&nbsp;
        <input type="radio" name="interfacemodes" id="advancedmode" title="advanced mode; all functions available (alt-B)" accesskey="b"/>&nbsp; Advanced
        <hr>
        &nbsp;&nbsp;Locking mode:<br /><br />&nbsp;&nbsp;<input type="radio" name="lockmodes" id="anonmode"  title="anonymous locking mode; recipient's Lock needed (alt-A)" accesskey="a" checked/>&nbsp; Anonymous&nbsp;&nbsp;
        <input type="radio" name="lockmodes" id="signedmode" title="signed locking mode; recipient needs the sender's Lock (alt-N)" accesskey="n"/>&nbsp; Signed&nbsp;&nbsp;
        <input type="radio" name="lockmodes" id="pfsmode" title="Perfect Forward Secrecy: messages become unlockable after exchange (alt-P)" accesskey="p"/>&nbsp; PFS
        <hr>
        &nbsp;&nbsp;Other modes:<br /><br />
    	&nbsp;&nbsp;<input type="checkbox" id="shortmode" title="locked message will fit within 160 characters (alt-R)" accesskey="r"/>&nbsp; Short&nbsp;&nbsp;&nbsp;
        &nbsp;&nbsp;<input type="checkbox" id="decoymode" title="second message added or retrieved (alt-Y)" accesskey="y"/>&nbsp; Decoy
      	&nbsp;&nbsp;<input type="checkbox" id="ezLok" title="display easy to read Lock" checked/>&nbsp; ezLok<br /><br />
    	&nbsp;&nbsp;<input type="checkbox" id="notags" title="no identifying tags or preformatted text (alt-T)" accesskey="t"/>&nbsp; No tags
      &nbsp;&nbsp;<input type="checkbox" id="learnmode" title="get explanatory messages after buttons are pressed, but before functions are executed"/>&nbsp; Learn
      &nbsp;&nbsp;<input type="checkbox" id="checkKey" title="check that the Key entered is the last used" checked/>&nbsp; Check Key
      <hr>
      <button class="cssbutton" id="changeKeyButton" value="Change" style="" title="re-encrypt directory with a new Key">Change Key</button>&nbsp;&nbsp;
      <button class="cssbutton" id="backupSettings" value="Backup" style="" title="backup and optionally reset options, including the email/token">Backup/Reset options</button>
      <hr>
      &nbsp;&nbsp;<span id="filemsg">File In/Out (Chrome, Firefox, Safari)</span><br /><br />
          	<input class="custom-file-input" type="file" id="fileToLoad" style="" title="open dialog to select file to load"/>
        <button class="cssbutton" id="savefileButton" value="Save" title="save file to default Downloads folder in original format, or as a text file if type is not recognized">Save</button>
    </div>

<!--Help tab-->
<div class="tabContent" id="helpTab">
<br />
<div id="helptop" style="position:fixed; background-color: white; width: 100%; top: 41px; display: none">
<br />
<span id='helpmsg'>For instructions on how to do things, click on each title below. Click again to hide.</span>
<br />
<!--search box, as an iframe-->
<iframe id="srchform2"
src="javascript:'<html><body style=margin:0px; ><form action=&quot;javascript:void();&quot; onSubmit=if(this.t1.value!=&quot;&quot;)parent.findString(this.t1.value);return(false); ><input type=text id=t1 name=t1 placeholder=Text&nbsp;to&nbsp;find size=20><input type=submit name=b1 value=Search&nbsp;titles></form></body></html>'"
 width=220 height=50 border=0 frameborder=0 scrolling=no seamless>
</iframe>
</div>

<br /><!--space so the items aren't buried below the fixed stuff-->

<div id="helpspace" style="background-color: white; display: none">
<br /><br /><br /><br /><br />
</div>

<div id="helptopmobile" style="display: block">
<p>For instructions on how to do things, click on each title below. Click again to hide.</p>
<p>To get instructions as you click buttons in PassLok, check <strong>Learn</strong> in the <strong>Options</strong> tab.</p>
</div>

<!--the help items begin here-->
<hr>
    <div id="aa1" style="cursor:pointer">
	<h3>What is PassLok?</h3>
    </div>
    <div id="a1" class="texter">
    <p>Before you do anything else, you may want to watch this six-minute video, which explains the essential concepts in a lighthearted way: <a href="https://www.youtube.com/watch?v=GqIm7fu_rMs" target="_blank">https://www.youtube.com/watch?v=GqIm7fu_rMs</a></p>
      <ul>
  	  <li>PassLok locks text and files using strong encryption.</li>
  	  <li>PassLok is based on Keys and Locks. You lock something with <strong>someone else's Lock</strong>, so only that person can unlock it with his/her Key.</li>
  	  <li>Your Key is a short piece of text, which <strong>can be anything you want so you can remember it</strong>.</li>
  	  <li>The matching Lock is then made from your Key, plus a public piece of data such as your email. It is impossible to get the Key or your email from the Lock.</li>
  	  <li>You should never give your Key to anyone. Your Lock, however, is meant to be distributed freely, like a phone number.</li>
      </ul>
  	<p>This approach has a number of advantages over other privacy apps that you may be familiar with:</p>
  	<ul>
  	  <li>PassLok does not involve a server, so it runs offline.</li>
  	  <li>The same code runs on computers, phones, and tablets, to make it perfectly portable.</li>
  	  <li>You can use PassLok with your favorite email or texting app, or any program, by cut and paste.</li>
  	  <li>PassLok does not need to store anything secret. The only secret is your Key, which stays in your head.</li>
      <li>You can use PassLok with a public or borrowed device as easily and safely as with your private phone or computer.</li>
      </ul>
  	<p>PassLok is <strong>still in experimental phase</strong>, and there has not been enough time for security experts to uncover possible flaws. Bear this in mind before entrusting critical secrets to it.</p>
  </div>
  <hr>

  <div id="aa2" style="cursor:pointer">
<h3>How to make a strong Key</h3>
</div>
	<div id="a2" class="texter">
<p>You should be able to <strong>remember your secret Key</strong> without having to write it down. PassLok does not store the Key anywhere. In fact, it deletes it from memory after five minutes of not being used (this can be changed).</p>
<p>Your Key will be stronger if it contains <strong>caPiTals</strong> in unusual places,
  <strong>numb3rs</strong>, and <strong>$ymbol$</strong>. If you use common words, <strong>miespell</strong> them to make harder a "dictionary attack." Break the words up with num<strong>334</strong>bers and sy<strong>#$%</strong>mbols. Avoid anything that might be easy to guess. Hackers know frequently used words; so does PassLok.</p>
<p>PassLok <strong>compensates for weak Keys by adding spurious computations</strong>. If PassLok is slow, this may be because your Key strength is less than Medium.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=JbNM_cf8My0" target="_blank">https://www.youtube.com/watch?v=JbNM_cf8My0</a></p>
</div>
  <hr>

  <div id="aa3" style="cursor:pointer">
<h3>Change the secret Key</h3>
</div>
<div id="a3" class="texter">
<p>1. Click the <strong>Change Key</strong> button on the <strong>Options</strong> tab. A new dialog will pop up asking you to enter the new Key twice.</p>
<p>2. Write the new Key in the two boxes in this dialog, and then click <strong>OK</strong>. A message will announce that the Key has changed. </p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=LubzBF4Xaa8" target="_blank">https://www.youtube.com/watch?v=LubzBF4Xaa8</a></p>
<div id='bb3' style="cursor:pointer">
  <p><em>Click here for More:</em></p>
</div>
<div id="b3" class="texter">
  <p>The items in the local directory are encrypted with your Key. This operation re-encrypts them with the new Key. Your Key is not stored anywhere, not even encrypted, but PassLok is still able to check whether the Key entered is the one in use. If this feature causes problems, you can turn it off in the <strong>Options</strong> tab.</p>
</div>
</div>
  <hr>

  <div id="aa4" style="cursor:pointer">
<h3>Make PassLok remember the secret Key for the current session</h3>
</div>
<div id="a4" class="texter">
<p>First, you must be aware that retaining the Key anywhere could lead to compromising it. This is why PassLok's default behavior is to forget the Key if it doesn't get used for five minutes. Still, you can make PassLok remember the Key for the current session by just checking the <strong>Remember</strong> checkbox when you enter your Key.</p>
<p>If you asked PassLok to remember your Key, make sure to close the app completely when you're done. On a mobile device, this may involve removing the app in the switcher screen.</p>
<p>There is no way to make PassLok remember your Key between sessions.</p>
</div>
  <hr>

  <div id="aa52" style="cursor:pointer">
<h3>Make PassLok even more secure</h3>
</div>
<div id="a52" class="texter">
<p>When you first opened PassLok, you were asked to also enter your email or similar public, easy to recall personal information. But if instead of entering your email you click the <strong>Random</strong> button next to the input box, an 86-character random token is used. This makes your Lock  impossible to crack even if your Key is weak, but it becomes tied to the device where it was created.</p>
<p>To back up your random token to a safe place in case of accidental deletion or to be able to use a different device:</p>
<p>1. Click the <strong>Backup/Reset options</strong> button on the <strong>Options</strong> tab. A backup item bracketed by &quot;PL**bak&quot; tags appears on the main box, from where you can save it to file, copy it, email it, etc.</p>
<p>2. Then a dialog asks you if you want to reset your settings. If you click <strong>OK</strong>, PassLok will restart as if it had never started before, except that the local directory remains intact.</p>
<p>To restore the random token from a backup item, just paste the packup into the main box and click <strong>Lock/Unlock</strong>. </p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=4DjhIjU_nuM" target="_blank">https://www.youtube.com/watch?v=4DjhIjU_nuM</a></p>
<div id='bb52' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b52" class="texter">
<p>The reason for the email or other additional data is to combat the &quot;rainbow table&quot; attack, where hackers pre-compute Locks made from the words in a dictionary. This data is encrypted and stored along with other settings, so you won't need to enter it again. The Lock depends both on the Key and the email or random token; this adds extra security, but it also means that if the random token gets erased you will not be able to unlock anything locked with your Lock. The backup item contains your settings, including the random token, double-encrypted by your secret Key. One reason to delete your settings while leaving the local directory intact is to be able to change the random token to a new value.</p>
</div>
</div>
  <hr>

  <div id="aa5" style="cursor:pointer">
<h3>Make the Lock matching your secret Key</h3>
</div>
<div id="a5" class="texter">
<p>Click the <strong>myLock</strong> button on the <strong>Main</strong> tab. The lock matching that Key will appear
  in the lower box, from where you can copy it or email it.</p>
<p>If then you go to the <strong>Directory</strong> tab and click the button labeled <strong>General Directory</strong>, PassLok's General Directory website will open, with its lower box filled with the Lock you just made. To post your Lock so others can find it, just write your email in the upper box and click the <strong>Post</strong> button.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=L00yybDzN6k" target="_blank">https://www.youtube.com/watch?v=L00yybDzN6k</a></p>
<div id='bb5' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b5" class="texter">By default, PassLok displays the Lock in ezLok format, consisting only of smallcase letters (except the L) and numbers, so it is easier to authenticate by reading aloud a portion of it. To display it in base64 format, which is the format of all other PassLok items, go to the <strong>Options</strong> tab and uncheck <strong>ezLok</strong>. The General Directory can take ezLok Locks as well as base64 Locks.</div>
</div>
  <hr>

  <div id="aa6" style="cursor:pointer">
<h3>Lock a message with a Lock, to be unlocked with the matching Key (anonymous mode)</h3>
</div>
  <div id="a6" class="texter">
<p>1. If the recipients' Locks have been previously stored in the local directory, simply select their names in the top box of the <strong>Main</strong> tab. </p>
 <ul>
   <li>If not, go to the <strong>Directory</strong> tab and paste the Locks, one per line, in the lower box.</li>
 </ul>
 <p>2. Write or paste your message in the lower box of the <strong>Main</strong> tab.</p>
 <p>3. Click the <strong>Lock/Unlock</strong> button. The
   locked message will appear in the box, replacing the original message.</p>
 <p>Copy it and paste it into your
   communications program or click <strong>Email</strong> to open your default email. </p>
 <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=nBA5JNY4gmQ" target="_blank">https://www.youtube.com/watch?v=nBA5JNY4gmQ</a></p>
<div id='bb6' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b6" class="texter">
<p>This message can only be unlocked by
   someone having the Key matching one of the Locks selected. Alternatively, you can retrieve a stored Lock by  beginning to type the name associated with it in the top box of the <strong>Directory</strong> tab, until the encrypted Lock appears in the lower box. You can also write the names, one per line, in the lower box. It is okay if the tags up to the "=" signs
   on the Lock are missing, or extra spaces, carriage returns, or special characters
  other than = + or / have been added (such as a video URL). In Android, Locks are truly selected only after the top box is deselected.</p>
</div>
</div>
  <hr>

  <div id="aa7" style="cursor:pointer">
<h3>Unlock an anonymous locked message (tags
  are PL**msa)</h3>
  </div>
  <div id="a7" class="texter">
<p>1. Paste the locked message in the lower box of the <strong>Main</strong> tab.</p>
<p>2. Click the <strong>Lock/Unlock</strong> button. The unlocked message
  will appear in the box, replacing the locked message.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=nBA5JNY4gmQ" target="_blank">https://www.youtube.com/watch?v=nBA5JNY4gmQ</a></p>
<div id='bb7' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b7" class="texter">
<p>It is okay if the message is broken up by
  spaces, carriage returns, and special characters other than = + / or % or is
  missing its tags.</p>
</div>
</div>
  <hr>

  <div id="aa8" style="cursor:pointer">
<h3>Send a PassLok item (Lock, message, etc.) by email</h3>
  </div>
  <div id="a8" class="texter">
<p>1. Check that the item is displayed on the <strong>Main</strong> tab.</p>
<p>2. Click the <strong>Email</strong> button. If the device is so configured, a window appears containing the item and some explanatory text. You only need to supply the recipient's email address and a subject line before clicking the Send button.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=LsljKvjAi9I" target="_blank">https://www.youtube.com/watch?v=LsljKvjAi9I</a></p>
<div id='bb8' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b8" class="texter">
<p>If you do not want any explanatory text accompanying the email, check the <strong>No tags</strong> checkbox in the <strong>Options</strong> tab before clicking <strong>Email</strong>. This procedure only works for sending emails, not for receiving them. If you receive a PassLok-locked message, you must copy it to the clipboard and then paste it into the <strong>Main</strong> tab of PassLok, so it can be unlocked. Be also aware that webmail services, such as Gmail, limit the length of messages that can be composed this way. If you get an error from the mail host, you can always copy the contents of the box and paste it into a normal mail compose screen.</p>
</div>
  </div>
  <hr>

  <div id="aa9" style="cursor:pointer">
<h3>Lock a message with a Lock, to be unlocked with the matching Key, and sign it with your secret Key (signed mode)</h3>
  </div>
  <div id="a9" class="texter">
<p>1. On the <strong>Options</strong> tab, make sure the <strong>Signed</strong> button is selected.</p>
        <p>2. If the recipients' Locks have been previously stored in the local directory, simply select their names in the top box of the <strong>Main</strong> tab.</p>
        <ul>
          <li>If not, go to the <strong>Directory</strong> tab and paste the Locks, one per line, in the lower box.        </li>
        </ul>
        <p>3. Write or paste your message in the lower box of the <strong>Main</strong> tab.</p>
    <p>4. Click the <strong>Lock/Unlock</strong> button. The
    locked message will appear in the box, replacing the original message.</p>
    <p>Copy it and paste it into your
      communications program or click <strong>Email</strong> to open your default email.</p>
    <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=R9UanENF3ro" target="_blank">https://www.youtube.com/watch?v=R9UanENF3ro</a></p>
<div id='bb9' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b9" class="texter">
<p> This message can only be unlocked by
  someone having the Key matching one of the Locks selected, and your Lock. Alternatively, you can retrieve a stored Lock by  beginning to type the name associated with it in the top box of the <strong>Directory</strong> tab, until the encrypted Lock appears in the lower box. You can also write the names, one per line, in the lower box. It is okay to strip the tags up to the "=" sign, but not recommended. PassLok will do this automatically if the No tags checkbox is checked prior to locking. It is also okay to split the locked message with spaces, line returns, and punctuation other than = + / or % This message can only be unlocked by someone having the Key matching the Lock used to lock it. Additionally, they must have your Lock in order to verify that it comes from you.</p>
</div>
  </div>
  <hr>

  <div id="aa10" style="cursor:pointer">
<h3>Unlock a message  signed with the sender's Key (tags are PL**mss)</h3>
</div>
  <div id="a10" class="texter">
<p>1. If the sender's Lock has been previously stored in the local directory, simply select its name in the top box of the <strong>Main</strong> tab.</p>
    <ul>
      <li>If not, go to the <strong>Directory</strong> tab and paste the Lock in the lower box.    </li>
    </ul>
    <p>2. Paste the locked message in the lower box of the <strong>Main</strong> tab. </p>
    <p>3. Click the <strong>Lock/Unlock</strong> button. The unlocked message
        will replace the locked message.</p>
    <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=R9UanENF3ro" target="_blank">https://www.youtube.com/watch?v=R9UanENF3ro</a></p>
<div id='bb10' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b10" class="texter">
<p>Alternatively, you can retrieve the sender's stored Lock by typing the name associated with it in the top box of the <strong>Directory</strong> tab until the encrypted Lock appears on the lower box. It is okay if the message is broken up by spaces, carriage returns, and special characters other than = + / or % or is missing its tags.</p>
</div>
  </div>
      <hr>

  <div id="aa11" style="cursor:pointer">
<h3>Lock a message so that nobody can read it after the exchange is over (PFS mode)</h3>
  </div>
  <div id="a11" class="texter">
<p>1. On the <strong>Options</strong> tab, make sure the PFS mode button is selected.        </p>
        <p>2. Select the recipients' Locks in the top box of the <strong>Main</strong> tab. This mode requires the recipients' Locks to be previously stored in the local directory.        </p>
        <p>3. Write or paste your message in the lower box of the <strong>Main</strong> tab.</p>
        <p>4. Click the <strong>Lock/Unlock</strong> button. The
    locked message will appear in the box, replacing the original message.</p>
        <p>Copy it and paste it into your
    communications program or click <strong>Email</strong> to open your default email.</p>
        <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=VutWfWZW5bY" target="_blank">https://www.youtube.com/watch?v=VutWfWZW5bY</a></p>
<div id='bb11' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b11" class="texter">
<p>This message can only be unlocked by
  someone having the Key matching one of the Locks selected, and your Lock. If you are restarting a PFS conversation that was interrupted, you must first clear the old PFS data for that recipient by clicking the <strong>Reset</strong> button in the <strong>Directory</strong> tab after the recipient's name is displayed above the upper box.  If Short mode is used, locking cannot be repeated without corrupting the PFS data stored in the device, which will make it impossible for the recipient to unlock the message (unless it is re-locked as a regular length message). Make sure your plain message is what you want before clicking <strong>Lock/Unl</strong>ock. This restriction does not apply to regular length messages, but you will get a warning alerting you if you are skipping a turn.  It is okay to strip the Lock tags up to the "=" sign, but not recommended.
          PassLok will do this automatically if the No tags checkbox is checked prior to locking. It is
          also okay to split the locked message with spaces, line returns, and
      punctuation other than = + / or %</p>
</div>
  </div>
  <hr>

  <div id="aa12" style="cursor:pointer">
<h3>Unlock a message  that was locked in PFS mode (tags are PL**msp)</h3>
</div>
  <div id="a12" class="texter">
<p>1. Select the sender's Lock on the top box of the <strong>Main</strong> tab. This mode requires the sender's Lock to be previously stored in the device's local directory.</p>
      <p>2. Paste the locked message in the lower box of the  <strong>Main</strong> tab.</p>
      <p>3. Click the <strong>Lock/Unlock</strong> button. The unlocked message
        will replace the locked message.</p>
      <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=VutWfWZW5bY" target="_blank">https://www.youtube.com/watch?v=VutWfWZW5bY</a></p>
<div id='bb12' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b12" class="texter">
<p>If this was a Short mode message, it can be unlocked only once. Attempting to unlock it again will corrupt the PFS data stored in the device, which is needed to keep the conversation going.  This restriction does not apply to regular length messages, but you will get a warning alerting you that a turn was skipped. It is okay if the message is broken up by
        spaces, carriage returns, and special characters other than = + / or % or is
      missing its tags.</p>
</div>
  </div>
      <hr>

  <div id="aa13" style="cursor:pointer">
<h3>Lock a message with a shared Key, to be unlocked with the same Key</h3>
</div>
      <div id="a13" class="texter">
<p>1. If the Keys shared with each of the recipients have been previously stored in the local directory, simply select their names in the top box of the <strong>Main</strong> tab.</p>
<ul>
  <li>If not, go to the <strong>Directory</strong> tab and paste the shared Keys, one per line, in the lower box. You can mix shared Keys and Locks.</li>
</ul>
<p>2. Write or paste the message in the lower box of the <strong>Main</strong> tab.</p>
<p>3. Click the <strong>Lock/Unlock</strong> button. The
  locked message will appear in the box, replacing the original text.</p>
<p>Copy it and paste it into your
  communications program or click <strong>Em</strong><strong>ail</strong> to open your default email program. </p>
<p>This and more is explained in this video tutorial:<a href="https://www.youtube.com/watch?v=sRdpWe4zya8" target="_blank">https://www.youtube.com/watch?v=sRdpWe4zya8</a></p>
<div id='bb13' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b13" class="texter">
<p>This message can only be unlocked by
  someone having the same shared Key. It does not matter which of the radio buttons in the <strong>Options</strong> tab is selected, since they do not apply to this mode. Alternatively, you can search for a stored shared Key by typing the name associated with it in the top box of the <strong>Directory</strong> tab. When you type "Enter", the stored Key is decrypted for you to see.It is okay to strip the tags up to the "=" sign, but not recommended;
  PassLok will do this automatically if the No tags checkbox is checked prior to locking. It is
  also okay to split the locked message with spaces, line returns, and
  punctuation other than = + / or % The tags will depend on the type of locking selected for using Locks. There is no special tag to indicate that a shared Key was used instead of a Lock.</p>
</div>
  </div>
  <hr>

  <div id="aa14" style="cursor:pointer">
 <h3>Unlock a message locked with a shared Key</h3>
</div>
      <div id="a14" class="texter">
<p>1. If the Key shared with the sender has been previously stored in the local directory, simply select its name in the top box of the <strong>Main</strong> tab.</p>
<ul>
  <li>If not, go to the <strong>Directory</strong> tab and paste it in the lower box.</li>
</ul>
<p>2. Paste the locked message in the lower box of the <strong>Main</strong> tab.</p>
<p>3. Click the <strong>Lock/Unlock</strong> button. The unlocked message
  will appear in the main box, replacing the locked message.</p>
<p>This and more is explained in this video tutorial:<a href="https://www.youtube.com/watch?v=sRdpWe4zya8" target="_blank">https://www.youtube.com/watch?v=sRdpWe4zya8</a></p>
<div id='bb14' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b14" class="texter">
<p>It is okay if the message is broken up by
  spaces, carriage returns, and special characters other than = + / or % or is
  missing its tags.</p>
</div>
</div>
  <hr>

    <div id="aa15" style="cursor:pointer">
    <h3>Make a short locked message suitable for texting</h3>
</div>
<div id="a15" class="texter">
<p>1. On the <strong>Options</strong> tab, check the <strong>Short</strong> checkbox. Also make sure the appropriate locking mode is selected with the radio buttons.</p>
<p>2. If the recipient's Lock of shared Key has been previously stored in the local directory, simply select its name in the top box of the <strong>Main</strong> tab.</p>
<ul>
  <li>If not, go to the <strong>Directory</strong> tab and paste the Lock in the lower box. Short mode is not available for multiple recipients.</li>
</ul>
<p>3. Write or paste your message into the lower box of the <strong>Main</strong> tab.</p>
<p>4. Click the <strong>Lock/Unlock</strong> button. The locked message will appear in the box, replacing the original message.</p>
<p>Copy it and paste it into your communications program. </p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=pD-uvyxKBgQ" target="_blank">https://www.youtube.com/watch?v=pD-uvyxKBgQ</a></p>
<div id='bb15' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b15" class="texter">
<p>The locked
  message, which has no tags, will fit within one SMS message (160
  characters). The radio buttons don't matter if the message is being locked with a shared Key.   A message above the main box will tell you how much space is left, depending on the locking mode selected. On a mobile device, the locked message will be selected and ready to be copied into the clipboard. <strong>You need to copy it</strong> manually before clicking the <strong>Text/Img</strong> button, which will open your texting app.  Message length is limited to 58
  ASCII characters when locking with a shared Key or in signed mode, 38 in anonymous mode, 37 in PFS mode. Non-ASCII characters use 6 spaces each, so avoid them if
  you can. Any text beyond the limit will be lost.</p>
</div>
</div>
  <hr>

  <div id="aa16" style="cursor:pointer">
<h3>Unlock a short locked message (no tags)</h3>
  </div>
  <div id="a16" class="texter">
<p>1. If the message was locked in Signed or PFS mode, or with a shared Key, you will need to select the appropriate item in the top box of the <strong>Main</strong> tab, or enter it in the <strong>Directory</strong> tab, as described above.</p>
    <p>2. Paste the locked message in the lower box of the <strong>Main</strong> tab.</p>
    <p>3. Click the <strong>Lock/Unlock</strong> button. The unlocked message will appear in the box, replacing the locked message.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=pD-uvyxKBgQ" target="_blank">https://www.youtube.com/watch?v=pD-uvyxKBgQ</a></p>
<div id='bb16' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b16" class="texter">
<p>It is okay if the message is broken up by
      spaces, carriage returns, and special characters. If the message was locked in PFS mode, you can unlock it only once, since this action erases the Key needed to unlock it.</p>
</div>
  </div>
  <hr>

<div id="aa17" style="cursor:pointer">
<h3>Add a Lock to the local directory</h3>
</div>
    <div id="a17" class="texter">1. Write a name for the Lock in the top box of the <strong>Directory</strong> tab.
      <ul>
        <li>Note, if a lock is displayed in the lower box, it means the name you entered is already in the local directory, and the  Lock will be replaced rather than added.</li>
      </ul>
      <p>2. Paste the Lock in the lower box, replacing whatever was there before.</p>
      <p>3. Click the <strong>Save</strong> button. A message confirms that the Lock has been saved under the name given.</p>
      <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=vQrED7eIkLA" target="_blank">https://www.youtube.com/watch?v=vQrED7eIkLA</a></p>
<div id='bb17' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b17" class="texter">
<p>You can store a number of things besides somebody's Lock: a shared Key, a cover text, a List. In the case of a List, the given name will be bracketed by double dashes. (<em>Chrome app only</em>) The item will also be added to the Chrome sync area, so it is available on a different computer after you log into Chrome.</p>
</div>
    </div>
    <hr>

 <div id="aa18" style="cursor:pointer">
<h3>Retrieve a Lock from the local directory</h3>
</div>
      <div id="a18" class="texter">
<p>1. Start writing the name of the Lock in the top box of the <strong>Directory</strong> tab. As you type, the line above the box displays existing names that match what you have typed so far, and the encrypted Lock appears in the lower box.</p>
       <ul>
         <li>If you want to display the decrypted version of the Lock, press the Enter key after the name appears on the upper line. </li>
       </ul>
       <p>2. PassLok can use the Lock in encrypted form, but if you want to see the original, you can type "Enter" after the correct name is displayed on the top message line, and the Lock will be decrypted.</p>
       <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=vQrED7eIkLA" target="_blank">https://www.youtube.com/watch?v=vQrED7eIkLA</a></p>
<div id='bb18' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b18" class="texter">
<p> You can stop typing once you see the complete name for the Lock you're looking for. The process also works for shared Keys, Lists, and cover texts stored in the local directory. Search is case-insensitive, so if the Lock does not appear, this probably means that the name is wrong. If the item is a cover text, it loads automatically as new cover text.(<em>Chrome app only</em>) If you type "Enter" after a name that was not found on the local database, PassLok will look for it in its Chrome sync area, which syncs across computers, and then adds it to the local directory.</p>
</div>
      </div>
     <hr>

<div id="aa19" style="cursor:pointer">
 <h3>Delete a stored Lock</h3>
</div>
  <div id="a19" class="texter">
<p>1. Start writing the name of the Lock in the top box of the <strong>Directory</strong> tab. As you type, the line above the box displays existing names that match what you have typed so far, and the encrypted Lock appears in the lower box. </p>
       <p>2. Click the <strong>Delete</strong> button. A message confirms that the Lock has been deleted from the local directory.</p>
       <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=vQrED7eIkLA" target="_blank">https://www.youtube.com/watch?v=vQrED7eIkLA</a></p>
<div id='bb19' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b19" class="texter">
<p>You can stop typing once you see the complete name for the Lock you are looking for. This process also works for shared Keys, Lists, and cover texts stored in the local directory. Search is case-insensitive, so if the Lock does not appear, that probably means the name is wrong. (<em>Chrome app only</em>) If the Chrome sync area is accessible from the computer, the item will also be deleted from there, after a confirmation popup.</p>
</div>
  </div>
  <hr>

   <div id="aa20" style="cursor:pointer">
  <h3>Make a video to authenticate your Lock</h3>
  </div>
 <div id="a20" class="texter">
 <p>What should the video include:</p>
	<ul>
	<li> Identify yourself (First and Last name or other).</li>
	<li> Write your Lock on a sign and display it, and read a portion of it out loud (say, the first 12 characters after the initial tag).</li>
	<li>Make sure to distinguish capitals from smallcase letters.</li>
	<li> The video should be short, only a few seconds long (short video).</li>
	<li> Play a song in the background to ensure the video is not tampered with (recommended).</li>
</ul>

<p>What to do with the video: </p>
<ul>
	  <li> Upload the video to the Web.</li>
	  <li> Post the video in the General Directory on the line immediately below  your Lock.</li>
	  <li>For more instructions on this, go to How to add an authentication video under the General Directory help.      </li>
</ul>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=zkcqEz3UjnM" target="_blank">https://www.youtube.com/watch?v=zkcqEz3UjnM</a></p>
<div id='bb20' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b20" class="texter">
<p>It is highly recommended that you make a video whenever you change your secret Key, so that others can be assured that the matching Lock really belongs to you. When you post your Lock so that people can use it to lock messages for you, write the address of the video on the line immediately below the Lock, to facilitate the verifying process. Video URLs don't affect the function of Locks, so it is OK to handle the Lock and its video address as a unit.</p>
</div>
 </div>
    <hr>

   <div id="aa21" style="cursor:pointer">
  <h3>Authenticate a Lock without using videos</h3>
  </div>
 <div id="a21" class="texter">
   <p>The easy way: call the Lock's owner and ask him/her to read  a substantial portion of the Lock over the phone. But let's say you cannot establish a live conversation. If you are communicating exclusively by email, you can send a person whom you know and who knows you the following message, or something like it:</p>
      <p><br />
        <em>Dear So-and-So:</em><br />
        <em>I just obtained your PassLok Lock from (cite source), but I still wonder if it is authentic since I am unable to view the authenticating video. Therefore, I ask you to help me authenticate it through the interlock protocol. Here's what I want you to do:</em></p>
      <ol>
        <li><em>Write a message asking me to take a picture or video of myself doing something of your choice. Lock the message with my Lock, which is appended to this message, and copy it to a safe place. Then split it in two and send me the first half only.</em></li>
        <li><em>When I receive your first half, I will also write a message asking you to do something in a picture or short video. I'll lock that message with your Lock, and I'll send you half of the locked message first. When you get it, go ahead and send me the other half of your locked message.</em></li>
        <li><em>When I get your second half, I'll put together the two halves together and unlock your message. Then, following your instructions I'll send you the picture or video right away, unlocked, along with the second half of my locked request.</em></li>
        <li><em>When you get it, please verify that what I sent conforms to your instructions. If so, put together the two halves of my locked message to you, unlock it, and send me what I ask in the message as soon as possible, unlocked as well. Then I'll know that your Lock is authentic.</em></li>
   </ol>
      <p><em>Many thanks. Sincerely, This-and-That</em></p>
<div id='bb21' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b21" class="texter">
<p>Alternatively, you can ask the other person to use PassLok's built-in Split/Join function, explained in another help item, rather than simply cutting messages in two.  The pictures or videos (or recordings) don't need to be locked. Only the instructions for making them need to be locked and transmitted with this two-step process. There is an article in the <a href="http://passlok.weebly.com/uploads/2/4/1/8/24187628/passlok_manual20.pdf" target="_blank">PassLok manual</a> that explains how this protocol works for authenticating Locks.</p>
</div>
</div>
<hr>

<div id="aa22" style="cursor:pointer">
      <h3>Use the General Directory</h3>
</div>
  <div id="a22" class="texter">
<p> The General Directory is a Web page that can store Locks and authentication videos associated with email addresses.</p>
<p> To get to the General Directory: Click the <strong>Directory</strong> tab. Then click the <strong>General Directory</strong> button.</p>
<ul>
  <li>If you are showing your Lock on the <strong>Main</strong> tab, it gets copied to the General Directory, ready for you to write your email address and click <strong>Post</strong>. </li>
  <li>Once you have found a Lock on the general directory, it gets copied automatically to the lower box of the <strong>Directory</strong> tab, so you only need to give it a name and click <strong>Save</strong>. </li>
</ul>
<p> The General Directory has its own Help page, which is structured like this one.    </p>
<p>This and more  is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=QQQ2df2vPgs" target="_blank">https://www.youtube.com/watch?v=QQQ2df2vPgs</a></p>
<div id='bb22' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b22" class="texter">
<p>PassLok does not guarantee the authenticity of the Locks posted on its General Directory. Email confirmation is required to post or update Locks, but this is not completely secure. Since users are encouraged to add authenticating videos and the General Directory has a button to play them, you should watch the video attached to a Lock before you use it.</p>
<p>The General Directory is meant as a convenience, not as a replacement for your local directory. The General Directory is not available when you are offline (the local one is). You cannot post anything but Locks on the General Directory.</p>
</div>
  </div>
  <hr>

  <div id="aa23" style="cursor:pointer">
  <h3>Load a file  to be locked, signed, or split</h3>
  </div>
  <div id="a23" class="texter">
    <p>1. Click the button at the bottom of the <strong>Options</strong> tab. Different browsers put different labels on it, such as <strong>"Browse"</strong>, <strong>"Choose File"</strong>, and so forth.</p>
  <p>2. A dialog will appear so you can navigate to the file. If all goes well, the file or image loads into the <strong>Main</strong> tab as a piece of gibberish text, with some identifying information at the top.</p>
  <p>Now you can lock it, sign it, or split it like a regular piece of text. The process to retrieve the original file is explained in the help item below.</p>
  <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=-ifIkdredqk" target="_blank">https://www.youtube.com/watch?v=-ifIkdredqk</a></p>
<div id='bb23' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b23" class="texter">
<p>Many mobile devices, unless they are jailbroken or rooted, restrict the user to images stored in the device or acquired with the built-in camera. Be aware that pictures taken by the camera are usually too large for PassLok to handle.</p>
</div>
  </div>
    <hr>

  <div id="aa24" style="cursor:pointer">
  <h3>Retrieve a file from encoded text</h3>
  </div>
    <div id="a24" class="texter">
      <p>1. Make sure the encoded file, which presumably has been obtained by unlocking or merging parts, is on the <strong>Main</strong> tab.  </p>
  <p>2. Click the <strong>Save file</strong> button at the bottom of the <strong>Options</strong> tab. What happens next depends on the browser. On mobile devices, usually you will be able to do something with the file by  long-clicking.</p>
  <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=-ifIkdredqk" target="_blank">https://www.youtube.com/watch?v=-ifIkdredqk</a></p>
<div id='bb24' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b24" class="texter">
<p>Chrome and Firefox will save the file, using the original name if not already taken by another file, into the default download location. Safari does the same, but gives it a generic name that you will have to edit later. Internet Explorer doesn't do anything. Mobile browsers normally open another tab displaying the file contents if the file type is recognized, and from there you can send it to another app.</p>
</div>
  </div>
    <hr>

  <div id="aa25" style="cursor:pointer">
<h3>Lock a second, undetectable message in addition to the main message
  (Decoy mode)</h3>
  </div>
  <div id="a25" class="texter">
    <p>1. On the <strong>Options</strong> tab, check the <strong>Decoy </strong>checkbox.</p>
<p>2. Follow the above instructions for any kind of locking. This also works when adding a signature. A popup will ask for a hidden message and a Decoy Password to lock it.</p>
<p>3. Input the Decoy Password and hidden message into the corresponding boxes. Then click <strong>OK</strong>. </p>
<p>The locked
  message containing both the main text and the hidden text will appear in
  the main box, replacing the original text. If it is a signature, it will be appended to the text. Copy it and paste it into your
  communications program.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=4WrYEdRp2Q4" target="_blank">https://www.youtube.com/watch?v=4WrYEdRp2Q4</a></p>
<div id='bb25' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b25" class="texter">
<p>It is impossible to tell whether or not a locked message contains a hidden message. The length of the hidden message is limited to
  152 ASCII characters in key-locked and signed modes, 87 characters in
  anonymous and PFS modes, 37 characters in short message mode (key-locked or signed only), 40 characters in signatures. Non-ASCII characters
  use 6 spaces each, so avoid them if you can. Any text beyond the limit will be lost. As with regular locked messages, it is okay to
  strip the tags up to the "=" sign, but not recommended. It is also okay to
  split the locked message with spaces, line returns, and punctuation other
  than = + / or %</p>
</div>
</div>
  <hr>

  <div id="aa26" style="cursor:pointer">
<h3>Reveal the hidden text contained within a message locked in Decoy
  mode</h3>
  </div>
  <div id="a26" class="texter">
<p>1. On the <strong>Options</strong> tab, check the <strong>Decoy </strong>checkbox.</p>
<p>2. Follow the instructions for any of the unlocking modes. A popup will ask for a Decoy Password.</p>
<p>3. Input the Decoy Password and click <strong>OK</strong>. The hidden message, if it exists,
  will appear above the main box.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=4WrYEdRp2Q4" target="_blank">https://www.youtube.com/watch?v=4WrYEdRp2Q4</a></p>
<div id='bb26' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b26" class="texter">
<p>Since it is impossible to detect the presence of a hidden message, it is necessary to click the <strong>Decoy</strong> checkbox in order to check for it. In the case of signatures, the hidden message appears in the place normally used by the verification message, so if you still wish to verify the signature, you need to uncheck <strong>Decoy</strong> and click <strong>Sign/Verify</strong> again so the signature verification message is displayed.</p>
</div>
</div>
  <hr>

  <div id="aa27" style="cursor:pointer">
<h3>Access the advanced functions of PassLok</h3>
  </div>
  <div id="a27" class="texter">
<p>PassLok launches first in Basic mode, so you are able to lock and unlock messages and perform the essential Key and Lock management functions. But PassLok has <strong>a lot</strong> more capabilities, which become available when you click the <strong>Advanced</strong> checkbox in the <strong>Options</strong> tab. To get back to Basic mode, click the <strong>Basic</strong> checkbox. PassLok will remember your choice of interface next time you open it.</p>
<p>Some advanced capabilities include:</p>
<ul>
<li>Apply a digital signature to a text, and verify its authenticity.</li>
<li>Hide PassLok's random-looking output inside images or as apparently normal text.</li>
<li>Hide a undetectable second message in addition to the main locked message.</li>
</ul>
<p>This and mode is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=Ttyvb0Qt7h0" target="_blank">https://www.youtube.com/watch?v=Ttyvb0Qt7h0</a></p>
  </div>
  <hr>

	<div id="aa28" style="cursor:pointer">
  <h3>Are there any keyboard shortcuts?</h3>
 </div>
  <div id="a28" class="texter">
    <p>The main functions in PassLok can be accessed directly from the keyboard. The button tooltips tell you what the shortcut is for each button that has a shortcut, but below is a complete list, just in case:    </p>
    <ul>
    <p>Alt-M: <strong>M</strong>ain tab</p>
    <p>Alt-D: <strong>D</strong>irectory tab</p>
    <p>Alt-H: <strong>H</strong>elp tab</p>
    <p>Alt-O: <strong>O</strong>ptions tab</p>
      <p>Alt-G: <strong>G</strong>eneral Lock directory open and close      </p>
      <p>Alt- <strong>.</strong> <em>(period)</em>: extra buttons open and close</p>
      <p>Alt-L: <strong>L</strong>ock or unlock </p>
      <p>Alt-V: sign or <strong>V</strong>erify</p>
      <p>Alt-E: send <strong>E</strong>mail</p>
      <p>Alt-B: switch <strong>B</strong>asic and Advanced modes      </p>
      <p>Alt-A: set <strong>A</strong>nonymous mode</p>
      <p>Alt-N: set sig<strong>N</strong>ed mode</p>
      <p>Alt-P: set <strong>P</strong>FS mode</p>
      <p>Alt-R: set sho<strong>R</strong>t mode</p>
      <p>Alt-T: set no <strong>T</strong>ags mode</p>
      <p>Alt-Y: set deco<strong>Y</strong> mode      </p>
      <p>Alt-I: <strong>I</strong>mage screen open and close</p>
      <p>Alt-J: split or <strong>J</strong>oin</p>
      <p>Alt-C: display or change <strong>C</strong>over text</p>
      <p>Alt-W: hide as <strong>W</strong>ords, or unhide</p>
      <p>Alt-S: hide as <strong>S</strong>paces, or unhide      </p>
      <p>Alt- <strong>;</strong> <em>(semicolon)</em>: put cursor on main box</p>
    </ul>
<div id='bb28' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b28" class="texter">
<p>The list is made for access from Windows or Linux, so that each shortcut is of the form Alt-<em>letter</em>. If you are using a Mac, you should type ctrl-alt-<em>letter</em> instead. Shortcuts do not work on mobile devices.</p>
</div>
  </div>
   <hr>

   <div id="aa29" style="cursor:pointer">
<h3>Check the authenticity of the code</h3>
</div>
<div id="a29" class="texter">
<p>If you got PassLok from an app store, that app store is ensuring that the code you have is what the author gave to them. The following is to check the integrity of an html version of PassLok running in a browser:</p>
<p>1. Direct your browser to "view source." If your browser has a command to save the source (Chrome, Firefox, and Safari do), go ahead and save it to file.</p>
<p>2. Now you have to take the SHA256 of the code using a program different from PassLok. You have several options:</p>
<ul>
<li>Use a local program or online utility to take the SHA256 of the source saved to a file.</li>
<li>Use an online utility where you paste the text on a box and click a button. You must make sure that pasting does not add extra space at the top or the bottom of the file, which would affect the result.</li>
</ul>
<p>3. Look up the SHA256 for this version of PassLok, which is published on the PassLok information website at passlok.weebly.com and a number of other places. If this value and the one obtained in step 2 are not the same, the program has been tampered with.</p>
<p>4. Now, a hacker who could alter the source code at the server might also be able to change the published SHA256 so it matches the tampered code. To make sure that the value is authentic you should watch the one-minute video where the author or PassLok, Francisco Ruiz, reads it aloud. A link to the video usually accompanies the published SHA256 value.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=NrAfSo2xjnY" target="_blank">https://www.youtube.com/watch?v=NrAfSo2xjnY</a></p>
<div id='bb29' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b29" class="texter">
<p>Typically, you load the source on a separate tab by typing CTRL-U (Windows) or option-cmd-u (OSX). Another way to save the source is to copy it by first selecting the the whole source code (CTRL-A or cmd-a), then copy to clipboard (CTRL-C or cmd-c), and then paste it into a text editor (CTRL-V or cmd-v), and save it from there. DO NOT save the code using the "save" command when the working PassLok page is displayed, since then the browser would modify the source code before saving it. The correct encoding is UTF-8, no BOM (notes: Windows Notepad is unable to save text in the correct format. Cut and paste from Chrome introduces artifacts for big items like the source code).</p>
<p>SHA256 is built into the OS in Linux and OSX, not so in Windows, but there are free programs available, such as Checksum Utility and Bitser. There are also online utilities where you can upload the file and get the hash. Online-convert (http://hash.online-convert.com/sha256-generator), fileformat.info (http://www.fileformat.info/tool/hash.htm) and freeformatter.com (http://www.freeformatter.com/sha256-generator.html) have worked well in our tests.</p>
<p>If you want a clipboard-based SHA256 utility, the one at Xorbin (http://www.xorbin.com/tools/sha256-hash-calculator) has worked quite well in our tests. Don't copy and paste from Chrome, since it introduces artifacts.</p>
<p>PassLok does have the ability to save anything contained in the main box to a text file by clicking the Save button, as well as to take the SHA256 of anything in the Locks screen, but be aware of the danger that these functions might have been tampered with.</p>
</div>
</div>
<hr>

  <div id="aa30" style="cursor:pointer">
<h3>Send a PassLok item by Text messaging (mobile only) <em>(advanced)</em></h3>
  </div>
  <div id="a30" class="texter">
<p>1. Check that the item to be sent is displayed on the <strong>Main</strong> tab.</p>
<p>2. Tap the <strong>Select</strong> button so the text can be selected.</p>
<p>3. Then tap the Copy label as it appears on screen. The item is copied to clipboard.</p>
<p>4. Tap the <strong>&#9660;</strong> button in order to reveal the button dealing with text messaging, which is labeled <strong>SMS</strong>, and tap it. A window appears with the default texting app.</p>
<p>5. Tap the input box and then paste the clipboard. Send the message in the usual way.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=LsljKvjAi9I" target="_blank">https://www.youtube.com/watch?v=LsljKvjAi9I</a></p>
<div id='bb30' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b30" class="texter">
<p>To unlock a locked message received by texting, you must first copy it to the clipboard, and then paste it on the <strong>Main</strong> tab of PassLok. If you use Short mode to lock a message, steps 2 and 3 are automatic.</p>
</div>
  </div>
<hr>

  <div id="aa31" style="cursor:pointer">
<h3>Sign a text with your secret Key <em>(advanced)</em></h3>
</div>
<div id="a31" class="texter">
<p>1. Write or paste the text to be signed in the lower box of the <strong>Main</strong> tab.</p>
  <p>2. Click the <strong>Sign/Verify</strong>
    button. A signature matching the text and your Key will be appended at the end of the text. Copy
    it or email it from there.</p>
  <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=QZvv1SJGh94" target="_blank">https://www.youtube.com/watch?v=QZvv1SJGh94</a></p>
<div id='bb31' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b31" class="texter">
<p>It is okay to strip the tags up to the "="
    sign, but not recommended. PassLok will do this automatically if the No tags checkbox is checked prior to locking.
    It is also okay to split the signature with spaces,
  and punctuation other than line returns or = + or /.</p>
</div>
</div>
  <hr>

  <div id="aa32" style="cursor:pointer">
<h3>Verify a signature attached to a text (signature tags are PL**sig) <em>(advanced)</em></h3>
</div>
<div id="a32" class="texter">
<p>1. If the signer's Lock has been previously stored in the local directory, simply select its name in the top box of the <strong>Main</strong> tab.</p>
<ul>
  <li>If not, go to the <strong>Directory</strong> tab and paste the Lock in the lower box. </li>
</ul>
<p>2. Paste the text, with its signature appended on a separate line at the end, in the lower box of the  <strong>Main</strong> tab.</p>
<p>3. Click the <strong>Sign/Verify</strong> button. A message above the main box will say whether
  or not the signature for that text has been verified.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=QZvv1SJGh94" target="_blank">https://www.youtube.com/watch?v=QZvv1SJGh94</a></p>
<div id='bb32' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b32" class="texter">
<p>It is okay
  if the signer's Lock is missing its tags up to the "=" signs , or extra spaces, carriage
  returns, or special characters other than = + or / have been added. This also goes for the signature, except that it should not be broken by carriage returns.</p>
</div>
</div>
    <hr>

 <div id="aa33" style="cursor:pointer">
 <h3>Reset the hidden information pertaining to a stored item (PFS, etc.) <em>(advanced)</em></h3>
 </div>
  <div id="a33" class="texter">
<p>1. Start writing the name of the item in the top box of the <strong>Directory</strong> tab. As you type, the line above the box displays existing items matching what you have typed so far, and the encrypted item appears in the lower box. You can stop typing once you see the complete name for the item you're looking for. Search is case-insensitive.</p>
          <p>2. Click the <strong>Reset</strong> button. A message confirms that the PFS data for the item has been deleted. You must reset the data pertaining to the other party whenever a PFS conversation has gone out of sync so the PFS process can be restarted.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=VutWfWZW5bY" target="_blank">https://www.youtube.com/watch?v=VutWfWZW5bY</a></p>
</div>
  <hr>

 <div id="aa34" style="cursor:pointer">
      <h3>Display the entire local directory <em>(advanced)</em></h3>
</div>
  <div id="a34" class="texter">
<p>Click the <strong>All</strong> button below the lower box of the <strong>Directory</strong> tab. The complete local directory, including PFS and hidden data, is displayed in the box so you can find items and copy them easily.</p>
     <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=8zo-N5O82iM" target="_blank">https://www.youtube.com/watch?v=8zo-N5O82iM</a></p>
<div id='bb34' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b34" class="texter">
<p>The format for each item is the following: name, followed by a colon (:), new line, item data; then two new lines before the next name, and so forth. If a name also has hidden data and PFS data, those follow the item data, occupying consecutive lines. Item 'myself' is special, and contains the Lock matching your secret Key and a collection of settings.</p>
</div>
  </div>
  <hr>

  <div id="aa35" style="cursor:pointer">
  <h3>Move the entire local directory <em>(advanced)</em></h3>
</div>
 <div id="a35" class="texter">
<p>1. Click the <strong>Move</strong> button below the lower box of the <strong>Directory</strong> tab. The entire directory is first locked with your secret Key, and then placed in the <strong>Main</strong> tab.</p>
      <p>2. Then a prompt asks you to confirm deleting it from the device. If you click <strong>OK,</strong> the entire local directory is deleted. If you click <strong>Cancel</strong>, the process ends and the directory contents are not deleted. In both cases the backup on the <strong>Main</strong> tab remains.</p>
      <p>3. To retrieve a backed-up directory (has PL**dir tags), place it in the <strong>Main</strong> tab and click <strong>Lock/Unlock</strong>. The database will be unlocked and placed in the <strong>Directory</strong> tab. Then you can add it to the device's current local directory by clicking <strong>Merge</strong>.</p>
      <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=8zo-N5O82iM" target="_blank">https://www.youtube.com/watch?v=8zo-N5O82iM</a></p>
<div id='bb35' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b35" class="texter">
<p>This process is useful whenever you stop using a device or just want to transfer it to another device. (<em>Chrome app only</em>) Even if the local directory is completely deleted, the items in your Chrome sync area remain available.</p>
</div>
 </div>
 <hr>

 <div id="aa36" style="cursor:pointer">
       <h3>Merge additional data into the local directory <em>(advanced)</em></h3>
</div>
  <div id="a36" class="texter">
<p>1. Paste the additional data into the lower box of the <strong>Directory</strong> tab.</p>
     <p>2. Click the <strong>Merge</strong> button. The new data is merged into the local directory.</p>
     <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=8zo-N5O82iM" target="_blank">https://www.youtube.com/watch?v=8zo-N5O82iM</a></p>
<div id='bb36' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b36" class="texter">
<p>The format for the additional data must be the following: name, followed by a colon (:), new line, item data; then two new lines before the next name, and so forth. If a name also has hidden data and PFS data, those follow the item data, occupying consecutive lines. If the additional data contains names that were already in use in the directory, the new data replaces the original data. Items are added in encrypted form but are not checked as they are added, so it is possible that different items may need different Keys to be decrypted, if you changed your secret Key in the past. (<em>Chrome app only</em>) If the Chrome sync area is accessible from the computer, the additional data will also be added to that area, so it is accessible from other computers.</p>
</div>
  </div>
  <hr>

 <div id="aa37" style="cursor:pointer">
     <h3>Use the List button <em>(advanced)</em></h3>
 </div>
  <div id="a37" class="texter">
<p>You can always make a List of Locks and shared Keys, in order to lock a message for multiple recipients, by writing the Locks or shared Keys in separate lines of the lower box in the <strong>Directory</strong> tab. Lists can be given names to save them in the local directory. Saved Lists appear highlighted in the top box of the <strong>Main</strong> tab. The <strong>List</strong> button facilitates making Lists this way:</p>
      <p>1. If you put several items on separate lines in the lower box of the <strong>Directory</strong> tab and click the <strong>List</strong> button, PassLok will remember them during the current session.</p>
      <p>2. To add one or several items to the List in memory, put them in the box and click<strong> List</strong> again. Duplicates are removed in the process.</p>
      <p>3. If you click <strong>List</strong> with the box empty, the current List in memory is displayed.</p>
      <p>4. If you click the <strong>Reset</strong> button while a List is displayed in the bottom box, the List in memory is deleted.</p>
      <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=m4Ki9DHTVow" target="_blank">https://www.youtube.com/watch?v=m4Ki9DHTVow</a></p>
<div id='bb37' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b37" class="texter">
<p>If you want to store a List permanently, you must first write a name for it in the top box, then write the items  in the lower box or display the List in memory by clicking the<strong> List</strong> button, and then click <strong>Save</strong>. Lists can contain Locks, shared Keys, or names of items in the local directory, but not names of other Lists.</p>
</div>
  </div>
     <hr>

  <div id="aa38" style="cursor:pointer">
  <h3>Make a random Key <em>(advanced)</em></h3>
  </div>
 <div id="a38" class="texter">
<p>PassLok has a built-in way to make a 86-character random Key: </p>
      <p>1. On the <strong>Directory</strong> tab, click <strong>Save</strong> with the lower box empty.</p>
   <p>2. If you actually want to save the random Key, write a name for it in the top box before you click <strong>Save</strong>.   </p>
   <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=3OUpuk3-tRo" target="_blank">https://www.youtube.com/watch?v=3OUpuk3-tRo</a></p>
 </div>
 <hr>

   <div id="aa39" style="cursor:pointer">
  <h3>Combine a Key and a Lock <em>(advanced)</em></h3>
  </div>
 <div id="a39" class="texter">
      <p>This operation, which goes by the technical name of "Diffie-Hellman key exchange,"  is at the core of many PassLok functions. Should you ever want to compute the result manually, here is how to do it:</p>
      <p>1. Write or paste the Key or the Lock on the <strong>Main</strong> tab.</p>
      <p>2. Write or paste the other item in the lower box of the <strong>Directory</strong> tab. If the item is in PassLok's local directory, you can bring it out by starting to type its name in the top box.</p>
      <p>3. Click the <strong>Merge</strong> button. The Key and the Lock will merge and the 86-character result is placed in both the <strong>Main</strong> and <strong>Directory</strong> tabs.</p>
      <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=0EImhN35Tbs" target="_blank">https://www.youtube.com/watch?v=0EImhN35Tbs</a></p>
<div id='bb39' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b39" class="texter">
<p>If both items or neither of them is a valid Lock, the merging process fails and a message is displayed. The result of combining your secret Key and someone's Lock is the same as that of combining your Lock and that person's secret Key.</p>
</div>
 </div>
 <hr>

<div id="aa40" style="cursor:pointer">
  <h3>Split an item into several random-looking parts <em>(advanced)</em></h3>
</div>
<div id="a40" class="texter">
  <p>1. Put the item in the lower box of the <strong>Main</strong> tab.</p>
  <p>2. Click the <strong>&#9660;</strong> button, if needed, and then click the <strong>Split/Join</strong> button.  </p>
  <p>3. A popup asks for the total number of parts to be made, and the minimum number required to retrieve the original. Enter those numbers, which must be between 2 and 255, and click <strong>OK</strong>. The parts appear in the main box, replacing the original item, and a message confirms it. Copy the parts one by one and send or store them as needed.</p>
  <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=ZdVHaD-FpSk" target="_blank">https://www.youtube.com/watch?v=ZdVHaD-FpSk</a></p>
<div id='bb40' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b40" class="texter">
<p>The parts are enclosed within tags of the PL**p^^^ form, where ^^^ is the minimum number of parts that are needed to reconstruct the original. It is okay to strip the tags of the resulting parts up to the "=" sign, but not recommended. PassLok will do this automatically if the No tags checkbox is checked prior to locking. It is also okay to split the parts with spaces and punctuation other than = + / or line returns.</p>
</div>
</div>
<hr>

<div id="aa41" style="cursor:pointer">
  <h3>Join parts to retrieve the original item (tags are PL**p^^^) <em>(advanced)</em></h3>
</div>
<div id="a41" class="texter">
  <p>1. Paste a sufficient number of parts on separate lines of the lower box in the <strong>Main</strong> tab. Make sure that each part is unique. </p>
  <p>2. Click the <strong>&#9660;</strong> button, if needed, and then the  <strong>Split/Join</strong> button. If all goes well, the reconstructed item appears in the box.</p>
  <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=ZdVHaD-FpSk" target="_blank">https://www.youtube.com/watch?v=ZdVHaD-FpSk</a></p>
<div id='bb41' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b41" class="texter">
<p>You need as many parts as the second number entered when the item was split, which is written at the end of each  PL**p^^^ tag. Having more parts than the minimum is okay, so long as they belong to the same set and are not corrupt. They don't need to be placed in any particular order. If nothing happens, likely causes include: insufficient number of parts, incomplete or corrupt parts, parts belonging to different sets.</p>
</div>
</div>
  <hr>

  <div id="aa42" style="cursor:pointer">
<h3>Convert a PassLok item (Lock, message, etc.) into fake text <em>(advanced)</em></h3>
  </div>
  <div id="a42" class="texter">
<p>1. Check that the item to be converted into fake text is on the <strong>Main</strong> tab. Then click the <strong>&#9660;</strong> button, if needed, to show the <strong>Words</strong> and <strong>Spaces</strong> buttons.</p>
<p>2. If you wish to use a cover text different from the default and you have stored it in the local directory, select it on the top box of the <strong>Main</strong> tab. Otherwise you will have to change it using the process described in the help item two places below this one.</p>
<p>3. If now you click the <strong>Words</strong> button, each character of the text is replaced by a word from the cover text. If you click the <strong>Spaces</strong> button, the original text is encoded into the spaces of the cover text.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=Px2JweWna6s" target="_blank">https://www.youtube.com/watch?v=Px2JweWna6s</a></p>
<div id='bb42' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b42" class="texter">
<p>The recipient of a Words-encoded text must have the same cover text in order to retrieve the original, but this is not necessary for Spaces-encoded text. The output of Spaces encoding is seven times longer than that of Words encoding. If the cover text is not long enough, it will be repeated several times and a warning message will tell you. If you used Spaces encoding, you should be careful not to add or delete any spaces within the encoded text, but it is okay to add more text to complete the last sentence, which may contain additional spaces.</p>
<p>Text-encoding is no substitute for real encryption, and so PassLok will refuse to convert into fake text anything that does not look like genuine PassLok output.</p>
</div>
  </div>
  <hr>

  <div id="aa43" style="cursor:pointer">
<h3>Retrieve the original PassLok item from fake text <em>(advanced)</em></h3>
  </div>
  <div id="a43" class="texter">
<p>1. Put the fake text on the <strong>Main</strong> tab.</p>
<p>2. Click the <strong>&#9660;</strong> button, if needed, followed by either the <strong>Words</strong> or the <strong>Spaces</strong> button (it doesn't matter which). If successful, the fake text is converted back into the original item and displayed in the box, replacing the fake text.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=Px2JweWna6s" target="_blank">https://www.youtube.com/watch?v=Px2JweWna6s</a></p>
<div id='bb43' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b43" class="texter">
<p>If the fake text was encoded with the Words method using a cover text different from the default, you will have to load first the appropriate cover text by selecting it on the top box of the <strong>Main</strong> tab, if stored in the local directory, or using the process described in the next help item, if not stored.</p>
</div>
</div>
  <hr>

  <div id="aa44" style="cursor:pointer">
<h3>Display or change the cover used for fake text <em>(advanced)</em></h3>
  </div>
  <div id="a44" class="texter">
<p>To display the current cover text (which would be the default cover text if PassLok has just been reloaded), click the <strong>&#9660;</strong> button, if needed, and then the <strong>Cover</strong> button  with the box empty.</p>
<p>To change the cover text:</p>
<p>1. Copy a sufficiently long text (must have at least 70 different words) and paste it into the <strong>Main</strong> tab.</p>
<p>2. Click the <strong>&#9660;</strong> button, if needed, and then the <strong>Cover</strong> button. If the change is successful, the box goes blank, and a message confirms the change.</p>
<p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=Px2JweWna6s" target="_blank">https://www.youtube.com/watch?v=Px2JweWna6s</a></p>
<div id='bb44' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b44" class="texter">
<p>Cover texts do not have to be in English or even use Latin characters. Anything that can be written in UTF-8 encoded characters can be used (most languages, including Arabic and Chinese, will work fine). If the change is unsuccessful, a message above the box will say why. Typically, failure to change the cover text is due to not having a sufficient number of different words. Use a longer text and try again.</p>
<p>Since the cover text is a (weak) sort of password for a Words-encoded item, it may be good to store often-used cover texts in your local directory so they can be loaded easily from the <strong>Main</strong> tab. To do this, go to the <strong>Directory</strong> tab, write a new name in the upper box, then paste the cover text in the lower box, and click <strong>Save</strong>. The cover text can be retrieved like any other stored item, and it will be automatically loaded after it is extracted from encrypted storage.</p>
</div>
</div>
  <hr>

 <div id="aa45" style="cursor:pointer">
  <h3>Hide a PassLok item inside an image <em>(advanced)</em></h3>
 </div>
  <div id="a45" class="texter">
 <p>1. Make sure the item to be hidden is in the lower box of the <strong>Main</strong> tab.</p>
 <p>2. Click the <strong>&#9660;</strong> button, if needed, and then the <strong>Image</strong> button.</p>
<p>3. A new screen appears where you can load the image where the item is to be hidden. To do so, click the <strong>"Choose File"</strong> or <strong>"Browse"</strong> button (browsers vary on the name). A dialog will appear, where you can navigate to the image and open it. A message will tell you how much data you can hide in the image.</p>
    <p>4. When you see the image, click the <strong>Hide</strong> button. A message will say when processing is completed, although the image will not appear to have changed.</p>
    <p>5. Right-click or long-press on the image in order to save it or send it somewhere.</p>
    <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=_iXIyH6AnMI" target="_blank">https://www.youtube.com/watch?v=_iXIyH6AnMI</a></p>
<div id='bb45' style="cursor:pointer">
<p><em>Click here for More:</em></p>
</div>
<div id="b45" class="texter">
<p>Images only a few kB in size can hide PassLok items with hundreds of characters. Images taken with a mobile camera are usually too large for PassLok to be able to use them for hiding items, because of the processing required.</p>
</div>
  </div>
    <hr>

 <div id="aa46" style="cursor:pointer">
  <h3>Retrieve the PassLok item hidden inside an image <em>(advanced)</em></h3>
 </div>
  <div id="a46" class="texter">
      <p>1. Navigate to the image hiding screen from the <strong>Main</strong> tab by clicking <strong>&#9660;</strong>, if needed, and then <strong>Image</strong>.</p>
      <p>2. Click <strong>Choose File</strong> or <strong>Browse</strong> (browsers vary on this) and open the image containing the hidden item.</p>
      <p>3. When the image displays on the screen, click the <strong>Reveal</strong> button. A message will say when processing is completed and the hidden item has been retrieved, or no hidden item has been found.</p>
      <p>4. Click <strong>Back</strong> to see the item on the <strong>Main</strong> tab.</p>
      <p>This and more is explained in this video tutorial: <a href="https://www.youtube.com/watch?v=_iXIyH6AnMI" target="_blank">https://www.youtube.com/watch?v=_iXIyH6AnMI</a></p>
  </div>
   <hr>

	<div id="aa47" style="cursor:pointer">
  <h3>I have an item that was locked/signed with a previous version of PassLok, and the current version cannot handle it</h3>
 </div>
  <div id="a47" class="texter">
    <p>We do not recommend using old versions for new work. Newer versions have enhanced security and are more user-friendly. But sometimes you may need to handle an item that is incompatible with the current version. Here is a pretty complete list of PassLok versions, with links to them.</p>
    <p><strong>Current version</strong> of PassLok can be obtained from:</p>
<p>source server: <a href="https://passlok.com" target="_blank">https://passlok.com</a></p>
<p>information page: <a href="http://passlok.weebly.com" target="_blank">http://passlok.weebly.com</a></p>
<p>GitHub page: <a href="https://github.com/fruiz500/passlok" target="_blank">https://github.com/fruiz500/passlok</a></p>
<p>Chrome app: <a href="https://chrome.google.com/webstore/detail/passlok-privacy/epcchpdljafmfegifkigklfcmkphfmbh" target="_blank">https://chrome.google.com/webstore/detail/passlok-privacy/epcchpdljafmfegifkigklfcmkphfmbh</a></p>
<p>Android app: <a href="https://play.google.com/store/apps/details?id=com.fruiz500.passlok" target="_blank">https://play.google.com/store/apps/details?id=com.fruiz500.passlok</a></p>
<p>iOS app: <a href="https://itunes.apple.com/us/app/passlok-privacy/id879861603?mt=8&uo=4" target="_blank">https://itunes.apple.com/us/app/passlok-privacy/id879861603?mt=8&amp;uo=4</a></p>
<p>mirrors:</p>
<p><a href="https://www.autistici.org/passlok" target="_blank">https://www.autistici.org/passlok</a> (non-US, self-certified)</p>
<p><a href="https://passlok.site44.com" target="_blank">https://passlok.site44.com</a></p>
<p><a href="https://fruiz500.github.io/passlok" target="_blank">https://fruiz500.github.io/passlok</a></p>
<p>SHA256 for this version and video of the author reading it at:</p>
<p><a href="http://passlok.weebly.com/get-passlok.html" target="_blank">http://passlok.weebly.com/get-passlok.html</a></p>
<p>&nbsp;</p>
<p><strong>Previous versions:</strong></p>
<p><strong>1.7.08</strong> (87a4-fee6-8916-99fb-c59b-9d73-32dd-3023-5af0-3e69-18e0-caa3-d9e7-8a53-2385-957c)</p>
<p><a href="https://passlok.com/archive/passlok17.html" target="_blank">PassLok.com</a></p>
<p><a href="https://www.autistici.org/passlok/archive/passlok17.html" target="_blank">Autistici</a></p>
<p><a href="https://passlok.site44.com/archive/passlok17.html" target="_blank">Site44</a></p>
<p><a href="https://www.youtube.com/watch?v=yhGs76QReRM" target="_blank">Author reading the ID</a></p>
<p><strong>1.6.02</strong> (2c64-63d5-5d68-c7b2-9350-68cc-8bef-1a75-ddc1-1fa0-cd04-4428-f3ef-c079-e14f-4133)</p>
<p><a href="https://passlok.com/archive/passlok16.html" target="_blank">PassLok.com</a></p>
<p><a href="https://www.autistici.org/passlok/archive/passlok16.html" target="_blank">Autistici</a></p>
<p><a href="https://passlok.site44.com/archive/passlok16.html" target="_blank">Site44</a></p>
<p><a href="https://www.youtube.com/watch?v=Z5e9TVGMMsE" target="_blank">Author reading the ID</a></p>
<p><strong>1.5.03</strong>  (0061-4b79-8ba1-8fee-34c5-e243-96e9-4c7c-a0ea-cfc5-82c1-a44d-4cbb-06c4-ca00-985c)</p>
<p><a href="https://passlok.com/archive/passlok15.html" target="_blank">PassLok.com</a></p>
<p><a href="https://www.autistici.org/passlok/archive/passlok15.html" target="_blank">Autistici</a></p>
<p><a href="https://passlok.site44.com/archive/passlok15.html" target="_blank">Site44</a></p>
<p><a href="https://www.youtube.com/watch?v=YQIDRKE_wbI" target="_blank">Author reading the ID</a></p>
<p>The following (except 1.0) were edited so the archived help file works, changing the ID from the original (therefore no video)</p>
<p><strong>1.4.03</strong> (f1cc-8931-1d31-4d65-4dfe-fb0d-5368-f854-3766-b240-f131-c93f-a0e9-8d14-752e-018e)</p>
<p><a href="https://passlok.com/archive/passlok14.html" target="_blank">PassLok.com</a></p>
<p><a href="https://www.autistici.org/passlok/archive/passlok14.html" target="_blank">Autistici</a></p>
<p><a href="https://passlok.site44.com/archive/passlok14.html" target="_blank">Site44</a></p>
<p><strong>1.3.03</strong> (7c6f-3d59-1059-e712-15ea-8dcf-dcde-861a-7359-6508-3b29-5720-41c9-8271-cb69-f01a)</p>
<p><a href="https://passlok.com/archive/passlok13.html" target="_blank">PassLok.com</a></p>
<p><a href="https://www.autistici.org/passlok/archive/passlok13.html" target="_blank">Autistici</a></p>
<p><a href="https://passlok.site44.com/archive/passlok13.html" target="_blank">Site44</a></p>
<p><strong>1.2</strong> (c17b-c529-8757-578a-6bc2-bdc4-122e-c607-8c16-19ef-b9ee-8d4d-75aa-cf0a-b703-e0ec)</p>
<p><a href="https://passlok.com/archive/passlok12.html" target="_blank">PassLok.com</a></p>
<p><a href="https://www.autistici.org/passlok/archive/passlok12.html" target="_blank">Autistici</a></p>
<p><a href="https://passlok.site44.com/archive/passlok12.html" target="_blank">Site44</a></p>
<p><strong>1.1</strong> (8e5c-9714-eec3-cc65-aa8f-640d-d434-2747-aa24-624c-74c5-65ea-4077-0f0f-3b22-cc30)</p>
<p><a href="https://passlok.com/archive/passlok11.html" target="_blank">PassLok.com</a></p>
<p><a href="https://www.autistici.org/passlok/archive/passlok11.html" target="_blank">Autistici</a></p>
<p><a href="https://passlok.site44.com/archive/passlok11.html" target="_blank">Site44</a></p>
<p><strong>1.0</strong> (a907-25eb-50e3-e4a6-5f4b-27c1-684e-f590-6094-6fae-52f3-c7ca-47b1-732c-9eab-3e9b)</p>
<p><a href="https://passlok.com/archive/passlok10.html" target="_blank">PassLok.com</a></p>
<p><a href="https://www.autistici.org/passlok/archive/passlok10.html" target="_blank">Autistici</a></p>
<p><a href="https://passlok.site44.com/archive/passlok10.html" target="_blank">Site44</a></p>
  </div>
   <hr>

  <div id="aa48" style="cursor:pointer">
  <h3>I want to know PassLok in depth. Is there more information?</h3>
 </div>
  <div id="a48" class="texter">
    <p>Another way to learn is to check the <strong>Learn</strong> box in the <strong>Options</strong> tab, which will create a popup explaining what is about to happen, every time a button is clicked. If this is not enough for you, here are a couple more sources you may want to check out:</p>
    <p>The PassLok <a href="http://passlok.weebly.com/uploads/2/4/1/8/24187628/passlok_manual20.pdf" target="_blank">manual in PDF form.</a></p>
    <p>The PassLok informational website at <a href="http://passlok.weebly.com" target="_blank">http://passlok.weebly.com</a>. It contains a number of videos and more PDF documents.</p>
  </div>
   <hr>

   <div id="aa49" style="cursor:pointer">
  <h3>None of the help items answers my question / I want to give feedback</h3>
 </div>
  <div id="a49" class="texter">
    <p>Then you can send us an email at <a href="mailto:passlokprivacy@gmail.com?subject=PassLok support request" target="_blank">passlokprivacy@gmail.com</a> (the link will open your email client). We'll do our best to reply in a timely fashion.</p>
    <p>Good constructive feedback is hard to get, so let us <strong>thank you</strong> right now, before we read your email.</p>
  </div>
   <hr>

   <div id="aa50" style="cursor:pointer">
  <h3>I think I know PassLok pretty well. Is there a quiz to test my knowledge?</h3>
 </div>
  <div id="a50" class="texter">
    <p>Sure there is, and it includes a number of trick questions. Just click the button below.</p>
    <p><button class="cssbutton" id="openquizButton" value="openQuiz" title="opens the PassLok quiz">Take Quiz</button></p>
  </div>
   <hr>

<div id="aa51" style="cursor:pointer">
<h3>Privacy Statement</h3>
</div>
<div id="a51" class="texter">
<p>PassLok provides excellent security, since it is a self-contained piece of code that neither relies on servers nor stores secret information to do its job. Therefore:</p>
<p><strong>1. We cannot give your secret Key to anyone</strong> (not even yourself) because we don't have it. Your Key is never stored or transmitted, and by default it gets deleted from memory  after five minutes of not being used.</p>
<p><strong>2. We cannot give your private data to anyone</strong> because PassLok does not send anything out of your device. We only store Locks that have been posted on our General Directory by their owners, and those are public by nature.</p>
<p><strong>3. We will never weaken the cryptography methods contained within PassLok at the request of a third party, private or public.</strong> This also means no backdoors will ever be added. We'd rather shut down PassLok than be forced to do this, which would betray the very essence of the program. If we learn that counterfeit versions of PassLok are circulating, whether placed by hackers or government agencies, we'll make the fact known to users.</p>
<p><strong>Notice:</strong> Since PassLok is distributed a piece of human-readable code, we consider it an expression of free speech protected by the laws of many countries. Putting into circulation tampered versions of PassLok violates free speech and copyright protection laws.</p>
<p>PassLok contains strong cryptographic methods, which may be illegal to use in some countries. Please check the local laws before using PassLok.</p>
</div>
<hr>
	<address>
	PassLok v2.0.01 &#169; F. Ruiz 2014
  </address>
    <ul>
	<li>
	engine: SJCL by Stark, Hamburg, and Boneh 2012</li>
    <li>
    general directory by W. Huang 2014</li>
	<li>
    Shamir secret sharing by A. Stetsyuk 2013</li>
	<li>
    image hiding: steganography.js by Peter Eigenschink 2012</li>
    <li>
    FastClick by FT Labs 2014</li>
    <li>
    file In/Out based on an article from the This Could Be Better blog. 2012</li>
    <li>
    sjcl-scrypt key stretching implementation by joe-invincible 2013</li>
    <li>
    testing, help items, interface ideas by the IIT IPRO-379 team 2014</li>
    </ul>
    <address>This document may be used, modified or redistributed under GNU GPL license, version 3.0 or higher.</address>
</div>

<!--Image screen-->
<div id='imagescr' class="block_page" align="center" style="display: none;">
    <button class="cssbutton" id="image2mainButton" value="< Back" title="return to main screen (alt-I)" accesskey="i">&#9668; Back</button>&nbsp;
    <button class="cssbutton" id="encode" value="Hide" title="hide main box contents into image">Hide</button>&nbsp;
    <button class="cssbutton" id="decode" value="Reveal" title="extract hidden content and put it in main box">Reveal</button><br /><br />

    <input class="custom-file-input" type='file' id='imagefile' style="" title="open a dialog to select the cover image"/><br /><br />

    <span id="imagemsg"></span><br /><br />

    <img id="preview" src="" width="100%"/>
</div>

<!--Shadow backdrop-->
<div id="shadow" class="black_overlay" style="display: block;">
</div>

<!--Key dialog-->
<div id="keyscr" class="white_content" align="center" style="display: block;">
    <div align="center">
    <br />
      	<span id="keymsg"><span style="color:red;font-weight:bold">JAVASCRIPT OFF, PASSLOK CANNOT RUN</span></span><br /><br />
		<input type="password" class="cssbox" autocomplete="off" id="pwd" onKeyUp="pwdKeyup(event);" style="" name="text" placeholder="Enter your secret Key here." align="center"><br /><br />
		<input type="checkbox" id="showKey" title="reveal box contents"> Show&nbsp;
       <input type="checkbox" id="never" title="turn off Key timer"> Remember<br /><br />
        <button class="cssbutton" id="cancelKeyButton" value="cancel" style="" title="close Key dialog">Cancel</button>&nbsp;
	 	<button class="cssbutton" id="acceptKeyButton" value="OK" style="" title="accept Key">OK</button>
        <span id="5min"><p>You will need to re-enter your Key if you don't use it for 5 min.</p></span>
        <p><strong>PassLok will be very slow</strong> if your Key is worse than Medium.</p>
        <p>To display your Lock, click myLock on the Main tab.</p>
	</div>
</div>

<!--email dialog-->
<div id="emailscr" class="white_content" align="center" style="display: none;">
    <div align="center">
    <br />
<span id="emailmsg">Please enter your email, or whatever other public data or token you entered when you made your Lock</span><br /><br />
		<button class="cssbutton" id="randomEmailButton" value="random" style="" title="insert random token">Random</button><br /><br />
		<input type="text" class="cssbox" autocomplete="off" id="email" onKeyUp="emailKeyup(event);" style="" name="email" placeholder="Enter your email or some other not secret personal info here." align="center"><br /><br />
       <button class="cssbutton" id="cancelEmailButton" value="cancel" style="" title="close email dialog">Cancel</button>&nbsp;
	 	<button class="cssbutton" id="acceptEmailButton" value="OK" style="" title="accept email">OK</button>
        <p>Your Lock will change if it's not the same you entered before.</p>
        <p>If you use a random token, make sure to back it up from the Options tab.</p>
	</div>
</div>

<!--Intro screen, split into two-->
<div id="introscr" class="block_page" align="center" style="display: none;">
  	<h2 style="color:green">Welcome to PassLok</h2>
  <div align="left" style="width:98%;">
  	<p>If you have three minutes to spare, you may want to begin by watching this video, which introduces the essential concepts in a lighthearted way.</p>
    <div align="center">
    <iframe id="videotutorial" seamless class="youtube-player" type="text/html" src="" frameborder="0" allowfullscreen></iframe></div>
  	<ul>
  	  <li>PassLok locks text and files using strong encryption, so it can be read only by the intended recipient.</li>
  	  <li>PassLok is based on Keys and Locks. You lock something with <strong>someone else's Lock</strong>, so only that person can unlock it with his/her Key.</li>
  	  <li>Your Key is a short piece of text, which can be anything you want so you can remember it.</li>
  	  <li>The matching Lock is then made from the Key. It is impossible to get a strong Key from its Lock.</li>
  	  <li>You should never give your Key to anyone. Your Lock, however, is meant to be distributed freely, like a phone number.</li>
     </ul>
<p> In the next screen, you will come up with your all-important secret Key, and make its matching Lock.</p>
<button class="cssbutton" id="gotointro2" value="next" title="continue">Next &#9658;</button>
</div></div>

<div id="introscr2" class="block_page" align="center" style="display: none;">
<div align="left" style="width:98%;">
<button class="cssbutton" id="backtointro1" value="back" title="back to beginning">&#9668; Back</button><br /><br />
  	<p>Now enter your Key in the box below. As you type your Key, a text above it will tell you its strength. Make sure to <strong>use $ymbol$, numb3rs, caPiTals, unusual words and mespelingss</strong> in order to improve the score.</p>
  	<div align="center">
      		<span id="intromsg" style="color:green">This is where the score will appear</span><br /><br />
			<input type="password" class="cssbox" autocomplete="off" id="pwdIntro" style="width: 80%" name="text" placeholder="Enter your secret Key here." align="center"><br /><br />
		<input type="checkbox" id="showIntroKey" title="reveal box contents"> Show
      <button class="cssbutton" id="clearIntroButton" value="Clear" title="clear box contents">Clear</button>
      <br /><br />
	</div>
      	<p>PassLok compensates for weak Keys by adding computations. If your Key score is worse than Medium, <strong>PassLok will be very slow.</strong></p>
      	<p>You will <strong>never give this Key to anyone</strong>. Instead, you will give them the <strong>Lock</strong> matching your Key.</p>
<p>Security will be greatly enhanced when you write in the next box some public piece of data about yourself, such as your email address. PassLok will remember it, but it may ask you again if things get messed up. Your Lock will depend on it as well.</p>
<p>For ultimate security, click the Random button to use instead a random token. Make sure to back it up soon, by going the Options tab.</p>
    <div align="center">
    <input type="text" class="cssbox" id="emailIntro" style="width: 80%" name="text" placeholder="Enter your email or some other not secret personal info here." align="center"><br /><br />
    <button class="cssbutton" id="introRandomButton" value="Random" title="display a random token">Random</button>
      <button class="cssbutton" id="clearIntroRandomButton" value="Clear" title="clear box contents">Clear</button>
    </div>
       <p>When you click the big button below, this screen will close and the Lock matching your Key will appear on PassLok's Main tab. Then you can copy it, email it, text it, and even post it on PassLok's general directory so others can see it.</p>
    <div align="center">
  <button class="cssbutton" id="showlockIntroButton" value="Make Lock" style="color:blue;" align="center" title="make matching Lock and opens main screen">Show Lock in Main Screen</button>
  </div>
        <p>You will start in Basic mode, which shows only the most essential functions. If you are looking for more features, go to the Options tab and check the Advanced checkbox.</p>
        <p>You will not see this screen again, but comprehensive help is always available on the Help tab.</p>
    </div>
</div>

<!--Key change dialog-->
<div id="keyChange" class="white_content" align="center" style="">
<br /><br />
        <span id="keychangemsg"></span><br /><br />
    	<input type="password" id="newKey" class="cssbox"  style="" name="newkey" placeholder="Enter the new Key here."/><br /><br />
        <input type="checkbox" id="showNewKey" title="reveal new Key"> Show
        <br /><br />
       <input type="password" id="newKey2" class="cssbox"  onKeyUp="newKey2up(event);" style="" name="newkey2" placeholder="Enter the new Key again."/><br /><br />
    	<button class="cssbutton" id="cancelKeychange" value="Cancel" title="do not change the Key">Cancel</button>&nbsp;
       <button class="cssbutton" id="submitKeychange" value="OK" title="go on with Key change">OK</button>
</div>

<!--Decoy In dialog-->
<div id="decoyIn" class="white_content" align="center">
		<p>Enter the Hidden Message</p>
        <span id="decoymsg"></span><br />
		<textarea id="decoyText" class="cssbox" style="" name="text" rows="3"></textarea>
       <p>Enter the Decoy Password</p>
    	<input type="password" class="cssbox" id="decoyPwdIn" onKeyUp="decoyKeyup(event);" style="" name="key"/>
        <input type="checkbox" id="showdecIn" title="reveal Password"> Show
    	<button class="cssbutton" id="cancelDecoyButton" value="Cancel" title="do not lock">Cancel</button>&nbsp;
       <button class="cssbutton" id="submitDecoyButton" value="OK" title="go on with locking">OK</button>
</div>

<!--Decoy Out dialog-->
<div id="decoyOut" class="white_content" align="center">
		<p>Enter the Decoy Password</p>
    	<input type="password" class="cssbox" id="decoyPwdOut" style="" name="key"/>
        <input type="checkbox" id="showdecOut" onKeyUp="decoyKeyupOut(event);" title="reveal Password">Show
    	<button class="cssbutton" id="cancelDecoy2Button" value="Cancel" title="stop unlock">Cancel</button>&nbsp;
       <button class="cssbutton" id="submitDecoy2Button" value="OK" title="go on with unlock">OK</button>
    	<p>The Hidden message will appear on the Main tab</p>
</div>

<!--Parts for SSSS dialog-->
<div id="partsIn" class="white_content" align="center">
		<p>Enter the total number of parts (between 2 and 255)</p>
    	<input type="text" class="cssbox" id="partsNumber" onKeyUp="partsKeyup(event);" style="width: 30%" name="text" rows="1"/><br />
		<p>And the number of parts needed to retrieve the item</p>
    	<input type="text" class="cssbox" id="partsQuorum" style="width: 30%" name="text" rows="1"/><br /> <br />
    	<button class="cssbutton" id="cancelPartsButton" value="Cancel" title="do not split">Cancel</button>&nbsp;
       <button class="cssbutton" id="submitPartsButton" value="OK" title="go on with splitting">OK</button>
</div>

<!--Quiz screen, just an iframe for quiz.html-->
<div class="block_page" id="quizscr" style="display: none;" align="center">
<button class="cssbutton" id="closequizButtonTop" value="< Back" style="float:left;" title="returns to Help tab">&#9668; Back</button>

<iframe id="quizframe" src="" width="100%" height = 500 border=0 frameborder=0 seamless></iframe>

<button class="cssbutton" id="closequizButtonBot" value="< Back" style="float:left;" title="returns to Help tab">&#9668; Back</button>
</div>

<!--General Lock directory screen, just an iframe for https://passlok.com/lockdir-->
<div id="lockdir" class="block_page" style="display: none;" align="center">
  <button class="cssbutton" id="closelockdirButton" value="< Back" style="float:left;" title="returns to Locks screen (alt-G)">&#9668; Back to PassLok</button>

    <iframe seamless id="lockdirframe" src="" style="width:100%;height:900px" border=0 frameborder=0></iframe>

</div>

<!--Body script: window reformatting, special functions-->
<script>
//this is the part of the javascript code that must be within the body

	sjcl.random.startCollectors();										//start SJCL's built-in entropy collectors

//  Clear out "sorry, no JavaScript" message from first screen.
    document.getElementById('keymsg').innerHTML = "<span style='color:green'><strong>Welcome to PassLok Privacy</strong></span><br />Enter your Key here. Then click OK.";

	var rowheight = document.getElementById('pwd').clientHeight*0.5,	//get title size in pixels, for number of rows calculation. global variables
		isChrome = navigator.userAgent.toLowerCase().indexOf('chrome') > -1,
		isFirefox = typeof InstallTrigger !== 'undefined',   			// Firefox 1.0+
		isiPad = (navigator.userAgent.match(/iPad/i) != null),
		isiPhone = (navigator.userAgent.match(/iPhone|iPod/i) != null),
		isiOS = (isiPhone || isiPad),
		isAndroid = (isMobile && !isiOS),
		isAndroidTablet = (navigator.userAgent.match(/mobile/i) == null && isAndroid),
		isAndroidPhone= (navigator.userAgent.match(/mobile/i) != null && isAndroid),
		angle = window.orientation;
	if((angle==90)||(angle==-90)){rowheight = rowheight*0.78}				//correction in case device starts in landscape
	if(isAndroid){rowheight = rowheight*1.1}		//Android rows are fatter
	textrows();
	quizResize();

//resizes text boxes so they fit within the window
function textrows(){
	if(isiPad || isAndroidTablet){												//first for iPad. Don't know how to detect other tablets
		if((angle==90)||(angle==-90)){
			document.getElementById('mainBox').rows=document.documentElement.clientHeight/rowheight*2-30				//landscape
		}else{document.getElementById('mainBox').rows=document.documentElement.clientHeight/rowheight*2-30}			//portrait
	}else{
		if((angle==90)||(angle==-90)){
			document.getElementById('mainBox').rows=document.documentElement.clientHeight/rowheight*1.5-25			//smartphone here and line below
		}else if(isMobile) {document.getElementById('mainBox').rows=document.documentElement.clientHeight/rowheight*2.2-30
		}else{document.getElementById('mainBox').rows=document.documentElement.clientHeight/rowheight*2-30}}				//non-mobile
	document.getElementById('mainBox').rows = document.getElementById('mainBox').rows*0.6;			//tweak factor for development
	if(document.getElementById('lockBox')!=null) document.getElementById('lockBox').rows = document.getElementById('mainBox').rows*1.0
}

//resizes iframe or quiz according to screen size
function quizResize(){
	document.getElementById('quizframe').height = document.documentElement.clientHeight - 60
}

//functions for reading a file into the box, and for saving it later
function saveURLAsFile()
{
	var URLToWriteSplit = document.getElementById('mainBox').value.trim().split('\n');
	var fileNameToSaveAs = URLToWriteSplit[0].split(':')[1];
	if(URLToWriteSplit.length > 1){
		var content = URLToWriteSplit[1].trim()
	} else {
		var content = URLToWriteSplit[0].trim()
	};
	var downloadLink = document.createElement("a");
	if(content.slice(0,4).toLowerCase()=='data'){							//regular save of encoded file
		downloadLink.download = fileNameToSaveAs;
		downloadLink.innerHTML = "Download File";
	} else {																//to save contents as text file
		var textFileAsBlob = new Blob([document.getElementById('mainBox').value.trim()], {type:'text/plain'});
		downloadLink.download = prompt("The box contents will be saved as a text file. Please enter a name for it.");
		downloadLink.innerHTML = "Download File";
		content = window.URL.createObjectURL(textFileAsBlob);
	}
	if (window.webkitURL != null)
	{
		// Chrome allows the link to be clicked
		// without actually adding it to the DOM.
		downloadLink.href = content;
	}
	else
	{
		// Firefox requires the link to be added to the DOM
		// before it can be clicked.
		downloadLink.href = content;
		downloadLink.onclick = destroyClickedElement;
		downloadLink.style.display = "none";
		document.body.appendChild(downloadLink);
	}
	downloadLink.click();
	document.getElementById('filemsg').innerHTML = 'File saved with filename ' + fileNameToSaveAs
}

function destroyClickedElement(event)
{
	document.body.removeChild(event.target);
}

//this one is called by window.onload below
function loadFileAsURL()
{
	var fileToLoad = document.getElementById("fileToLoad").files[0];

	var fileReader = new FileReader();
	fileReader.onload = function(fileLoadedEvent)
	{
		var fileName = fileToLoad.name;
		var URLFromFileLoaded = fileLoadedEvent.target.result;
		document.getElementById('mainBox').value = "filename:" + fileName + "\n" + URLFromFileLoaded;
	};
	fileReader.readAsDataURL(fileToLoad, "UTF-8");
	document.getElementById('mainmsg').innerHTML = 'The file has been loaded in encoded form. It is <strong>not encrypted.</strong>'
	document.getElementById('filemsg').innerHTML = 'File loaded on the Main tab'
}
</script>

<!--initialization, button connections-->
<script>
// initialize things
window.onload = function() {

	if(!isMobile){
		document.getElementById('preview').style.width = "40%";					//smaller image on PCs
	}
	if(!isMobile || isChrome){							//search box in Help tab. Works on Android Chrome, but won't detect right
		document.getElementById('helptopmobile').style.display = 'none';
		document.getElementById('helptop').style.display = 'block';
		document.getElementById('helpspace').style.display = 'block'
	}

	window.addEventListener("resize", function() { textrows()}, false)	    	//resize if the window changes

	initTabs();																	//initialize tabs
	fillList();																	//put names in selection box

	//this one for loading files into extra screen
	var fileinput = document.getElementById('fileToLoad');
    fileinput.addEventListener('change', loadFileAsURL, false);
	fileinput.addEventListener('blur', ce);
	fileinput.addEventListener('focus', ce);

    // add action to the file input
    var input = document.getElementById('imagefile');
    input.addEventListener('change', importImage);
	input.addEventListener('blur', ce);
	input.addEventListener('focus', ce);

    // add action to the encode button
    var encodeButton = document.getElementById('encode');
    encodeButton.addEventListener('click', encodeImage);
	encodeButton.addEventListener('blur', ce);
	encodeButton.addEventListener('focus', ce);

    // add action to the decode button
    var decodeButton = document.getElementById('decode');
    decodeButton.addEventListener('click', decodeImage);
	decodeButton.addEventListener('blur', ce);
	decodeButton.addEventListener('focus', ce);

//button code moved from html page, used to be inline

	var showlockButton = document.getElementById('showlockButton');
   	showlockButton.addEventListener('click', showLock);
	showlockButton.addEventListener('blur', ce);
	showlockButton.addEventListener('focus', ce);

	var basicmodeBox = document.getElementById('basicmode');
   	basicmodeBox.addEventListener('click', basic2main);
	basicmodeBox.addEventListener('blur', ce);
	basicmodeBox.addEventListener('focus', ce);

	var advancedmodeBox = document.getElementById('advancedmode');
   	advancedmodeBox.addEventListener('click', basic2main);
	advancedmodeBox.addEventListener('blur', ce);
	advancedmodeBox.addEventListener('focus', ce);

	var clearMainButton = document.getElementById('clearMainButton');
   	clearMainButton.addEventListener('click', clearMain);
	clearMainButton.addEventListener('blur', ce);
	clearMainButton.addEventListener('focus', ce);

	var clearMainButton = document.getElementById('selectMainButton');
   	selectMainButton.addEventListener('click', selectMain);
	selectMainButton.addEventListener('blur', ce);
	selectMainButton.addEventListener('focus', ce);

	var showlockButtonBasic = document.getElementById('showlockButtonBasic');
   	showlockButtonBasic.addEventListener('click', showLock);
	showlockButtonBasic.addEventListener('blur', ce);
	showlockButtonBasic.addEventListener('focus', ce);

	var clearMainButtonBasic = document.getElementById('clearMainButtonBasic');
   	clearMainButtonBasic.addEventListener('click', clearMain);
	clearMainButtonBasic.addEventListener('blur', ce);
	clearMainButtonBasic.addEventListener('focus', ce);

	var selectMainButtonBasic = document.getElementById('selectMainButtonBasic');
   	selectMainButtonBasic.addEventListener('click', selectMain);
	selectMainButtonBasic.addEventListener('blur', ce);
	selectMainButtonBasic.addEventListener('focus', ce);

	var decryptButton = document.getElementById('decryptButton');
   	decryptButton.addEventListener('click', Decrypt_single);
	decryptButton.addEventListener('blur', ce);
	decryptButton.addEventListener('focus', ce);

	var verifyButton = document.getElementById('verifyButton');
   	verifyButton.addEventListener('click', Verifyhash);
	verifyButton.addEventListener('blur', ce);
	verifyButton.addEventListener('focus', ce);

	var main2extraButton = document.getElementById('main2extraButton');
   	main2extraButton.addEventListener('click', main2extra);
	main2extraButton.addEventListener('blur', ce);
	main2extraButton.addEventListener('focus', ce);

	var decryptButtonBasic = document.getElementById('decryptButtonBasic');
   	decryptButtonBasic.addEventListener('click', Decrypt_single);
	decryptButtonBasic.addEventListener('blur', ce);
	decryptButtonBasic.addEventListener('focus', ce);

	var extra2mainButton = document.getElementById('extra2mainButton');
   	extra2mainButton.addEventListener('click', main2extra);
	extra2mainButton.addEventListener('blur', ce);
	extra2mainButton.addEventListener('focus', ce);

	var sendMailButton = document.getElementById('sendMailButton');
   	sendMailButton.addEventListener('click', sendMail);
	sendMailButton.addEventListener('blur', ce);
	sendMailButton.addEventListener('focus', ce);

	var sendMailButtonBasic = document.getElementById('sendMailButtonBasic');
   	sendMailButtonBasic.addEventListener('click', sendMail);
	sendMailButtonBasic.addEventListener('blur', ce);
	sendMailButtonBasic.addEventListener('focus', ce);

	var sendSMSButton = document.getElementById('sendSMSButton');
   	sendSMSButton.addEventListener('click', sendSMS);
	sendSMSButton.addEventListener('blur', ce);
	sendSMSButton.addEventListener('focus', ce);

	var imageButton = document.getElementById('imageButton');
   	imageButton.addEventListener('click', main2image);
	imageButton.addEventListener('blur', ce);
	imageButton.addEventListener('focus', ce);

	var secretshareButton = document.getElementById('secretshareButton');
   	secretshareButton.addEventListener('click', secretshare);
	secretshareButton.addEventListener('blur', ce);
	secretshareButton.addEventListener('focus', ce);

	var wordsButton = document.getElementById('wordsButton');
   	wordsButton.addEventListener('click', words);
	wordsButton.addEventListener('blur', ce);
	wordsButton.addEventListener('focus', ce);

	var spacesButton = document.getElementById('spacesButton');
   	spacesButton.addEventListener('click', spaces);
	spacesButton.addEventListener('blur', ce);
	spacesButton.addEventListener('focus', ce);

	var coverButton = document.getElementById('coverButton');
   	coverButton.addEventListener('click', box2cover);
	coverButton.addEventListener('blur', ce);
	coverButton.addEventListener('focus', ce);

	var savefileButton = document.getElementById('savefileButton');
   	savefileButton.addEventListener('click', saveURLAsFile);
	savefileButton.addEventListener('blur', ce);
	savefileButton.addEventListener('focus', ce);

	var image2mainButton = document.getElementById('image2mainButton');
   	image2mainButton.addEventListener('click', image2main);
	image2mainButton.addEventListener('blur', ce);
	image2mainButton.addEventListener('focus', ce);

	var lock2dirButton = document.getElementById('lock2dirButton');
   	lock2dirButton.addEventListener('click', lock2dir);
	lock2dirButton.addEventListener('blur', ce);
	lock2dirButton.addEventListener('focus', ce);

	var clearLocksButton = document.getElementById('clearLocksButton');
   	clearLocksButton.addEventListener('click', clearLocks);
	clearLocksButton.addEventListener('blur', ce);
	clearLocksButton.addEventListener('focus', ce);

	var lock2dirButtonBasic = document.getElementById('lock2dirButtonBasic');
   	lock2dirButtonBasic.addEventListener('click', lock2dir);
	lock2dirButtonBasic.addEventListener('blur', ce);
	lock2dirButtonBasic.addEventListener('focus', ce);

	var clearLocksButtonBasic = document.getElementById('clearLocksButtonBasic');
   	clearLocksButtonBasic.addEventListener('click', clearLocks);
	clearLocksButtonBasic.addEventListener('blur', ce);
	clearLocksButtonBasic.addEventListener('focus', ce);

	var addLockButton = document.getElementById('addLockButton');
   	addLockButton.addEventListener('click', addLock);
	addLockButton.addEventListener('blur', ce);
	addLockButton.addEventListener('focus', ce);

	var removeLockButton = document.getElementById('removeLockButton');
   	removeLockButton.addEventListener('click', removeLock);
	removeLockButton.addEventListener('blur', ce);
	removeLockButton.addEventListener('focus', ce);

	var resetPFSButton = document.getElementById('resetPFSButton');
   	resetPFSButton.addEventListener('click', resetPFS);
	resetPFSButton.addEventListener('blur', ce);
	resetPFSButton.addEventListener('focus', ce);

	var addToListButton = document.getElementById('addToListButton');
   	addToListButton.addEventListener('click', addToList);
	addToListButton.addEventListener('blur', ce);
	addToListButton.addEventListener('focus', ce);

	var addLockButtonBasic = document.getElementById('addLockButtonBasic');
   	addLockButtonBasic.addEventListener('click', addLock);
	addLockButtonBasic.addEventListener('blur', ce);
	addLockButtonBasic.addEventListener('focus', ce);

	var removeLockButtonBasic = document.getElementById('removeLockButtonBasic');
   	removeLockButtonBasic.addEventListener('click', removeLock);
	removeLockButtonBasic.addEventListener('blur', ce);
	removeLockButtonBasic.addEventListener('focus', ce);

	var showLockDBButton = document.getElementById('showLockDBButton');
   	showLockDBButton.addEventListener('click', showLockDB);
	showLockDBButton.addEventListener('blur', ce);
	showLockDBButton.addEventListener('focus', ce);

	var mergeLockDBButton = document.getElementById('mergeLockDBButton');
   	mergeLockDBButton.addEventListener('click', mergeLockDB);
	mergeLockDBButton.addEventListener('blur', ce);
	mergeLockDBButton.addEventListener('focus', ce);

	var moveLockDBButton = document.getElementById('moveLockDBButton');
   	moveLockDBButton.addEventListener('click', moveLockDB);
	moveLockDBButton.addEventListener('blur', ce);
	moveLockDBButton.addEventListener('focus', ce);

	var acceptKeyButton = document.getElementById('acceptKeyButton');
   	acceptKeyButton.addEventListener('click', acceptKey);

	var cancelKeyButton = document.getElementById('cancelKeyButton');
   	cancelKeyButton.addEventListener('click', cancelKey);

	var changeKeyButton = document.getElementById('changeKeyButton');
   	changeKeyButton.addEventListener('click', changeKey);
	changeKeyButton.addEventListener('blur', ce);
	changeKeyButton.addEventListener('focus', ce);

	var backupSettings = document.getElementById('backupSettings');
   	backupSettings.addEventListener('click', moveMyself);
	backupSettings.addEventListener('blur', ce);
	backupSettings.addEventListener('focus', ce);

	var ezLok = document.getElementById('ezLok');
   	ezLok.addEventListener('click', ezLokStore);
	ezLok.addEventListener('blur', ce);
	ezLok.addEventListener('focus', ce);

	var showKey = document.getElementById('showKey');
   	showKey.addEventListener('click', showsec);
	showKey.addEventListener('blur', ce);
	showKey.addEventListener('focus', ce);

	var introRandomButton = document.getElementById('introRandomButton');
   	introRandomButton.addEventListener('click', randomToken);
	introRandomButton.addEventListener('blur', ce);
	introRandomButton.addEventListener('blur', ce);

	var randomEmailButton = document.getElementById('randomEmailButton');
   	randomEmailButton.addEventListener('click', randomToken);
	randomEmailButton.addEventListener('blur', ce);
	randomEmailButton.addEventListener('blur', ce);

	var acceptEmailButton = document.getElementById('acceptEmailButton');
   	acceptEmailButton.addEventListener('click', email2any);
	acceptEmailButton.addEventListener('blur', ce);
	acceptEmailButton.addEventListener('blur', ce);

	var cancelEmailButton = document.getElementById('cancelEmailButton');
   	cancelEmailButton.addEventListener('click', cancelEmail);
	cancelEmailButton.addEventListener('blur', ce);
	cancelEmailButton.addEventListener('blur', ce);

	var clearIntroButton = document.getElementById('clearIntroButton');
   	clearIntroButton.addEventListener('click', clearIntro);
	clearIntroButton.addEventListener('blur', ce);
	clearIntroButton.addEventListener('focus', ce);

	var showIntroKey = document.getElementById('showIntroKey');
   	showIntroKey.addEventListener('click', showIntro);
	showIntroKey.addEventListener('blur', ce);
	showIntroKey.addEventListener('focus', ce);

	var showlockIntroButton = document.getElementById('showlockIntroButton');
   	showlockIntroButton.addEventListener('click', showlockIntro);
	showlockIntroButton.addEventListener('blur', ce);
	showlockIntroButton.addEventListener('focus', ce);

	var showdecIn = document.getElementById('showdecIn');
   	showdecIn.addEventListener('click', showdecoyIn);
	showdecIn.addEventListener('blur', ce);
	showdecIn.addEventListener('focus', ce);

	var submitDecoyButton = document.getElementById('submitDecoyButton');
   	submitDecoyButton.addEventListener('click', submitDecoyIn);
	submitDecoyButton.addEventListener('blur', ce);
	submitDecoyButton.addEventListener('focus', ce);

	var cancelDecoyButton = document.getElementById('cancelDecoyButton');
   	cancelDecoyButton.addEventListener('click', cancelDecoyIn);
	cancelDecoyButton.addEventListener('blur', ce);
	cancelDecoyButton.addEventListener('focus', ce);

	var showdecOut = document.getElementById('showdecOut');
   	showdecOut.addEventListener('click', showdecoyOut);
	showdecOut.addEventListener('blur', ce);
	showdecOut.addEventListener('focus', ce);

	var submitDecoy2Button = document.getElementById('submitDecoy2Button');
   	submitDecoy2Button.addEventListener('click', submitDecoyOut);
	submitDecoy2Button.addEventListener('blur', ce);
	submitDecoy2Button.addEventListener('focus', ce);

	var cancelDecoy2Button = document.getElementById('cancelDecoy2Button');
   	cancelDecoy2Button.addEventListener('click', cancelDecoyOut);
	cancelDecoy2Button.addEventListener('blur', ce);
	cancelDecoy2Button.addEventListener('focus', ce);

	var submitPartsButton = document.getElementById('submitPartsButton');
   	submitPartsButton.addEventListener('click', submitParts);
	submitPartsButton.addEventListener('blur', ce);
	submitPartsButton.addEventListener('focus', ce);

	var cancelPartsButton = document.getElementById('cancelPartsButton');
   	cancelPartsButton.addEventListener('click', cancelPartsIn);
	cancelPartsButton.addEventListener('blur', ce);
	cancelPartsButton.addEventListener('focus', ce);

	var learnmodeCheck = document.getElementById('learnmode');
   	learnmodeCheck.addEventListener('click', setlearnmode);
	learnmodeCheck.addEventListener('blur', ce);
	learnmodeCheck.addEventListener('focus', ce);

	var closelockdirButton = document.getElementById('closelockdirButton');
   	closelockdirButton.addEventListener('click', lock2dir);
	closelockdirButton.addEventListener('blur', ce);
	closelockdirButton.addEventListener('focus', ce);

	var openquizButton = document.getElementById('openquizButton');
   	openquizButton.addEventListener('click', help2quiz);
	openquizButton.addEventListener('blur', ce);
	openquizButton.addEventListener('focus', ce);

	var closequizButtonTop = document.getElementById('closequizButtonTop');
   	closequizButtonTop.addEventListener('click', help2quiz);
	closequizButtonTop.addEventListener('blur', ce);
	closequizButtonTop.addEventListener('focus', ce);

	var closequizButtonBot = document.getElementById('closequizButtonBot');
   	closequizButtonBot.addEventListener('click', help2quiz);
	closequizButtonBot.addEventListener('blur', ce);
	closequizButtonBot.addEventListener('focus', ce);

	var lockListBox = document.getElementById('locklist');
   	lockListBox.addEventListener('click', fillBox);
	lockListBox.addEventListener('blur', refillBox);
	lockListBox.addEventListener('focus', ce);

	var resetListButton = document.getElementById('resetListButton');
   	resetListButton.addEventListener('click', resetList);
	resetListButton.addEventListener('blur', ce);
	resetListButton.addEventListener('focus', ce);

	var submitKeychange = document.getElementById('submitKeychange');
   	submitKeychange.addEventListener('click', changeKey);
	submitKeychange.addEventListener('blur', ce);
	submitKeychange.addEventListener('focus', ce);

	var cancelKeychange = document.getElementById('cancelKeychange');
   	cancelKeychange.addEventListener('click', cancelKeyChange);
	cancelKeychange.addEventListener('blur', ce);
	cancelKeychange.addEventListener('focus', ce);

	var showNewKeyCheckbox = document.getElementById('showNewKey');
   	showNewKeyCheckbox.addEventListener('click', showNewKey);
	showNewKeyCheckbox.addEventListener('blur', ce);
	showNewKeyCheckbox.addEventListener('focus', ce);

	var gotointro2 = document.getElementById('gotointro2');
   	gotointro2.addEventListener('click', go2intro2);
	gotointro2.addEventListener('blur', ce);
	gotointro2.addEventListener('focus', ce);

	var backtointro1 = document.getElementById('backtointro1');
   	backtointro1.addEventListener('click', go2intro2);
	backtointro1.addEventListener('blur', ce);
	backtointro1.addEventListener('focus', ce);

	var mainBox = document.getElementById('mainBox');
   	mainBox.addEventListener('keyup', charsLeft);
	mainBox.addEventListener('keydown', ce);
	mainBox.addEventListener('blur', ce);
	mainBox.addEventListener('focus', ce);

//Firefox requires the keyup code to be inline if it refers to the event
//but this must be removed for the Chrome app and replaced with those commented below
	var pwdBox = document.getElementById('pwd');
//	pwdBox.addEventListener('keyup', function() {pwdKeyup(event)}, false);

	var pwdIntroBox = document.getElementById('pwdIntro');
   	pwdIntroBox.addEventListener('keyup', introKeyup);
	pwdIntroBox.addEventListener('blur', ce);
	pwdIntroBox.addEventListener('focus', ce);

	var decoyPwdIn = document.getElementById('decoyPwdIn');
//	decoyPwdIn.addEventListener('keyup', function() {decoyKeyup(event)}, false);
	decoyPwdIn.addEventListener('keydown', ce);
	decoyPwdIn.addEventListener('blur', ce);
	decoyPwdIn.addEventListener('focus', ce);

	var decoyPwdOut = document.getElementById('decoyPwdOut');
//	decoyPwdOut.addEventListener('keyup', function() {decoyKeyupOut(event)}, false);
	decoyPwdOut.addEventListener('keydown', ce);
	decoyPwdOut.addEventListener('blur', ce);
	decoyPwdOut.addEventListener('focus', ce);

	var partsIn = document.getElementById('partsIn');
//	partsIn.addEventListener('keyup', function() {partsKeyup(event)}, false);
	partsIn.addEventListener('keydown', ce);
	partsIn.addEventListener('blur', ce);
	partsIn.addEventListener('focus', ce);

	var newKeyBox = document.getElementById('newKey');
	newKeyBox.addEventListener('keyup', newKeyup);
	newKeyBox.addEventListener('keydown', ce);
	newKeyBox.addEventListener('blur', ce);
	newKeyBox.addEventListener('focus', ce);

	var newKey2Box = document.getElementById('newKey2');
//	newKey2Box.addEventListener('keyup', function() {newKey2up(event)}, false);
	newKey2Box.addEventListener('keydown', ce);
	newKey2Box.addEventListener('blur', ce);
	newKey2Box.addEventListener('focus', ce);

	var locknameBox = document.getElementById('locknameBox');
//	locknameBox.addEventListener('keyup', function() {locknameKeyup(event)}, false);
	locknameBox.addEventListener('keydown', ce);
	locknameBox.addEventListener('blur', ce);
	locknameBox.addEventListener('focus', ce);
	
	var emailBox = document.getElementById('email');
//	emailBox.addEventListener('keyup', function() {emailKeyup(event)}, false);
	emailBox.addEventListener('keydown', ce);
	emailBox.addEventListener('blur', ce);
	emailBox.addEventListener('focus', ce);

	var neverbox = document.getElementById('never');
	neverbox.addEventListener('click', hide5min);
	neverbox.addEventListener('blur', ce);
	neverbox.addEventListener('focus', ce);

//for the help screens
	document.getElementById('aa1').addEventListener('click', function() {openClose('a1')});
	document.getElementById('aa2').addEventListener('click', function() {openClose('a2')});
	document.getElementById('aa3').addEventListener('click', function() {openClose('a3')});
	document.getElementById('aa4').addEventListener('click', function() {openClose('a4')});
	document.getElementById('aa5').addEventListener('click', function() {openClose('a5')});
	document.getElementById('aa6').addEventListener('click', function() {openClose('a6')});
	document.getElementById('aa7').addEventListener('click', function() {openClose('a7')});
	document.getElementById('aa8').addEventListener('click', function() {openClose('a8')});
	document.getElementById('aa9').addEventListener('click', function() {openClose('a9')});
	document.getElementById('aa10').addEventListener('click', function() {openClose('a10')});
	document.getElementById('aa11').addEventListener('click', function() {openClose('a11')});
	document.getElementById('aa12').addEventListener('click', function() {openClose('a12')});
	document.getElementById('aa13').addEventListener('click', function() {openClose('a13')});
	document.getElementById('aa14').addEventListener('click', function() {openClose('a14')});
	document.getElementById('aa15').addEventListener('click', function() {openClose('a15')});
	document.getElementById('aa16').addEventListener('click', function() {openClose('a16')});
	document.getElementById('aa17').addEventListener('click', function() {openClose('a17')});
	document.getElementById('aa18').addEventListener('click', function() {openClose('a18')});
	document.getElementById('aa19').addEventListener('click', function() {openClose('a19')});
	document.getElementById('aa20').addEventListener('click', function() {openClose('a20')});
	document.getElementById('aa21').addEventListener('click', function() {openClose('a21')});
	document.getElementById('aa22').addEventListener('click', function() {openClose('a22')});
	document.getElementById('aa23').addEventListener('click', function() {openClose('a23')});
	document.getElementById('aa24').addEventListener('click', function() {openClose('a24')});
	document.getElementById('aa25').addEventListener('click', function() {openClose('a25')});
	document.getElementById('aa26').addEventListener('click', function() {openClose('a26')});
	document.getElementById('aa27').addEventListener('click', function() {openClose('a27')});
	document.getElementById('aa28').addEventListener('click', function() {openClose('a28')});
	document.getElementById('aa29').addEventListener('click', function() {openClose('a29')});
	document.getElementById('aa30').addEventListener('click', function() {openClose('a30')});
	document.getElementById('aa31').addEventListener('click', function() {openClose('a31')});
	document.getElementById('aa32').addEventListener('click', function() {openClose('a32')});
	document.getElementById('aa33').addEventListener('click', function() {openClose('a33')});
	document.getElementById('aa34').addEventListener('click', function() {openClose('a34')});
	document.getElementById('aa35').addEventListener('click', function() {openClose('a35')});
	document.getElementById('aa36').addEventListener('click', function() {openClose('a36')});
	document.getElementById('aa37').addEventListener('click', function() {openClose('a37')});
	document.getElementById('aa38').addEventListener('click', function() {openClose('a38')});
	document.getElementById('aa39').addEventListener('click', function() {openClose('a39')});
	document.getElementById('aa40').addEventListener('click', function() {openClose('a40')});
	document.getElementById('aa41').addEventListener('click', function() {openClose('a41')});
	document.getElementById('aa42').addEventListener('click', function() {openClose('a42')});
	document.getElementById('aa43').addEventListener('click', function() {openClose('a43')});
	document.getElementById('aa44').addEventListener('click', function() {openClose('a44')});
	document.getElementById('aa45').addEventListener('click', function() {openClose('a45')});
	document.getElementById('aa46').addEventListener('click', function() {openClose('a46')});
	document.getElementById('aa47').addEventListener('click', function() {openClose('a47')});
	document.getElementById('aa48').addEventListener('click', function() {openClose('a48')});
	document.getElementById('aa49').addEventListener('click', function() {openClose('a49')});
	document.getElementById('aa50').addEventListener('click', function() {openClose('a50')});
	document.getElementById('aa51').addEventListener('click', function() {openClose('a51')});
	document.getElementById('aa52').addEventListener('click', function() {openClose('a52')});

//a few help items don't have extra material, but are ready here just in case. Uncomment as needed

//	document.getElementById('bb1').addEventListener('click', function() {openClose('b1')});
//	document.getElementById('bb2').addEventListener('click', function() {openClose('b2')});
	document.getElementById('bb3').addEventListener('click', function() {openClose('b3')});
//	document.getElementById('bb4').addEventListener('click', function() {openClose('b4')});
	document.getElementById('bb5').addEventListener('click', function() {openClose('b5')});
	document.getElementById('bb6').addEventListener('click', function() {openClose('b6')});
	document.getElementById('bb7').addEventListener('click', function() {openClose('b7')});
	document.getElementById('bb8').addEventListener('click', function() {openClose('b8')});
	document.getElementById('bb9').addEventListener('click', function() {openClose('b9')});
	document.getElementById('bb10').addEventListener('click', function() {openClose('b10')});
	document.getElementById('bb11').addEventListener('click', function() {openClose('b11')});
	document.getElementById('bb12').addEventListener('click', function() {openClose('b12')});
	document.getElementById('bb13').addEventListener('click', function() {openClose('b13')});
	document.getElementById('bb14').addEventListener('click', function() {openClose('b14')});
	document.getElementById('bb15').addEventListener('click', function() {openClose('b15')});
	document.getElementById('bb16').addEventListener('click', function() {openClose('b16')});
	document.getElementById('bb17').addEventListener('click', function() {openClose('b17')});
	document.getElementById('bb18').addEventListener('click', function() {openClose('b18')});
	document.getElementById('bb19').addEventListener('click', function() {openClose('b19')});
	document.getElementById('bb20').addEventListener('click', function() {openClose('b20')});
	document.getElementById('bb21').addEventListener('click', function() {openClose('b21')});
	document.getElementById('bb22').addEventListener('click', function() {openClose('b22')});
	document.getElementById('bb23').addEventListener('click', function() {openClose('b23')});
	document.getElementById('bb24').addEventListener('click', function() {openClose('b24')});
	document.getElementById('bb25').addEventListener('click', function() {openClose('b25')});
	document.getElementById('bb26').addEventListener('click', function() {openClose('b26')});
//	document.getElementById('bb27').addEventListener('click', function() {openClose('b27')});
	document.getElementById('bb28').addEventListener('click', function() {openClose('b28')});
	document.getElementById('bb29').addEventListener('click', function() {openClose('b29')});
	document.getElementById('bb30').addEventListener('click', function() {openClose('b30')});
	document.getElementById('bb31').addEventListener('click', function() {openClose('b31')});
	document.getElementById('bb32').addEventListener('click', function() {openClose('b32')});
//	document.getElementById('bb33').addEventListener('click', function() {openClose('b33')});
	document.getElementById('bb34').addEventListener('click', function() {openClose('b34')});
	document.getElementById('bb35').addEventListener('click', function() {openClose('b35')});
	document.getElementById('bb36').addEventListener('click', function() {openClose('b36')});
	document.getElementById('bb37').addEventListener('click', function() {openClose('b37')});
//	document.getElementById('bb38').addEventListener('click', function() {openClose('b38')});
	document.getElementById('bb39').addEventListener('click', function() {openClose('b39')});
	document.getElementById('bb40').addEventListener('click', function() {openClose('b40')});
	document.getElementById('bb41').addEventListener('click', function() {openClose('b41')});
	document.getElementById('bb42').addEventListener('click', function() {openClose('b42')});
	document.getElementById('bb43').addEventListener('click', function() {openClose('b43')});
	document.getElementById('bb44').addEventListener('click', function() {openClose('b44')});
	document.getElementById('bb45').addEventListener('click', function() {openClose('b45')});
//	document.getElementById('bb46').addEventListener('click', function() {openClose('b46')});
//	document.getElementById('bb47').addEventListener('click', function() {openClose('b47')});
//	document.getElementById('bb48').addEventListener('click', function() {openClose('b48')});
//	document.getElementById('bb49').addEventListener('click', function() {openClose('b49')});
//	document.getElementById('bb50').addEventListener('click', function() {openClose('b50')});
//	document.getElementById('bb51').addEventListener('click', function() {openClose('b51')});
	document.getElementById('bb52').addEventListener('click', function() {openClose('b52')});

};

//this one is for iOS only. Remove for the Chrome app
window.addEventListener('load', function() {
    FastClick.attach(document.body);
}, false);

//for general directory
window.addEventListener('message', receiveMessage, false);

//gets Lock from the general directory iframe and puts it in Lock screen
function receiveMessage(evt){
  	if (evt.origin === 'https://passlok.com'){
    	document.getElementById('lockBox').value = evt.data;
		suspendFindLock = true;
		document.getElementById('lockmsg').innerHTML='Give a name to this Lock and save it. Otherwise Clear.'
  	}
}

//start with intro screen if "myself" entry in lockDB is empty. Otherwise start with Key input
	if(!lockDB['myself']){
		document.getElementById('videotutorial').src = "https://www.youtube.com/embed/UxgrES_CGcg";
		document.getElementById('introscr').style.display = "block";
		BasicButtons = true;
	} else {
		BasicButtons = (lockDB['myself'][2] != 'advanced');
		if(!BasicButtons){														//retrieve last interface
			openClose("basicbuttonstop");
			openClose("basicbuttonsbot");
			openClose("mainbuttonstop");
			openClose("mainbuttonsbot");
			openClose("basiclockbuttonstop");
			openClose("basiclockbuttonsbot");
			openClose("lockbuttonstop");
			openClose("lockbuttonsbot");
			document.getElementById('basicmode').checked = false;
			document.getElementById('advancedmode').checked = true;
		}
		if(lockDB['myself'][4] == 'ezLokOff'){
			document.getElementById('ezLok').checked = false
		} else {
			document.getElementById('ezLok').checked = true
		}
	}

//end of body script.
</script>

</body>
</html>